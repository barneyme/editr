<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>EDITR</title>

        <meta name="theme-color" content="#1a1a1a" />
        <link
            rel="icon"
            href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><rect width="16" height="16" fill="%23808080"/><text x="50%" y="55%" font-family="sans-serif" font-size="12" font-weight="bold" fill="white" text-anchor="middle" dominant-baseline="middle">e</text></svg>'
        />

        <style>
            @import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap");

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --bg-primary: #1a1a1a;
                --bg-secondary: #242424;
                --bg-hover: #2a2a2a;
                --text-primary: #e8e8e8;
                --text-secondary: #999;
                --border: #333;
                --accent: #4a9eff;
                --accent-dim: #3a7ec8;
                --tab-active: #2d2d2d;
            }

            body {
                font-family: "JetBrains Mono", monospace;
                background: var(--bg-primary);
                color: var(--text-primary);
                height: 100vh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            /* Header */
            header {
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border);
                padding: 10px 14px;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .logo {
                font-weight: 500;
                font-size: 14px;
                cursor: pointer;
                letter-spacing: 0.5px;
            }

            .logo:hover {
                color: var(--accent);
            }

            .actions {
                margin-left: auto;
                display: flex;
                gap: 6px;
            }

            .icon-btn {
                width: 34px;
                height: 34px;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 1px solid var(--border);
                border-radius: 4px;
                background: transparent;
                cursor: pointer;
                color: var(--text-primary);
            }

            .icon-btn:hover {
                background: var(--bg-hover);
                border-color: var(--accent-dim);
            }

            .icon-btn svg {
                width: 16px;
                height: 16px;
                stroke: currentColor;
                fill: none;
                stroke-width: 1.6;
            }

            /* Tabs */
            .tabs-wrapper {
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border);
                display: flex;
                position: relative;
            }

            .scroll-arrow {
                width: 32px;
                height: 100%;
                background: var(--bg-secondary);
                border: none;
                border-right: 1px solid var(--border);
                cursor: pointer;
                color: var(--text-primary);
                display: none;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                z-index: 10;
            }

            .scroll-arrow.right {
                border-right: none;
                border-left: 1px solid var(--border);
            }

            .scroll-arrow:hover {
                background: var(--bg-hover);
            }

            .scroll-arrow.visible {
                display: flex;
            }

            .scroll-arrow svg {
                width: 16px;
                height: 16px;
                stroke: currentColor;
                fill: none;
                stroke-width: 2;
            }

            .tabs-container {
                flex: 1;
                overflow: hidden;
                position: relative;
            }

            .tabs {
                display: flex;
                overflow-x: auto;
                scroll-behavior: smooth;
                scrollbar-width: none;
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tab {
                padding: 10px 16px;
                border-right: 1px solid var(--border);
                cursor: pointer;
                color: var(--text-secondary);
                display: flex;
                gap: 8px;
                align-items: center;
                white-space: nowrap;
            }

            .tab.active {
                background: var(--tab-active);
                color: var(--text-primary);
            }

            .tab-name {
                user-select: none;
            }

            .tab-close {
                opacity: 0;
                cursor: pointer;
            }

            .tab:hover .tab-close {
                opacity: 1;
            }

            /* Editor */
            .editor-container {
                flex: 1;
            }

            .editor {
                width: 100%;
                height: 100%;
                background: var(--bg-primary);
                border: none;
                color: var(--text-primary);
                padding: 32px;
                font-family: inherit;
                resize: none;
                outline: none;
            }

            /* Tools Terminal */
            .tools-container {
                width: 100%;
                height: 100%;
                background: var(--bg-primary);
                padding: 32px;
                display: none;
                flex-direction: column;
                gap: 8px;
            }

            .tools-container.active {
                display: flex;
            }

            .tools-output {
                flex: 1;
                overflow-y: auto;
                color: var(--text-primary);
                line-height: 1.6;
                white-space: pre-wrap;
                word-wrap: break-word;
                min-height: 0;
            }

            .tools-output .prompt {
                color: var(--accent);
            }

            .tools-output .error {
                color: #ff6b6b;
            }

            .tools-input-wrapper {
                display: flex;
                gap: 8px;
                align-items: center;
            }

            .tools-input-wrapper .prompt {
                color: var(--accent);
            }

            .tools-input {
                flex: 1;
                background: transparent;
                border: none;
                color: var(--text-primary);
                font-family: inherit;
                font-size: inherit;
                outline: none;
            }

            /* Status bar */
            .status-bar {
                background: var(--bg-secondary);
                border-top: 1px solid var(--border);
                padding: 6px 16px;
                display: flex;
                justify-content: space-between;
                font-size: 11px;
                color: var(--text-secondary);
            }

            /* Overlay */
            .overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.7);
                display: none;
                z-index: 999;
            }
            .overlay.visible {
                display: block;
            }

            /* Drag and drop overlay */
            .drop-overlay {
                position: fixed;
                inset: 0;
                background: rgba(74, 158, 255, 0.1);
                border: 3px dashed var(--accent);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 1001;
                pointer-events: none;
            }

            .drop-overlay.visible {
                display: flex;
            }

            .drop-overlay-text {
                font-size: 24px;
                color: var(--accent);
                font-weight: 500;
            }

            /* Secret modal */
            .secret-modal {
                position: fixed;
                top: 10%;
                left: 10%;
                width: 80%;
                height: 80%;
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 24px;
                display: none;
                flex-direction: column;
                gap: 12px;
                z-index: 1000;
            }

            .secret-modal input,
            .secret-modal textarea {
                background: var(--bg-primary);
                border: 1px solid var(--border);
                color: var(--text-primary);
                padding: 10px;
                font-family: inherit;
                border-radius: 4px;
            }

            .secret-modal textarea {
                flex: 1;
                resize: none;
            }

            .secret-modal label {
                font-weight: 500;
                font-size: 12px;
                margin-bottom: 4px;
                color: var(--text-secondary);
            }

            .secret-modal-buttons {
                display: flex;
                gap: 8px;
                justify-content: flex-end;
            }

            .secret-modal button {
                padding: 8px 16px;
                border: 1px solid var(--border);
                background: var(--bg-primary);
                color: var(--text-primary);
                cursor: pointer;
                border-radius: 4px;
                font-family: inherit;
            }

            .secret-modal button:hover {
                background: var(--bg-hover);
            }
        </style>
    </head>
    <body>
        <header>
            <div class="logo" onclick="openSecretNotes()">EDITR</div>
            <div class="actions">
                <button
                    id="newBtn"
                    class="icon-btn"
                    aria-label="New file"
                    title="New file (Ctrl+N)"
                >
                    <svg viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                    </svg>
                </button>
                <button
                    id="openBtn"
                    class="icon-btn"
                    aria-label="Open file"
                    title="Open file (Ctrl+O)"
                >
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                        />
                    </svg>
                </button>
                <button
                    id="saveBtn"
                    class="icon-btn"
                    aria-label="Save file"
                    title="Save file (Ctrl+S)"
                >
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"
                        />
                        <path d="M7 3v5h8" />
                        <rect x="7" y="13" width="10" height="8" />
                    </svg>
                </button>
                <button
                    id="saveAsBtn"
                    class="icon-btn"
                    aria-label="Save as"
                    title="Save As (Ctrl+Shift+S)"
                >
                    <svg viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="12" y1="18" x2="12" y2="12" />
                        <line x1="9" y1="15" x2="15" y2="15" />
                    </svg>
                </button>
                <button
                    id="renameBtn"
                    class="icon-btn"
                    aria-label="Rename file"
                    title="Rename file (Ctrl+R)"
                >
                    <svg viewBox="0 0 24 24">
                        <path d="M17 3a2.828 2.828 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z" />
                    </svg>
                </button>
                <button
                    id="toolsBtn"
                    class="icon-btn"
                    aria-label="Terminal"
                    title="Terminal (Ctrl+T)"
                >
                    <svg viewBox="0 0 24 24">
                        <polyline points="4 17 10 11 4 5" />
                        <line x1="12" y1="19" x2="20" y2="19" />
                    </svg>
                </button>
                <button
                    id="helpBtn"
                    class="icon-btn"
                    aria-label="Help"
                    title="Help (Ctrl+H)"
                >
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" />
                        <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3" />
                        <line x1="12" y1="17" x2="12.01" y2="17" />
                    </svg>
                </button>
            </div>
        </header>

        <div class="tabs-wrapper">
            <button class="scroll-arrow left" id="scrollLeft" aria-label="Scroll tabs left">
                <svg viewBox="0 0 24 24">
                    <polyline points="15 18 9 12 15 6" />
                </svg>
            </button>
            <div class="tabs-container">
                <div class="tabs" id="tabs"></div>
            </div>
            <button class="scroll-arrow right" id="scrollRight" aria-label="Scroll tabs right">
                <svg viewBox="0 0 24 24">
                    <polyline points="9 18 15 12 9 6" />
                </svg>
            </button>
        </div>

        <div class="editor-container">
            <textarea
                class="editor"
                id="editor"
                placeholder="Start typing..."
                spellcheck="false"
            ></textarea>
            
            <div class="tools-container" id="toolsContainer">
                <div class="tools-output" id="toolsOutput">TERMINAL v1.0
Available commands:
  bc [expression]       - Calculator (e.g., bc 1 + 1, bc 10 * 10)
  cal                   - Current month calendar
  cal [month]           - Specific month (e.g., cal 3)
  cal [year]            - Full year calendar (e.g., cal 2026)
  date                  - Current date in ISO format
  time                  - Current time in 24-hour format
  timer [minutes]       - Countdown timer (e.g., timer 5)
  uptime                - How long the page has been open
  whoami                - Browser and system info
  echo [text]           - Echo back text
  rand [min] [max]      - Random number (e.g., rand 1 100)
  coin                  - Flip a coin
  dice [sides]          - Roll dice (e.g., dice 6, default 6)
  clear                 - Clear output
  help                  - Show this help

Type a command and press Enter to run it.
</div>
                <div class="tools-input-wrapper">
                    <span class="prompt">$</span>
                    <input
                        type="text"
                        class="tools-input"
                        id="toolsInput"
                        placeholder="Enter command..."
                        autocomplete="off"
                    />
                </div>
            </div>
        </div>

        <div class="status-bar">
            <span id="statusLeft">Ready</span>
            <span id="statusRight">Ln 1, Col 1</span>
        </div>

        <!-- Hidden file input for Firefox fallback -->
        <input type="file" id="fileInput" accept=".txt" style="display: none;" />

        <!-- Drag and drop overlay -->
        <div class="drop-overlay" id="dropOverlay">
            <div class="drop-overlay-text">Drop .txt files here</div>
        </div>

        <div class="overlay" id="secretOverlay"></div>
        <div class="secret-modal" id="secretModal">
            <label>Password:</label>
            <input
                type="password"
                id="secretPassword"
                placeholder="Enter password"
            />
            <label>Protected Note:</label>
            <textarea
                id="secretEditor"
                placeholder="Type your protected note..."
            ></textarea>
            <div class="secret-modal-buttons">
                <button id="closeSecret">Close</button>
                <button id="saveSecret">Save</button>
            </div>
        </div>

        <script>
            let files = [];
            let active = -1;
            let activeTimers = [];
            const pageLoadTime = Date.now();
            let autoSaveInterval = null;

            const editor = document.getElementById("editor");
            const tabs = document.getElementById("tabs");
            const statusLeft = document.getElementById("statusLeft");
            const statusRight = document.getElementById("statusRight");
            const scrollLeft = document.getElementById("scrollLeft");
            const scrollRight = document.getElementById("scrollRight");

            const toolsContainer = document.getElementById("toolsContainer");
            const toolsOutput = document.getElementById("toolsOutput");
            const toolsInput = document.getElementById("toolsInput");
            const dropOverlay = document.getElementById("dropOverlay");

            /* ====================================================
   TOOLS FUNCTIONALITY
==================================================== */
            let isToolsActive = false;
            let commandHistory = [];

            document.getElementById("toolsBtn").onclick = openTools;

            function openTools() {
                // Check if Terminal.txt already exists
                const existingIndex = files.findIndex(f => f.name === "Terminal.txt");
                
                if (existingIndex !== -1) {
                    // Switch to existing terminal tab
                    switchFile(existingIndex);
                } else {
                    // Create new terminal tab
                    files.push({
                        name: "Terminal.txt",
                        content: "",
                        handle: null,
                        dirty: false,
                        isTools: true
                    });
                    active = files.length - 1;
                    render();
                    saveSession();
                }
            }

            toolsInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    const command = toolsInput.value.trim();
                    if (command) {
                        executeCommand(command);
                        commandHistory.push(command);
                        toolsInput.value = "";
                    }
                }
            });

            function executeCommand(cmd) {
                const output = document.createElement("div");
                output.innerHTML = `<span class="prompt">$ ${cmd}</span>\n`;
                
                const parts = cmd.split(" ");
                const command = parts[0];
                const args = parts.slice(1);

                try {
                    let result = "";
                    
                    switch(command) {
                        case "bc":
                            result = calculateExpression(args.join(" "));
                            break;
                        case "cal":
                            result = generateCalendar(args[0]);
                            break;
                        case "date":
                            result = new Date().toISOString().split('T')[0];
                            break;
                        case "time":
                            const now = new Date();
                            result = now.toTimeString().split(' ')[0];
                            break;
                        case "timer":
                            const minutes = parseInt(args[0]);
                            if (isNaN(minutes) || minutes <= 0) {
                                result = '<span class="error">Error: Please provide valid minutes (e.g., timer 5)</span>';
                            } else {
                                startTimer(minutes);
                                result = `Timer started for ${minutes} minute(s)`;
                            }
                            break;
                        case "uptime":
                            const uptimeMs = Date.now() - pageLoadTime;
                            const uptimeSeconds = Math.floor(uptimeMs / 1000);
                            const hours = Math.floor(uptimeSeconds / 3600);
                            const minutes2 = Math.floor((uptimeSeconds % 3600) / 60);
                            const seconds = uptimeSeconds % 60;
                            if (hours > 0) {
                                result = `up ${hours}h ${minutes2}m ${seconds}s`;
                            } else if (minutes2 > 0) {
                                result = `up ${minutes2}m ${seconds}s`;
                            } else {
                                result = `up ${seconds}s`;
                            }
                            break;
                        case "whoami":
                            result = `User Agent: ${navigator.userAgent}
Platform: ${navigator.platform}
Language: ${navigator.language}
Online: ${navigator.onLine ? 'Yes' : 'No'}
Screen: ${screen.width}x${screen.height}`;
                            break;
                        case "echo":
                            result = args.join(" ");
                            break;
                        case "rand":
                            const min = parseInt(args[0]) || 0;
                            const max = parseInt(args[1]) || 100;
                            if (min >= max) {
                                result = '<span class="error">Error: min must be less than max (e.g., rand 1 100)</span>';
                            } else {
                                result = Math.floor(Math.random() * (max - min + 1)) + min;
                            }
                            break;
                        case "coin":
                            result = Math.random() < 0.5 ? "Heads" : "Tails";
                            break;
                        case "dice":
                            const sides = parseInt(args[0]) || 6;
                            if (sides < 2) {
                                result = '<span class="error">Error: dice must have at least 2 sides</span>';
                            } else {
                                result = Math.floor(Math.random() * sides) + 1;
                            }
                            break;
                        case "clear":
                            toolsOutput.innerHTML = "";
                            return;
                        case "help":
                            result = `Available commands:
  bc [expression]       - Calculator (e.g., bc 1 + 1, bc 10 * 10)
  cal                   - Current month calendar
  cal [month]           - Specific month (e.g., cal 3)
  cal [year]            - Full year calendar (e.g., cal 2026)
  date                  - Current date in ISO format
  time                  - Current time in 24-hour format
  timer [minutes]       - Countdown timer (e.g., timer 5)
  uptime                - How long the page has been open
  whoami                - Browser and system info
  echo [text]           - Echo back text
  rand [min] [max]      - Random number (e.g., rand 1 100)
  coin                  - Flip a coin
  dice [sides]          - Roll dice (e.g., dice 6, default 6)
  clear                 - Clear output
  help                  - Show this help`;
                            break;
                        default:
                            result = `<span class="error">Error: Unknown command '${command}'. Type 'help' for available commands.</span>`;
                    }
                    
                    output.innerHTML += result + "\n";
                } catch (error) {
                    output.innerHTML += `<span class="error">Error: ${error.message}</span>\n`;
                }
                
                toolsOutput.appendChild(output);
                toolsOutput.scrollTop = toolsOutput.scrollHeight;
            }

            function calculateExpression(expr) {
                try {
                    // Basic calculator - supports +, -, *, /, %, ()
                    // Remove any non-math characters for safety
                    const sanitized = expr.replace(/[^0-9+\-*/.%() ]/g, '');
                    if (!sanitized) {
                        return '<span class="error">Error: Invalid expression</span>';
                    }
                    const result = eval(sanitized);
                    return result.toString();
                } catch (error) {
                    return `<span class="error">Error: Invalid expression</span>`;
                }
            }

            function generateCalendar(arg) {
                const now = new Date();
                let year = now.getFullYear();
                let month = now.getMonth();
                
                if (arg) {
                    const num = parseInt(arg);
                    if (num >= 1 && num <= 12) {
                        // Month specified
                        month = num - 1;
                    } else if (num >= 1000 && num <= 9999) {
                        // Year specified - show full year
                        return generateYearCalendar(num);
                    } else {
                        return '<span class="error">Error: Invalid month (1-12) or year</span>';
                    }
                }
                
                return generateMonthCalendar(year, month);
            }

            function generateMonthCalendar(year, month) {
                const monthNames = ["January", "February", "March", "April", "May", "June",
                                  "July", "August", "September", "October", "November", "December"];
                
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                let cal = `     ${monthNames[month]} ${year}\n`;
                cal += "Su Mo Tu We Th Fr Sa\n";
                
                let dayCount = 1;
                for (let week = 0; week < 6; week++) {
                    let weekLine = "";
                    for (let day = 0; day < 7; day++) {
                        if ((week === 0 && day < firstDay) || dayCount > daysInMonth) {
                            weekLine += "   ";
                        } else {
                            weekLine += dayCount.toString().padStart(2, " ") + " ";
                            dayCount++;
                        }
                    }
                    cal += weekLine.trim() + "\n";
                    if (dayCount > daysInMonth) break;
                }
                
                return cal;
            }

            function generateYearCalendar(year) {
                const monthNames = ["January", "February", "March", "April", "May", "June",
                                  "July", "August", "September", "October", "November", "December"];
                
                let cal = `                            ${year}\n\n`;
                
                for (let i = 0; i < 12; i += 3) {
                    // Print 3 months side by side
                    let monthHeaders = "";
                    let weekHeaders = "";
                    let monthLines = [[], [], [], [], [], []];
                    
                    for (let j = 0; j < 3; j++) {
                        const m = i + j;
                        if (m >= 12) break;
                        
                        const header = monthNames[m].padEnd(20, " ");
                        monthHeaders += header + "  ";
                        weekHeaders += "Su Mo Tu We Th Fr Sa  ";
                        
                        const firstDay = new Date(year, m, 1).getDay();
                        const daysInMonth = new Date(year, m + 1, 0).getDate();
                        
                        let dayCount = 1;
                        for (let week = 0; week < 6; week++) {
                            let weekLine = "";
                            for (let day = 0; day < 7; day++) {
                                if ((week === 0 && day < firstDay) || dayCount > daysInMonth) {
                                    weekLine += "   ";
                                } else {
                                    weekLine += dayCount.toString().padStart(2, " ") + " ";
                                    dayCount++;
                                }
                            }
                            monthLines[week].push(weekLine);
                        }
                    }
                    
                    cal += monthHeaders.trim() + "\n";
                    cal += weekHeaders.trim() + "\n";
                    
                    for (let week = 0; week < 6; week++) {
                        const line = monthLines[week].join("  ").trim();
                        if (line) cal += line + "\n";
                    }
                    cal += "\n";
                }
                
                return cal;
            }

            function startTimer(minutes) {
                const endTime = Date.now() + (minutes * 60 * 1000);
                const timerDiv = document.createElement("div");
                timerDiv.style.color = "var(--accent)";
                toolsOutput.appendChild(timerDiv);
                
                const timerId = setInterval(() => {
                    const remaining = endTime - Date.now();
                    
                    if (remaining <= 0) {
                        clearInterval(timerId);
                        timerDiv.textContent = "⏰ Timer finished!";
                        // Play a beep or notification if desired
                        return;
                    }
                    
                    const mins = Math.floor(remaining / 60000);
                    const secs = Math.floor((remaining % 60000) / 1000);
                    timerDiv.textContent = `Timer: ${mins}:${secs.toString().padStart(2, '0')} remaining`;
                }, 1000);
                
                activeTimers.push(timerId);
            }

            /* ====================================================
   FILE OPERATIONS
==================================================== */
            function render() {
                // Don't save editor content here - it's handled in switchFile
                // This is called when creating new files where active already points to the new file

                tabs.innerHTML = files
                    .map(
                        (f, i) => `
      <div class="tab ${i === active ? "active" : ""}" data-index="${i}">
        <span class="tab-name">${f.name}${f.dirty ? " •" : ""}</span>
        <span class="tab-close">×</span>
      </div>
    `,
                    )
                    .join("");

                if (active >= 0 && files[active]) {
                    const file = files[active];
                    
                    if (file.isTools) {
                        // Show tools container
                        editor.style.display = "none";
                        toolsContainer.classList.add("active");
                        toolsInput.focus();
                    } else {
                        // Show regular editor
                        editor.style.display = "block";
                        toolsContainer.classList.remove("active");
                        editor.value = file.content;
                        statusLeft.textContent = file.name;
                        editor.focus();
                    }
                } else {
                    editor.style.display = "block";
                    toolsContainer.classList.remove("active");
                    editor.value = "";
                    statusLeft.textContent = "No file open";
                }

                updateScrollButtons();
            }

            function updateScrollButtons() {
                const container = document.querySelector(".tabs");
                const canScrollLeft = container.scrollLeft > 0;
                const canScrollRight =
                    container.scrollLeft < container.scrollWidth - container.clientWidth;

                scrollLeft.classList.toggle("visible", canScrollLeft);
                scrollRight.classList.toggle("visible", canScrollRight);
            }

            scrollLeft.onclick = () => {
                document.querySelector(".tabs").scrollBy({ left: -200, behavior: "smooth" });
            };
            scrollRight.onclick = () => {
                document.querySelector(".tabs").scrollBy({ left: 200, behavior: "smooth" });
            };

            document.querySelector(".tabs").addEventListener("scroll", updateScrollButtons);

editor.oninput = () => {
    if (active >= 0) {
        // Update the file content FIRST
        files[active].content = editor.value; 
        files[active].dirty = true;
        render();
    }
};

            editor.onkeyup = editor.onclick = () => {
                const pos = editor.selectionStart;
                const lines = editor.value.substr(0, pos).split("\n");
                statusRight.textContent = `Ln ${lines.length}, Col ${lines[lines.length - 1].length + 1}`;
            };

            function newFile() {
                const name = prompt("New file name:", "Untitled.txt");
                if (!name) return;
                const fullName = name.endsWith(".txt") ? name : name + ".txt";
                files.push({ name: fullName, content: "", handle: null, dirty: false });
                active = files.length - 1;
                render();
                saveSession();
            }

            async function openFile() {
                // Check if File System Access API is available (Chrome, Edge)
                if (window.showOpenFilePicker) {
                    try {
                        const [handle] = await window.showOpenFilePicker({
                            types: [{ description: "Text", accept: { "text/plain": [".txt"] } }],
                        });
                        const file = await handle.getFile();
                        const content = await file.text();
                        files.push({
                            name: file.name,
                            content,
                            handle,
                            dirty: false,
                        });
                        active = files.length - 1;
                        render();
                        saveSession();
                    } catch (err) {
                        if (err.name !== "AbortError") alert("Failed to open file");
                    }
                } else {
                    // Fallback for Firefox and other browsers
                    const fileInput = document.getElementById("fileInput");
                    fileInput.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        try {
                            const content = await file.text();
                            files.push({
                                name: file.name,
                                content,
                                handle: null, // Firefox doesn't support file handles
                                dirty: false,
                            });
                            active = files.length - 1;
                            render();
                            saveSession();
                        } catch (err) {
                            alert("Failed to open file");
                        }
                        
                        // Reset the input
                        fileInput.value = "";
                    };
                    fileInput.click();
                }
            }

            async function saveFile() {
                if (active < 0) return;
                const file = files[active];
                
                if (file.isTools) {
                    alert("Terminal tab cannot be saved");
                    return;
                }

                if (!file.handle) {
                    await saveFileAs();
                    return;
                }

                // File System Access API (Chrome, Edge)
                try {
                    const writable = await file.handle.createWritable();
                    await writable.write(file.content);
                    await writable.close();
                    file.dirty = false;
                    render();
                } catch (err) {
                    alert("Failed to save file");
                }
            }

            async function saveFileAs() {
                if (active < 0) return;
                const file = files[active];
                
                if (file.isTools) {
                    alert("Terminal tab cannot be saved");
                    return;
                }

                // Check if File System Access API is available (Chrome, Edge)
                if (window.showSaveFilePicker) {
                    try {
                        const handle = await window.showSaveFilePicker({
                            suggestedName: file.name,
                            types: [{ description: "Text", accept: { "text/plain": [".txt"] } }],
                        });
                        const writable = await handle.createWritable();
                        await writable.write(file.content);
                        await writable.close();
                        file.handle = handle;
                        file.name = (await handle.getFile()).name;
                        file.dirty = false;
                        render();
                    } catch (err) {
                        if (err.name !== "AbortError") alert("Failed to save file");
                    }
                } else {
                    // Fallback for Firefox - download the file
                    try {
                        const blob = new Blob([file.content], { type: "text/plain" });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = file.name;
                        a.click();
                        URL.revokeObjectURL(url);
                        file.dirty = false;
                        render();
                    } catch (err) {
                        alert("Failed to save file");
                    }
                }
            }

            /* ====================================================
   HELP
==================================================== */
            function openHelp() {
                // Check if Help.txt already exists
                const existingIndex = files.findIndex(f => f.name === "Help.txt");
                
                if (existingIndex !== -1) {
                    // Switch to existing help tab
                    switchFile(existingIndex);
                } else {
                    const helpContent = `EDITR - Help & Documentation.

OVERVIEW:
EDITR is a simple, powerful text editor that runs entirely in your browser.

FEATURES:
• Multiple file tabs with tab management.
• Local file system integration (open/save files).
• Keyboard shortcuts for common actions.
• Auto-save indicators (• dot shows unsaved changes).
• Secure notes with encryption.

KEYBOARD SHORTCUTS:
New File       ⌘N / Ctrl+N
Open File      ⌘O / Ctrl+O
Save File      ⌘S / Ctrl+S
Save As        ⌘⇧S / Ctrl+Shift+S
Rename File    ⌘R / Ctrl+R
Protected Notes ⌘P / Ctrl+P
Terminal       ⌘T / Ctrl+T
Help           ⌘H / Ctrl+H

TAB MANAGEMENT:
• Click tab to switch between files.
• Double-click tab name or ⌘R / Ctrl+R to rename.
• Click × to close a tab.
• Use scroll arrows (◀ ▶) when tabs exceed screen width.

SECURE NOTES:
Click the lock icon to access password protected notes.
Your notes are encrypted and stored locally in your browser.

FILE OPERATIONS:
• New: Creates a new untitled file.
• Open: Opens .TXT files from your computer.
• Save: Saves current file (prompts for location if new).
• Save As: Saves file with a new name/location.

TERMINAL:
• bc [expression] - Calculator (e.g., bc 1 + 1)
• cal - Current month calendar
• cal [month] - Calendar for specific month
• cal [year] - Full year calendar
• date - Current date in ISO format
• time - Current time in 24-hour format
• timer [minutes] - Countdown timer
• uptime - How long page has been open
• whoami - Browser and system info
• echo [text] - Echo back text
• rand [min] [max] - Random number
• coin - Flip a coin
• dice [sides] - Roll dice
• clear - Clear terminal output
• help - Show available commands

TIPS:
• Files auto-save to browser storage every 10 seconds.
• Your tabs are remembered when you return to the page.
• Drag and drop .txt files to open them.
• The • dot next to filename indicates unsaved changes.
• Protected notes are encrypted with AES-GCM encryption.
• All data is stored locally - nothing is sent to servers.

ADVANCED EDITR:
www.editr.cc/editr.html

CREDITS:
Created by Barney Matthews:
www.barney.me.

---
Close this tab to return to editing.`;

                    files.push({
                        name: "Help.txt",
                        content: helpContent,
                        handle: null,
                        dirty: false,
                    });
                    active = files.length - 1;
                    render();
                    saveSession();
                }
            }

            document.getElementById("newBtn").onclick = newFile;
            document.getElementById("openBtn").onclick = openFile;
            document.getElementById("saveBtn").onclick = saveFile;
            document.getElementById("saveAsBtn").onclick = saveFileAs;
            document.getElementById("renameBtn").onclick = renameActiveFile;
            document.getElementById("helpBtn").onclick = openHelp;

            document.addEventListener("keydown", (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === "n") {
                    e.preventDefault();
                    newFile();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === "s") {
                    e.preventDefault();
                    if (e.shiftKey) {
                        saveFileAs();
                    } else {
                        saveFile();
                    }
                }
                if ((e.ctrlKey || e.metaKey) && e.key === "o") {
                    e.preventDefault();
                    openFile();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === "r") {
                    e.preventDefault();
                    renameActiveFile();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === "p") {
                    e.preventDefault();
                    openSecretNotes();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === "h") {
                    e.preventDefault();
                    openHelp();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === "t") {
                    e.preventDefault();
                    openTools();
                }
            });

            /* ====================================================
   TAB CLICK + DOUBLE-CLICK RENAME (FIXED)
==================================================== */
            let clickTimer = null;
            tabs.addEventListener("click", (e) => {
                const close = e.target.closest(".tab-close");
                if (close) {
                    closeFile(+close.parentElement.dataset.index);
                    return;
                }

                const tab = e.target.closest(".tab");
                if (tab) {
                    // Delay click to allow double-click to fire
                    clearTimeout(clickTimer);
                    clickTimer = setTimeout(() => {
                        switchFile(+tab.dataset.index);
                    }, 200);
                }
            });

            tabs.addEventListener("dblclick", (e) => {
                clearTimeout(clickTimer); // Cancel single click

                const nameEl = e.target.closest(".tab-name");
                if (!nameEl) return;

                e.preventDefault();
                e.stopPropagation();

                const tab = nameEl.closest(".tab");
                const index = +tab.dataset.index;
                const file = files[index];
                
                if (file.isTools) return; // Can't rename terminal tab

                const input = document.createElement("input");
                input.value = file.name;
                input.style.font = "inherit";
                input.style.width = "100%";
                input.style.background = "transparent";
                input.style.border = "1px solid var(--border)";
                input.style.color = "inherit";

                nameEl.replaceWith(input);
                input.focus();
                input.select();

                function commit() {
                    let val = input.value.trim();
                    if (!val) return render();
                    if (!val.endsWith(".txt")) val += ".txt";
                    file.name = val;
                    file.dirty = true;
                    render();
                }

                input.addEventListener("keydown", (ev) => {
                    if (ev.key === "Enter") commit();
                    if (ev.key === "Escape") render();
                });
                input.addEventListener("blur", commit);
            });

            function closeFile(i) {
                // Clear any active timers if closing terminal tab
                if (files[i].isTools) {
                    activeTimers.forEach(timerId => clearInterval(timerId));
                    activeTimers = [];
                }
                
                files.splice(i, 1);
                active = Math.min(active, files.length - 1);
                render();
                saveSession();
            }

            function switchFile(i) {
                if (active >= 0 && !files[active].isTools) {
                    files[active].content = editor.value;
                }
                active = i;
                render();
                saveSession();
            }

            function renameActiveFile() {
                if (active < 0) return;
                if (files[active].isTools) return; // Can't rename terminal tab

                setTimeout(() => {
                    const activeTab = document.querySelector(".tab.active");
                    if (!activeTab) return;

                    const nameEl = activeTab.querySelector(".tab-name");
                    if (!nameEl) return;

                    const file = files[active];

                    const input = document.createElement("input");
                    input.value = file.name;
                    input.style.font = "inherit";
                    input.style.width = "100%";
                    input.style.background = "transparent";
                    input.style.border = "1px solid var(--border)";
                    input.style.color = "inherit";

                    nameEl.replaceWith(input);
                    input.focus();
                    input.select();

                    function commit() {
                        let val = input.value.trim();
                        if (!val) return render();
                        if (!val.endsWith(".txt")) val += ".txt";
                        file.name = val;
                        file.dirty = true;
                        render();
                    }

                    input.addEventListener("keydown", (ev) => {
                        if (ev.key === "Enter") commit();
                        if (ev.key === "Escape") render();
                    });
                    input.addEventListener("blur", commit);
                }, 0);
            }

            /* ====================================================
   PROTECTED NOTES
==================================================== */
            const secretModal = document.getElementById("secretModal");
            const secretOverlay = document.getElementById("secretOverlay");
            const secretPassword = document.getElementById("secretPassword");
            const secretEditor = document.getElementById("secretEditor");

            function openSecretNotes() {
                secretPassword.value = "";
                secretEditor.value = "";
                secretModal.style.display = "flex";
                secretOverlay.classList.add("visible");
                secretPassword.focus();
            }

            closeSecret.onclick = () => {
                secretModal.style.display = "none";
                secretOverlay.classList.remove("visible");
            };
            secretOverlay.onclick = closeSecret.onclick;

            async function deriveKey(pw, salt) {
                const enc = new TextEncoder();
                const base = await crypto.subtle.importKey(
                    "raw",
                    enc.encode(pw),
                    "PBKDF2",
                    false,
                    ["deriveKey"],
                );
                return crypto.subtle.deriveKey(
                    {
                        name: "PBKDF2",
                        salt,
                        iterations: 100000,
                        hash: "SHA-256",
                    },
                    base,
                    { name: "AES-GCM", length: 256 },
                    false,
                    ["encrypt", "decrypt"],
                );
            }

            async function encrypt(text, pw) {
                const enc = new TextEncoder();
                const salt = crypto.getRandomValues(new Uint8Array(16));
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const key = await deriveKey(pw, salt);
                const data = await crypto.subtle.encrypt(
                    { name: "AES-GCM", iv },
                    key,
                    enc.encode(text),
                );
                return {
                    salt: [...salt],
                    iv: [...iv],
                    data: [...new Uint8Array(data)],
                };
            }

            async function decrypt(o, pw) {
                const key = await deriveKey(pw, new Uint8Array(o.salt));
                const p = await crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: new Uint8Array(o.iv) },
                    key,
                    new Uint8Array(o.data),
                );
                return new TextDecoder().decode(p);
            }

            secretPassword.onchange = async () => {
                const pw = secretPassword.value;
                const stored = localStorage.getItem("secret-" + pw);
                if (!stored) return;
                try {
                    secretEditor.value = await decrypt(JSON.parse(stored), pw);
                } catch {
                    alert("Wrong password");
                    secretEditor.value = "";
                }
            };

            saveSecret.onclick = async () => {
                if (!secretPassword.value) return alert("Password required");
                const enc = await encrypt(
                    secretEditor.value,
                    secretPassword.value,
                );
                localStorage.setItem(
                    "secret-" + secretPassword.value,
                    JSON.stringify(enc),
                );
                alert("Saved");
            };

            /* ====================================================
   DRAG AND DROP
==================================================== */
            let dragCounter = 0;

            document.addEventListener("dragenter", (e) => {
                e.preventDefault();
                dragCounter++;
                dropOverlay.classList.add("visible");
            });

            document.addEventListener("dragleave", (e) => {
                e.preventDefault();
                dragCounter--;
                if (dragCounter === 0) {
                    dropOverlay.classList.remove("visible");
                }
            });

            document.addEventListener("dragover", (e) => {
                e.preventDefault();
            });

            document.addEventListener("drop", async (e) => {
                e.preventDefault();
                dragCounter = 0;
                dropOverlay.classList.remove("visible");

                const files_dropped = Array.from(e.dataTransfer.files);
                
                for (const file of files_dropped) {
                    // Only accept .txt files
                    if (!file.name.endsWith(".txt")) {
                        alert(`Skipping ${file.name} - only .txt files are supported`);
                        continue;
                    }

                    try {
                        const content = await file.text();
                        files.push({
                            name: file.name,
                            content,
                            handle: null,
                            dirty: false,
                        });
                    } catch (err) {
                        alert(`Failed to read ${file.name}`);
                    }
                }

                if (files_dropped.length > 0) {
                    active = files.length - 1;
                    render();
                    saveSession();
                }
            });

            /* ====================================================
   AUTO-SAVE AND SESSION RESTORE
==================================================== */
            function saveSession() {
                // Save current editor content to active file
                if (active >= 0 && files[active] && !files[active].isTools) {
                    files[active].content = editor.value;
                }

                // Prepare data for storage (exclude file handles and isTools flag)
                const sessionData = {
                    files: files.map(f => ({
                        name: f.name,
                        content: f.content,
                        dirty: f.dirty,
                        isTools: f.isTools || false
                    })),
                    active: active
                };

                try {
                    localStorage.setItem("editr-session", JSON.stringify(sessionData));
                } catch (err) {
                    console.error("Failed to save session:", err);
                }
            }

            function restoreSession() {
                try {
                    const stored = localStorage.getItem("editr-session");
                    if (!stored) return false;

                    const sessionData = JSON.parse(stored);
                    
                    if (sessionData.files && sessionData.files.length > 0) {
                        files = sessionData.files.map(f => ({
                            name: f.name,
                            content: f.content,
                            handle: null,
                            dirty: f.dirty || false,
                            isTools: f.isTools || false
                        }));
                        active = sessionData.active >= 0 ? sessionData.active : 0;
                        render();
                        return true;
                    }
                } catch (err) {
                    console.error("Failed to restore session:", err);
                }
                return false;
            }

            // Auto-save every 10 seconds
            autoSaveInterval = setInterval(() => {
                if (files.length > 0) {
                    saveSession();
                }
            }, 10000);

            // Save session when editor content changes
            editor.addEventListener("input", () => {
                // Debounced save will happen every 10 seconds via interval
                if (active >= 0 && files[active]) {
                    files[active].dirty = true;
                }
            });

            // Save session before page unload
            window.addEventListener("beforeunload", () => {
                saveSession();
            });

            /* ====================================================
   INITIALIZATION
==================================================== */
            // Try to restore previous session, otherwise start fresh
            if (!restoreSession()) {
                render();
            }
        </script>
    </body>
</html>
