<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>EDITR</title>

        <meta name="theme-color" content="#1a1a1a" />
        <link
            rel="icon"
            href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><rect width="16" height="16" fill="%23808080"/><text x="50%" y="55%" font-family="sans-serif" font-size="12" font-weight="bold" fill="white" text-anchor="middle" dominant-baseline="middle">e</text></svg>'
        />

        <style>
            @import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap");

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --bg-primary: #1a1a1a;
                --bg-secondary: #242424;
                --bg-hover: #2a2a2a;
                --text-primary: #e8e8e8;
                --text-secondary: #999;
                --border: #333;
                --accent: #4a9eff;
                --accent-dim: #3a7ec8;
                --tab-active: #2d2d2d;
            }

            body {
                font-family: "JetBrains Mono", monospace;
                background: var(--bg-primary);
                color: var(--text-primary);
                height: 100vh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            /* Header */
            header {
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border);
                padding: 10px 14px;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .logo {
                font-weight: 500;
                font-size: 14px;
                cursor: pointer;
                letter-spacing: 0.5px;
            }

            .actions {
                margin-left: auto;
                display: flex;
                gap: 6px;
            }

            .icon-btn {
                width: 34px;
                height: 34px;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 1px solid var(--border);
                border-radius: 4px;
                background: transparent;
                cursor: pointer;
                color: var(--text-primary);
            }

            .icon-btn:hover {
                background: var(--bg-hover);
                border-color: var(--accent-dim);
            }

            .icon-btn svg {
                width: 16px;
                height: 16px;
                stroke: currentColor;
                fill: none;
                stroke-width: 1.6;
            }

            /* Tabs */
            .tabs-wrapper {
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border);
                display: flex;
            }

            .tabs {
                display: flex;
                overflow-x: auto;
                flex: 1;
            }

            .tab {
                padding: 10px 16px;
                border-right: 1px solid var(--border);
                cursor: pointer;
                color: var(--text-secondary);
                display: flex;
                gap: 8px;
                align-items: center;
                white-space: nowrap;
            }

            .tab.active {
                background: var(--tab-active);
                color: var(--text-primary);
            }

            .tab-name {
                user-select: none;
            }

            .tab-close {
                opacity: 0;
                cursor: pointer;
            }

            .tab:hover .tab-close {
                opacity: 1;
            }

            /* Editor */
            .editor-container {
                flex: 1;
            }

            .editor {
                width: 100%;
                height: 100%;
                background: var(--bg-primary);
                border: none;
                color: var(--text-primary);
                padding: 32px;
                font-family: inherit;
                resize: none;
                outline: none;
            }

            /* Status bar */
            .status-bar {
                background: var(--bg-secondary);
                border-top: 1px solid var(--border);
                padding: 6px 16px;
                display: flex;
                justify-content: space-between;
                font-size: 11px;
                color: var(--text-secondary);
            }

            /* Overlay */
            .overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.7);
                display: none;
                z-index: 999;
            }
            .overlay.visible {
                display: block;
            }

            /* Secret modal */
            .secret-modal {
                position: fixed;
                top: 10%;
                left: 10%;
                width: 80%;
                height: 80%;
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 24px;
                display: none;
                flex-direction: column;
                gap: 12px;
                z-index: 1000;
            }

            .secret-modal input,
            .secret-modal textarea {
                background: var(--bg-primary);
                border: 1px solid var(--border);
                color: var(--text-primary);
                font-family: inherit;
                padding: 8px;
            }

            .secret-modal textarea {
                flex: 1;
                resize: none;
            }

            .secret-actions {
                display: flex;
                justify-content: flex-end;
                gap: 8px;
            }
        </style>
    </head>

    <body>
        <header>
            <div class="logo" id="secretNotesBtn">EDITR</div>

            <div class="actions">
                <button class="icon-btn" id="newBtn" title="New (⌘N / Ctrl+N)">
                    <svg viewBox="0 0 16 16">
                        <line x1="8" y1="3" x2="8" y2="13" />
                        <line x1="3" y1="8" x2="13" y2="8" />
                    </svg>
                </button>

                <button
                    class="icon-btn"
                    id="openBtn"
                    title="Open (⌘O / Ctrl+O)"
                >
                    <svg viewBox="0 0 16 16">
                        <path d="M2 4.5h4l2 2h6v7H2z" />
                    </svg>
                </button>

                <button
                    class="icon-btn"
                    id="saveBtn"
                    title="Save (⌘S / Ctrl+S)"
                >
                    <svg viewBox="0 0 16 16">
                        <path d="M3 2h10v12H3z" />
                        <polyline points="5,2 5,6 11,6 11,2" />
                    </svg>
                </button>

                <button
                    class="icon-btn"
                    id="saveAsBtn"
                    title="Save As (⌘⇧S / Ctrl+Shift+S)"
                >
                    <svg viewBox="0 0 16 16">
                        <path d="M3 2h7l3 3v9H3z" />
                        <line x1="8" y1="7" x2="8" y2="12" />
                        <line x1="6" y1="10" x2="10" y2="10" />
                    </svg>
                </button>
            </div>
        </header>

        <div class="tabs-wrapper">
            <div class="tabs" id="tabs"></div>
        </div>

        <div class="editor-container">
            <textarea
                id="editor"
                class="editor"
                placeholder="Start typing..."
            ></textarea>
        </div>

        <div class="status-bar">
            <span id="fileStatus">No file</span>
            <span id="charCount">0 characters</span>
        </div>

        <!-- Secret Notes -->
        <div class="overlay" id="secretOverlay"></div>

        <div class="secret-modal" id="secretModal">
            <h2>Protected Note</h2>
            <input type="password" id="secretPassword" placeholder="Password" />
            <textarea
                id="secretEditor"
                placeholder="Encrypted note..."
            ></textarea>
            <div class="secret-actions">
                <button id="closeSecret">Close</button>
                <button id="saveSecret">Save</button>
            </div>
        </div>

        <script>
            /* ====================================================
   PLATFORM SHORTCUTS
==================================================== */
            const isMac = navigator.platform.toUpperCase().includes("MAC");
            const modKey = isMac ? "metaKey" : "ctrlKey";

            document.addEventListener("keydown", (e) => {
                if (!e[modKey]) return;
                if (e.key === "n") {
                    e.preventDefault();
                    newFile();
                }
                if (e.key === "o") {
                    e.preventDefault();
                    openFile();
                }
                if (e.key === "s" && !e.shiftKey) {
                    e.preventDefault();
                    saveFile();
                }
                if (e.key === "s" && e.shiftKey) {
                    e.preventDefault();
                    saveFileAs();
                }
            });

            /* ====================================================
   FILE SYSTEM EDITOR
==================================================== */
            let files = [],
                active = -1;
            const editor = document.getElementById("editor");
            const tabs = document.getElementById("tabs");
            const fileStatus = document.getElementById("fileStatus");
            const charCount = document.getElementById("charCount");

            function render() {
                tabs.innerHTML = files
                    .map(
                        (f, i) => `
<div class="tab ${i === active ? "active" : ""}" data-index="${i}">
<span class="tab-name">${f.name}${f.dirty ? " •" : ""}</span>
<span class="tab-close">×</span>
</div>`,
                    )
                    .join("");

                if (active >= 0) {
                    editor.value = files[active].content;
                    fileStatus.textContent = files[active].name;
                } else {
                    editor.value = "";
                    fileStatus.textContent = "No file";
                }
                charCount.textContent = editor.value.length + " characters";
            }

            function newFile() {
                files.push({
                    name: `New-${files.length + 1}.txt`,
                    content: "",
                    handle: null,
                    dirty: false,
                });
                active = files.length - 1;
                render();
            }

            async function openFile() {
                const [handle] = await showOpenFilePicker({
                    types: [{ accept: { "text/plain": [".txt"] } }],
                });
                const file = await handle.getFile();
                files.push({
                    name: file.name,
                    content: await file.text(),
                    handle,
                    dirty: false,
                });
                active = files.length - 1;
                render();
            }

            async function saveFile() {
                if (active < 0) return;
                const f = files[active];
                f.content = editor.value;
                if (!f.handle) return saveFileAs();
                const w = await f.handle.createWritable();
                await w.write(f.content);
                await w.close();
                f.dirty = false;
                render();
            }

            async function saveFileAs() {
                if (active < 0) return;
                const f = files[active];
                f.content = editor.value;
                const handle = await showSaveFilePicker({
                    suggestedName: f.name,
                });
                const w = await handle.createWritable();
                await w.write(f.content);
                await w.close();
                f.handle = handle;
                f.name = handle.name;
                f.dirty = false;
                render();
            }

            editor.oninput = () => {
                if (active >= 0) {
                    files[active].content = editor.value;
                    files[active].dirty = true;
                }
                charCount.textContent = editor.value.length + " characters";
            };

            newBtn.onclick = newFile;
            openBtn.onclick = openFile;
            saveBtn.onclick = saveFile;
            saveAsBtn.onclick = saveFileAs;

            /* ====================================================
   TAB CLICK + DOUBLE-CLICK RENAME (FIXED)
==================================================== */
            tabs.addEventListener("click", (e) => {
                if (e.target.classList.contains("tab-name")) return;

                const close = e.target.closest(".tab-close");
                if (close) {
                    closeFile(+close.parentElement.dataset.index);
                    return;
                }

                const tab = e.target.closest(".tab");
                if (tab) switchFile(+tab.dataset.index);
            });

            tabs.addEventListener("dblclick", (e) => {
                const nameEl = e.target.closest(".tab-name");
                if (!nameEl) return;

                e.preventDefault();
                e.stopPropagation();

                const tab = nameEl.closest(".tab");
                const index = +tab.dataset.index;
                const file = files[index];

                const input = document.createElement("input");
                input.value = file.name;
                input.style.font = "inherit";
                input.style.width = "100%";
                input.style.background = "transparent";
                input.style.border = "1px solid var(--border)";
                input.style.color = "inherit";

                nameEl.replaceWith(input);
                input.focus();
                input.select();

                function commit() {
                    let val = input.value.trim();
                    if (!val) return render();
                    if (!val.endsWith(".txt")) val += ".txt";
                    file.name = val;
                    file.dirty = true;
                    render();
                }

                input.addEventListener("keydown", (ev) => {
                    if (ev.key === "Enter") commit();
                    if (ev.key === "Escape") render();
                });
                input.addEventListener("blur", commit);
            });

            function closeFile(i) {
                files.splice(i, 1);
                active = Math.min(active, files.length - 1);
                render();
            }

            function switchFile(i) {
                if (active >= 0) files[active].content = editor.value;
                active = i;
                render();
            }

            /* ====================================================
   PROTECTED NOTES
==================================================== */
            const secretBtn = document.getElementById("secretNotesBtn");
            const secretModal = document.getElementById("secretModal");
            const secretOverlay = document.getElementById("secretOverlay");
            const secretPassword = document.getElementById("secretPassword");
            const secretEditor = document.getElementById("secretEditor");

            secretBtn.onclick = () => {
                secretPassword.value = "";
                secretEditor.value = "";
                secretModal.style.display = "flex";
                secretOverlay.classList.add("visible");
                secretPassword.focus();
            };

            closeSecret.onclick = () => {
                secretModal.style.display = "none";
                secretOverlay.classList.remove("visible");
            };
            secretOverlay.onclick = closeSecret.onclick;

            async function deriveKey(pw, salt) {
                const enc = new TextEncoder();
                const base = await crypto.subtle.importKey(
                    "raw",
                    enc.encode(pw),
                    "PBKDF2",
                    false,
                    ["deriveKey"],
                );
                return crypto.subtle.deriveKey(
                    {
                        name: "PBKDF2",
                        salt,
                        iterations: 100000,
                        hash: "SHA-256",
                    },
                    base,
                    { name: "AES-GCM", length: 256 },
                    false,
                    ["encrypt", "decrypt"],
                );
            }

            async function encrypt(text, pw) {
                const enc = new TextEncoder();
                const salt = crypto.getRandomValues(new Uint8Array(16));
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const key = await deriveKey(pw, salt);
                const data = await crypto.subtle.encrypt(
                    { name: "AES-GCM", iv },
                    key,
                    enc.encode(text),
                );
                return {
                    salt: [...salt],
                    iv: [...iv],
                    data: [...new Uint8Array(data)],
                };
            }

            async function decrypt(o, pw) {
                const key = await deriveKey(pw, new Uint8Array(o.salt));
                const p = await crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: new Uint8Array(o.iv) },
                    key,
                    new Uint8Array(o.data),
                );
                return new TextDecoder().decode(p);
            }

            secretPassword.onchange = async () => {
                const pw = secretPassword.value;
                const stored = localStorage.getItem("secret-" + pw);
                if (!stored) return;
                try {
                    secretEditor.value = await decrypt(JSON.parse(stored), pw);
                } catch {
                    alert("Wrong password");
                    secretEditor.value = "";
                }
            };

            saveSecret.onclick = async () => {
                if (!secretPassword.value) return alert("Password required");
                const enc = await encrypt(
                    secretEditor.value,
                    secretPassword.value,
                );
                localStorage.setItem(
                    "secret-" + secretPassword.value,
                    JSON.stringify(enc),
                );
                alert("Saved");
            };
        </script>
    </body>
</html>
