<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>bEdit</title>
        <link
            rel="icon"
            href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'><rect width='16' height='16' fill='%23666666'/><text x='8' y='12' font-family='monospace' font-size='12' fill='white' text-anchor='middle'>b</text></svg>"
        />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Courier New", monospace;
                background: #f8f8f8;
                height: 100vh;
                position: relative;
                transition: background 0.3s ease;
            }

            body.dark-mode {
                background: #1a1a1a;
            }

            #editor {
                width: 100%;
                height: 100vh;
                border: none;
                outline: none;
                padding: 20px;
                font-family: "Courier New", monospace;
                font-size: 14px;
                line-height: 1.5;
                background: white;
                color: #333;
                resize: none;
                white-space: pre-wrap;
                word-wrap: break-word;
                transition:
                    background 0.3s ease,
                    color 0.3s ease,
                    border 0.2s ease;
            }

            #editor.drag-over {
                border: 3px dashed #007acc;
                background: rgba(0, 122, 204, 0.1);
            }

            body.dark-mode #editor {
                background: #2d2d2d;
                color: #e0e0e0;
            }

            body.dark-mode #editor.drag-over {
                border: 3px dashed #4a9eff;
                background: rgba(74, 158, 255, 0.1);
            }

            #bufferBar {
                display: none;
            }

            #shortcuts {
                position: fixed;
                top: 10px;
                right: 10px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px;
                border-radius: 4px;
                font-size: 12px;
                opacity: 0;
                transition: opacity 0.3s;
                pointer-events: none;
                z-index: 1000;
            }

            #shortcuts.show {
                opacity: 1;
            }

            #hoverHint {
                position: fixed;
                top: 15px;
                right: 15px;
                width: 8px;
                height: 8px;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 50%;
                transition: opacity 0.3s;
                pointer-events: none;
                z-index: 999;
            }

            body.dark-mode #hoverHint {
                background: rgba(255, 255, 255, 0.3);
            }

            #hoverHint.hide {
                opacity: 0;
            }

            #fileInput {
                display: none;
            }

            #mobileControls {
                position: fixed;
                top: 10px;
                right: 10px;
                display: none;
                gap: 8px;
                z-index: 1000;
            }

            .mobile-btn {
                width: 40px;
                height: 40px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                transition: background 0.2s;
            }

            .mobile-btn:hover {
                background: rgba(0, 0, 0, 0.9);
            }

            .mobile-btn:active {
                transform: scale(0.95);
            }

            @media (max-width: 768px) {
                #mobileControls {
                    display: flex;
                }

                #shortcuts {
                    display: none;
                }

                #editor {
                    height: 100vh;
                }
            }
        </style>
    </head>
    <body>
        <textarea id="editor" placeholder="..."></textarea>

        <div id="hoverHint"></div>

        <div id="shortcuts">
            <div>..................................</div>
            <div>bEdit : browser Editor</div>
            <div>..................................</div>
            <div id="currentBuffer">Buffer: 1/1 - bedit.txt</div>
            <div id="wordCount">Words: 0 | Lines: 0</div>
            <div>..................................</div>
            <div>HELP</div>
            <div>Ctrl/Cmd + N : New tab</div>
            <div>bedit.org/abc : New note 'abc'</div>
            <div>Ctrl/Cmd + O : Open file</div>
            <div>Drag and drop to open file</div>
            <div>Opening file adds it to new buffer</div>
            <div>Ctrl/Cmd + 1~9 : Switch buffers</div>
            <div>Ctrl/Cmd + ‚Üê/‚Üí : Switch buffers</div>
            <div>Ctrl/Cmd + S : Save file</div>
            <div>Files auto save in browser</div>
            <div>Ctrl/Cmd + W : Close buffer</div>
            <div>Ctrl/Cmd + D : Dark/light mode</div>
            <div>F11 : Full screen</div>
            <div>..................................</div>
            <div>Made by [Barney](www.barney.me)</div>
            <div>..................................</div>
        </div>

        <div id="mobileControls">
            <button class="mobile-btn" id="openBtn" title="Open file">
                üìÅ
            </button>
            <button class="mobile-btn" id="saveBtn" title="Save file">
                üíæ
            </button>
        </div>

        <input type="file" id="fileInput" accept=".txt,.md,.js,.html,.css" />

        <script>
            // Wait for DOM to be fully loaded
            document.addEventListener("DOMContentLoaded", function () {
                // Get DOM elements
                const editor = document.getElementById("editor");
                const shortcuts = document.getElementById("shortcuts");
                const fileInput = document.getElementById("fileInput");
                const openBtn = document.getElementById("openBtn");
                const saveBtn = document.getElementById("saveBtn");
                const wordCount = document.getElementById("wordCount");
                const currentBuffer = document.getElementById("currentBuffer");
                const hoverHint = document.getElementById("hoverHint");

                let showTimeout;
                let tabId = generateTabId();

                // Buffer management
                let buffers = [];
                let activeBufferIndex = 0;

                // Generate unique tab ID
                function generateTabId() {
                    const path = window.location.pathname;
                    const pathSegments = path
                        .split("/")
                        .filter((segment) => segment !== "");
                    const tabFromPath = pathSegments[pathSegments.length - 1];
                    if (tabFromPath && tabFromPath !== "index.html") {
                        return tabFromPath;
                    }
                    return Math.random().toString(36).substr(2, 6);
                }

                // Helper function to get filename without extension for URL
                function getFileNameForUrl(fileName) {
                    // Remove extension and sanitize for URL
                    const nameWithoutExt = fileName.replace(/\.[^/.]+$/, "");
                    return nameWithoutExt
                        .toLowerCase()
                        .replace(/[^a-z0-9]/g, "");
                }

                // Update URL based on current buffer
                function updateUrlForCurrentBuffer() {
                    const buffer = buffers[activeBufferIndex];
                    if (!buffer) return;

                    let urlPath;
                    if (buffer.name === "bedit.txt") {
                        // For default buffer, use random ID
                        urlPath = `/${tabId}`;
                    } else {
                        // For opened files, use filename
                        const urlName = getFileNameForUrl(buffer.name);
                        urlPath = `/${urlName}`;
                    }

                    // Only update if the path is different
                    if (window.location.pathname !== urlPath) {
                        window.history.replaceState({}, "", urlPath);
                    }
                }

                // Buffer class
                class FileBuffer {
                    constructor(
                        name = "bedit.txt",
                        content = "",
                        fileHandle = null,
                    ) {
                        this.name = name;
                        this.content = content;
                        this.originalContent = content;
                        this.fileHandle = fileHandle;
                        this.id = Math.random().toString(36).substr(2, 9);
                    }

                    get isModified() {
                        return this.content !== this.originalContent;
                    }

                    markSaved() {
                        this.originalContent = this.content;
                    }
                }

                // Initialize with first buffer
                function initializeBuffers() {
                    const savedContent =
                        localStorage.getItem(`bedit_${tabId}_editorContent`) ||
                        "";
                    buffers = [new FileBuffer("bedit.txt", savedContent)];
                    buffers[0].originalContent = savedContent;
                    activeBufferIndex = 0;
                    updateBufferBar();
                    loadActiveBuffer();
                    updateUrlForCurrentBuffer();
                }

                // Storage key helper
                function getStorageKey(key) {
                    return `bedit_${tabId}_${key}`;
                }

                // Buffer management functions
                function createNewBuffer(
                    name = "bedit.txt",
                    content = "",
                    fileHandle = null,
                ) {
                    const buffer = new FileBuffer(name, content, fileHandle);
                    buffers.push(buffer);
                    activeBufferIndex = buffers.length - 1;
                    updateBufferBar();
                    loadActiveBuffer();
                    updateUrlForCurrentBuffer(); // Update URL when new buffer is created
                    return buffer;
                }

                function switchToBuffer(index) {
                    if (index < 0 || index >= buffers.length) return;

                    // Save current buffer content
                    if (buffers[activeBufferIndex]) {
                        buffers[activeBufferIndex].content = editor.value;
                    }

                    activeBufferIndex = index;
                    loadActiveBuffer();
                    updateBufferBar();
                    updateUrlForCurrentBuffer(); // Update URL when switching buffers
                }

                function closeBuffer(index) {
                    if (buffers.length === 1) return; // Don't close the last buffer

                    const buffer = buffers[index];
                    if (buffer.isModified) {
                        if (
                            !confirm(
                                `"${buffer.name}" has unsaved changes. Close anyway?`,
                            )
                        ) {
                            return;
                        }
                    }

                    buffers.splice(index, 1);

                    // Adjust active buffer index
                    if (activeBufferIndex >= index && activeBufferIndex > 0) {
                        activeBufferIndex--;
                    } else if (activeBufferIndex >= buffers.length) {
                        activeBufferIndex = buffers.length - 1;
                    }

                    updateBufferBar();
                    loadActiveBuffer();
                    updateUrlForCurrentBuffer(); // Update URL when buffer is closed
                }

                function loadActiveBuffer() {
                    const buffer = buffers[activeBufferIndex];
                    if (buffer) {
                        editor.value = buffer.content;
                        updateWordCount();
                        editor.focus();
                    }
                }

                function updateBufferBar() {
                    // Update current buffer indicator in shortcuts
                    if (currentBuffer) {
                        const buffer = buffers[activeBufferIndex];
                        const modifiedText =
                            buffer && buffer.isModified ? " (modified)" : "";
                        currentBuffer.textContent = `Buffer: ${activeBufferIndex + 1}/${buffers.length} - ${buffer ? buffer.name : "unknown"}${modifiedText}`;
                    }
                }

                // Dark mode functions
                function loadDarkMode() {
                    const isDarkMode =
                        localStorage.getItem("darkMode") === "true";
                    if (isDarkMode) {
                        document.body.classList.add("dark-mode");
                    }
                }

                function toggleDarkMode() {
                    document.body.classList.toggle("dark-mode");
                    const isDarkMode =
                        document.body.classList.contains("dark-mode");
                    localStorage.setItem("darkMode", isDarkMode);
                }

                // Update word count
                function updateWordCount() {
                    const text = editor.value;
                    const words =
                        text.trim() === ""
                            ? 0
                            : text.trim().split(/\s+/).length;
                    const lines = text === "" ? 0 : text.split("\n").length;
                    wordCount.textContent = `Words: ${words} | Lines: ${lines}`;
                }

                // Update URL with tab ID (now handles both random and file-based URLs)
                function updateUrlWithTabId() {
                    const currentPath = window.location.pathname;
                    const pathSegments = currentPath
                        .split("/")
                        .filter((segment) => segment !== "");
                    const lastSegment = pathSegments[pathSegments.length - 1];

                    // If no specific path or it's index.html, generate random URL
                    if (
                        !lastSegment ||
                        lastSegment === "index.html" ||
                        lastSegment.includes(".")
                    ) {
                        const basePath = pathSegments
                            .filter((segment) => !segment.includes("."))
                            .join("/");
                        const newPath = basePath
                            ? `/${basePath}/${tabId}`
                            : `/${tabId}`;
                        window.history.replaceState({}, "", newPath);
                    }
                }

                // Save file function
                async function saveFile() {
                    const buffer = buffers[activeBufferIndex];
                    if (!buffer) return;

                    const content = editor.value;
                    buffer.content = content;

                    // Check if File System Access API is supported and we have a file handle
                    if ("showSaveFilePicker" in window && buffer.fileHandle) {
                        try {
                            // Save directly to the existing file
                            const writable =
                                await buffer.fileHandle.createWritable();
                            await writable.write(content);
                            await writable.close();

                            buffer.markSaved();
                            updateBufferBar();
                            showSaveIndicator("Saved!");
                            return;
                        } catch (err) {
                            console.log(
                                "Direct save failed, falling back to download:",
                                err,
                            );
                        }
                    }

                    // Check if File System Access API is supported for new files
                    if ("showSaveFilePicker" in window && !buffer.fileHandle) {
                        try {
                            const options = {
                                suggestedName: buffer.name,
                                types: [
                                    {
                                        description: "Text files",
                                        accept: {
                                            "text/plain": [".txt"],
                                            "text/markdown": [".md"],
                                            "text/javascript": [".js"],
                                            "text/html": [".html"],
                                            "text/css": [".css"],
                                            "application/json": [".json"],
                                        },
                                    },
                                ],
                            };

                            buffer.fileHandle =
                                await window.showSaveFilePicker(options);
                            const writable =
                                await buffer.fileHandle.createWritable();
                            await writable.write(content);
                            await writable.close();

                            // Update buffer name to match saved file
                            buffer.name = buffer.fileHandle.name;
                            buffer.markSaved();
                            updateBufferBar();
                            updateUrlForCurrentBuffer(); // Update URL when file is saved with new name
                            showSaveIndicator("Saved!");
                            return;
                        } catch (err) {
                            if (err.name !== "AbortError") {
                                console.log(
                                    "Save picker failed, falling back to download:",
                                    err,
                                );
                            }
                        }
                    }

                    // Fallback: download method for unsupported browsers
                    const blob = new Blob([content], { type: "text/plain" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = buffer.name;
                    a.click();
                    URL.revokeObjectURL(url);
                    buffer.markSaved();
                    updateBufferBar();
                    showSaveIndicator("Downloaded!");
                }

                // Show save success indicator
                function showSaveIndicator(message) {
                    let indicator = document.getElementById("saveIndicator");
                    if (!indicator) {
                        indicator = document.createElement("div");
                        indicator.id = "saveIndicator";
                        indicator.style.cssText = `
                            position: fixed;
                            top: 20px;
                            left: 50%;
                            transform: translateX(-50%);
                            background: rgba(0, 150, 0, 0.9);
                            color: white;
                            padding: 8px 16px;
                            border-radius: 4px;
                            font-size: 14px;
                            z-index: 2000;
                            opacity: 0;
                            transition: opacity 0.3s;
                            pointer-events: none;
                        `;
                        document.body.appendChild(indicator);
                    }

                    indicator.textContent = message;
                    indicator.style.opacity = "1";

                    setTimeout(() => {
                        indicator.style.opacity = "0";
                    }, 2000);
                }

                // Open file function
                async function openFile() {
                    // Check if File System Access API is supported
                    if ("showOpenFilePicker" in window) {
                        try {
                            const [handle] = await window.showOpenFilePicker({
                                types: [
                                    {
                                        description: "Text files",
                                        accept: {
                                            "text/plain": [".txt"],
                                            "text/markdown": [".md"],
                                            "text/javascript": [".js"],
                                            "text/html": [".html"],
                                            "text/css": [".css"],
                                            "application/json": [".json"],
                                            "text/xml": [".xml"],
                                            "text/csv": [".csv"],
                                            "application/javascript": [".js"],
                                            "text/typescript": [".ts"],
                                            "text/jsx": [".jsx"],
                                            "text/tsx": [".tsx"],
                                        },
                                    },
                                ],
                                multiple: false,
                            });

                            const file = await handle.getFile();
                            const content = await file.text();

                            createNewBuffer(file.name, content, handle);
                            return;
                        } catch (err) {
                            if (err.name !== "AbortError") {
                                console.log(
                                    "File picker failed, falling back to input:",
                                    err,
                                );
                            }
                        }
                    }

                    // Fallback to traditional file input
                    fileInput.click();
                }

                // New tab function
                function newTab() {
                    const newId = Math.random().toString(36).substr(2, 6);
                    const newUrl = `${window.location.origin}/${newId}`;
                    window.open(newUrl, "_blank");
                }

                // Toggle fullscreen
                function toggleFullscreen() {
                    if (!document.fullscreenElement) {
                        document.documentElement
                            .requestFullscreen()
                            .catch((err) => {
                                console.log(
                                    `Error attempting to enable fullscreen: ${err.message}`,
                                );
                            });
                    } else {
                        document.exitFullscreen();
                    }
                }

                // Event Listeners

                // Editor input listener
                editor.addEventListener("input", function () {
                    const buffer = buffers[activeBufferIndex];
                    if (buffer) {
                        buffer.content = editor.value;
                        updateBufferBar();
                    }
                    localStorage.setItem(
                        getStorageKey("editorContent"),
                        editor.value,
                    );
                    updateWordCount();
                });

                // File input listener (fallback)
                fileInput.addEventListener("change", function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        loadFileContent(file);
                    }
                });

                // Function to load file content
                function loadFileContent(file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        createNewBuffer(file.name, e.target.result, null);
                    };
                    reader.readAsText(file);
                }

                // Drag and drop functionality
                editor.addEventListener("dragover", function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    editor.classList.add("drag-over");
                });

                editor.addEventListener("dragleave", function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (!editor.contains(e.relatedTarget)) {
                        editor.classList.remove("drag-over");
                    }
                });

                editor.addEventListener("drop", function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    editor.classList.remove("drag-over");

                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        const allowedTypes = [
                            "text/plain",
                            "text/html",
                            "text/css",
                            "text/javascript",
                            "application/javascript",
                            "text/markdown",
                            "application/json",
                            "text/xml",
                            "application/xml",
                        ];

                        const allowedExtensions = [
                            ".txt",
                            ".md",
                            ".js",
                            ".html",
                            ".css",
                            ".json",
                            ".xml",
                            ".csv",
                            ".log",
                            ".yml",
                            ".yaml",
                            ".php",
                            ".py",
                            ".java",
                            ".cpp",
                            ".c",
                            ".h",
                            ".rb",
                            ".go",
                            ".rs",
                            ".swift",
                            ".kt",
                            ".ts",
                            ".jsx",
                            ".tsx",
                            ".vue",
                            ".svelte",
                            ".scss",
                            ".sass",
                            ".less",
                        ];

                        const fileExtension =
                            "." + file.name.split(".").pop().toLowerCase();
                        const isAllowedType = allowedTypes.includes(file.type);
                        const isAllowedExtension =
                            allowedExtensions.includes(fileExtension);

                        if (
                            isAllowedType ||
                            isAllowedExtension ||
                            file.type === ""
                        ) {
                            loadFileContent(file);
                        } else {
                            alert(
                                "Unsupported file type. Please use text-based files like .txt, .md, .js, .html, .css, etc.",
                            );
                        }
                    }
                });

                // Mobile button listeners
                openBtn.addEventListener("click", async function () {
                    await openFile();
                });
                saveBtn.addEventListener("click", async function () {
                    await saveFile();
                });

                // Mouse hover for shortcuts
                document.addEventListener("mousemove", function (e) {
                    if (
                        e.clientX > window.innerWidth - 100 &&
                        e.clientY < 100
                    ) {
                        shortcuts.classList.add("show");
                        hoverHint.classList.add("hide");
                        clearTimeout(showTimeout);
                    } else {
                        showTimeout = setTimeout(function () {
                            shortcuts.classList.remove("show");
                            hoverHint.classList.remove("hide");
                        }, 1000);
                    }
                });

                // Keyboard shortcuts
                document.addEventListener("keydown", function (e) {
                    const isModifierKey = e.ctrlKey || e.metaKey;

                    // Debug logging
                    if (isModifierKey && e.key >= "1" && e.key <= "9") {
                        console.log(
                            "Buffer switch attempt:",
                            e.key,
                            "Active:",
                            activeBufferIndex,
                            "Total buffers:",
                            buffers.length,
                        );
                    }

                    if (isModifierKey) {
                        // Handle number keys for buffer switching
                        if (e.key >= "1" && e.key <= "9") {
                            e.preventDefault();
                            const bufferIndex = parseInt(e.key) - 1;
                            console.log(
                                "Switching to buffer index:",
                                bufferIndex,
                            );
                            switchToBuffer(bufferIndex);
                            return;
                        }

                        // Handle arrow keys for buffer navigation
                        if (e.key === "ArrowLeft") {
                            e.preventDefault();
                            const prevIndex =
                                activeBufferIndex > 0
                                    ? activeBufferIndex - 1
                                    : buffers.length - 1;
                            switchToBuffer(prevIndex);
                            return;
                        }

                        if (e.key === "ArrowRight") {
                            e.preventDefault();
                            const nextIndex =
                                activeBufferIndex < buffers.length - 1
                                    ? activeBufferIndex + 1
                                    : 0;
                            switchToBuffer(nextIndex);
                            return;
                        }

                        switch (e.key.toLowerCase()) {
                            case "s":
                                e.preventDefault();
                                saveFile();
                                break;
                            case "d":
                                e.preventDefault();
                                toggleDarkMode();
                                break;
                            case "o":
                                e.preventDefault();
                                openFile();
                                break;
                            case "n":
                                e.preventDefault();
                                newTab();
                                break;
                            case "w":
                                e.preventDefault();
                                closeBuffer(activeBufferIndex);
                                break;
                        }
                    } else if (e.key === "F11") {
                        e.preventDefault();
                        toggleFullscreen();
                    }
                });

                // Initialize everything
                updateUrlWithTabId();
                initializeBuffers();
                loadDarkMode();
                editor.focus();
            });
        </script>
        <!-- Cloudflare Pages Analytics -->
        <script
            defer
            src="https://static.cloudflareinsights.com/beacon.min.js"
            data-cf-beacon='{"token": "4ff91f0f1de749c2a405a85ac2d12d29"}'
        ></script>
        <!-- Cloudflare Pages Analytics -->
    </body>
</html>
