<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>editr</title>
        <link
            rel="icon"
            href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjMDAwMDAwIi8+Cjx0ZXh0IHg9IjE2IiB5PSIyMiIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE4IiBmb250LXdlaWdodD0iNDAwIiBmaWxsPSIjZmZmZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5lPC90ZXh0Pgo8L3N2Zz4K"
            type="image/svg+xml"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Oxygen, Ubuntu, Cantarell, sans-serif;
                background: #1e1e1e;
                color: #e0e0e0;
                height: 100vh;
                overflow: hidden;
            }
            .header {
                background: #2d2d30;
                border-bottom: 1px solid #3e3e42;
                padding: 8px 16px;
                display: flex;
                align-items: center;
                gap: 12px;
            }
            .logo {
                font-weight: 600;
                color: #eab308;
            }
            .toolbar {
                display: flex;
                gap: 8px;
                align-items: center;
                flex-wrap: wrap;
            }
            .btn {
                background: #3c3c3c;
                border: 1px solid #555;
                color: #e0e0e0;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                display: flex;
                align-items: center;
                gap: 6px;
                transition: background-color 0.2s;
            }
            .btn:hover {
                background: #4a4a4a;
            }
            .btn-icon {
                font-size: 14px;
                font-style: normal;
            }
            .main-container {
                display: flex;
                height: calc(100vh - 50px);
            }
            .content-area {
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            .editor-container {
                flex: 1;
                display: flex;
            }
            .editor-wrapper {
                flex: 1;
                position: relative;
                display: flex;
            }
            .line-numbers {
                background: #2d2d30;
                color: #858585;
                font-family: "Courier New", Monaco, "Lucida Console", monospace;
                font-size: 14px;
                padding: 16px 4px 16px 8px;
                border-right: 1px solid #3e3e42;
                text-align: right;
                user-select: none;
                min-width: 35px;
                line-height: 1.5;
                white-space: pre;
            }
            .editor-content {
                flex: 1;
                position: relative;
            }
            .tabs-container {
                background: #2d2d30;
                border-bottom: 1px solid #3e3e42;
                display: flex;
                overflow-x: auto;
                min-height: 36px;
            }
            .tab {
                display: flex;
                align-items: center;
                padding: 8px 8px 8px 16px;
                border-right: 1px solid #3e3e42;
                cursor: pointer;
                font-size: 13px;
                white-space: nowrap;
                background: #1e1e1e;
                color: #cccccc;
                gap: 8px;
            }
            .tab.active {
                background: #1e1e1e;
                color: #ffffff;
                border-bottom: 2px solid #eab308;
            }
            .tab-filename {
                padding: 2px;
                outline: none;
            }
            .close-tab-btn {
                font-family: Arial, sans-serif;
                font-weight: bold;
                padding: 0px 5px 2px 5px;
                border-radius: 4px;
                line-height: 16px;
                font-size: 16px;
            }
            .close-tab-btn:hover {
                background-color: #3e3e42;
            }
            .editor {
                width: 100%;
                height: 100%;
                border: none;
                background: #1e1e1e;
                color: #e0e0e0;
                font-family: "Courier New", Monaco, "Lucida Console", monospace;
                font-size: 14px;
                padding: 16px;
                resize: none;
                outline: none;
                line-height: 1.5;
                white-space: pre-wrap;
                word-wrap: break-word;
            }
            .editor.has-selection {
                background-color: #1e1e1e;
            }
            .find-highlight {
                background-color: #eab308 !important;
                color: #000 !important;
            }
            .preview-pane {
                width: 50%;
                background: #ffffff;
                color: #333;
                overflow-y: auto;
                padding: 16px;
                border-left: 1px solid #3e3e42;
                display: none;
            }
            .preview-pane.active {
                display: block;
            }
            .csv-grid-container {
                width: 100%;
                height: 100%;
                overflow: hidden; /* Changed for better layout */
                background: #1e1e1e;
                display: none;
                flex-direction: column; /* Changed for layout */
                position: relative;
            }
            .grid-mode-active .editor {
                display: none;
            }
            .grid-mode-active .csv-grid-container {
                display: flex; /* Changed for layout */
            }
            .csv-filter-bar {
                padding: 4px 8px;
                background: #252526;
            }
            #csvFilterInput {
                width: 100%;
                padding: 6px;
                background: #1e1e1e;
                border: 1px solid #555;
                color: #e0e0e0;
                border-radius: 3px;
            }
            .csv-grid-wrapper {
                flex-grow: 1;
                overflow: auto;
            }
            .csv-grid {
                width: 100%;
                border-collapse: collapse;
                font-size: 12px;
            }
            .csv-grid th,
            .csv-grid td {
                border: 1px solid #3e3e42;
                padding: 0;
                text-align: left;
                position: relative;
            }
            .csv-grid th {
                background: #2d2d30;
                font-weight: 600;
                padding: 4px 8px;
                cursor: pointer;
            }
            .csv-grid th.sorted-asc::after {
                content: " ▲";
                font-size: 10px;
            }
            .csv-grid th.sorted-desc::after {
                content: " ▼";
                font-size: 10px;
            }
            .csv-grid-input {
                width: 100%;
                height: 100%;
                background: transparent;
                border: none;
                color: inherit;
                font: inherit;
                padding: 4px 8px;
                outline: none;
                min-height: 24px;
            }
            .csv-grid-input:focus {
                background-color: #3c3c3c;
            }
            .csv-grid-controls {
                position: absolute;
                top: 0;
                right: 0;
                background: #2d2d30;
                border: 1px solid #3e3e42;
                border-radius: 4px;
                padding: 8px;
                display: none;
                z-index: 100;
            }
            .csv-grid-controls.active {
                display: block;
            }
            .csv-grid-controls button {
                background: #3c3c3c;
                border: 1px solid #555;
                color: #e0e0e0;
                padding: 4px 8px;
                border-radius: 2px;
                cursor: pointer;
                font-size: 11px;
                margin: 2px;
                display: flex;
                align-items: center;
                gap: 4px;
            }
            .csv-grid-controls button:hover {
                background: #4a4a4a;
            }
            .grid-header-controls {
                position: relative;
            }
            .header-menu-btn {
                position: absolute;
                right: 2px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                color: #888;
                cursor: pointer;
                font-size: 10px;
                opacity: 0;
            }
            .csv-grid th:hover .header-menu-btn {
                opacity: 1;
            }
            .status-bar {
                background: #2d2d30;
                border-top: 1px solid #3e3e42;
                padding: 4px 16px;
                font-size: 11px;
                color: #cccccc;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .status-bar-right {
                display: flex;
                align-items: center;
                gap: 16px;
            }
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
            }
            .modal-content {
                background: #2d2d30;
                margin: 10% auto;
                padding: 20px;
                border: 1px solid #3e3e42;
                border-radius: 6px;
                width: 550px;
                color: #e0e0e0;
            }
            .input-group {
                margin-bottom: 12px;
            }
            .input-group label {
                display: block;
                margin-bottom: 4px;
            }
            .input-group input,
            .input-group textarea {
                width: 100%;
                padding: 8px;
                background: #1e1e1e;
                border: 1px solid #555;
                color: #e0e0e0;
            }
            .modal-buttons {
                display: flex;
                gap: 8px;
                justify-content: flex-end;
                margin-top: 16px;
            }
            .settings-section {
                margin-bottom: 20px;
            }
            .settings-section h4 {
                margin-bottom: 10px;
                border-bottom: 1px solid #3e3e42;
                padding-bottom: 5px;
            }
            #settingsExpandersList {
                margin-bottom: 16px;
                border: 1px solid #3e3e42;
                border-radius: 4px;
                max-height: 150px;
                overflow-y: auto;
                background: #1e1e1e;
            }
            .expander-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px;
                background: #252526;
                border-bottom: 1px solid #3e3e42;
                gap: 16px;
            }
            .expander-item:last-child {
                border-bottom: none;
            }
            .expander-text-container {
                display: flex;
                align-items: center;
                gap: 8px;
                flex-grow: 1;
                min-width: 0;
            }
            .expander-trigger {
                font-weight: bold;
                color: #eab308;
                background-color: #3c3c3c;
                padding: 2px 6px;
                border-radius: 3px;
                white-space: nowrap;
            }
            .expander-arrow {
                color: #888;
            }
            .expander-replacement {
                color: #ccc;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-family: "Courier New", Monaco, "Lucida Console", monospace;
            }
            .expander-placeholder {
                padding: 16px;
                text-align: center;
                color: #888;
                font-style: italic;
            }
            .delete-expander {
                cursor: pointer;
                color: #f87171;
                font-size: 12px;
                white-space: nowrap;
            }
            .delete-expander:hover {
                text-decoration: underline;
            }
            #buttonVisibilitySettings {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 10px;
            }
            .button-toggle {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 13px;
            }
            .find-dialog {
                position: absolute;
                top: 10px;
                right: 10px;
                background: #2d2d30;
                border: 1px solid #3e3e42;
                border-radius: 6px;
                padding: 16px;
                color: #e0e0e0;
                z-index: 500;
                min-width: 300px;
                display: none;
            }
            .find-dialog.active {
                display: block;
            }
            .find-input-group {
                margin-bottom: 8px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .find-input-group label {
                min-width: 60px;
                font-size: 12px;
            }
            .find-input-group input {
                flex: 1;
                padding: 4px 8px;
                background: #1e1e1e;
                border: 1px solid #555;
                color: #e0e0e0;
                border-radius: 3px;
                font-size: 12px;
            }
            .find-buttons {
                display: flex;
                gap: 6px;
                justify-content: flex-end;
                margin-top: 12px;
            }
            .find-btn {
                background: #3c3c3c;
                border: 1px solid #555;
                color: #e0e0e0;
                padding: 4px 8px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 11px;
            }
            .find-btn:hover {
                background: #4a4a4a;
            }
            .find-info {
                font-size: 11px;
                color: #888;
                margin-top: 4px;
            }
            .goto-dialog {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #2d2d30;
                border: 1px solid #3e3e42;
                border-radius: 6px;
                padding: 20px;
                color: #e0e0e0;
                z-index: 600;
                min-width: 300px;
                display: none;
            }
            .goto-dialog.active {
                display: block;
            }
            .goto-input-group {
                margin-bottom: 12px;
            }
            .goto-input-group label {
                display: block;
                margin-bottom: 4px;
                font-size: 12px;
            }
            .goto-input-group input {
                width: 100%;
                padding: 6px 8px;
                background: #1e1e1e;
                border: 1px solid #555;
                color: #e0e0e0;
                border-radius: 3px;
                font-size: 14px;
            }
            .goto-buttons {
                display: flex;
                gap: 8px;
                justify-content: flex-end;
            }
            .goto-btn {
                background: #3c3c3c;
                border: 1px solid #555;
                color: #e0e0e0;
                padding: 6px 12px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
            }
            .goto-btn:hover {
                background: #4a4a4a;
            }
            .shortcuts-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 16px;
                font-size: 13px;
            }
            .shortcuts-table th,
            .shortcuts-table td {
                border: 1px solid #3e3e42;
                padding: 8px;
                text-align: left;
            }
            .shortcuts-table th {
                background: #252526;
            }
            .shortcuts-table kbd {
                background-color: #3c3c3c;
                border: 1px solid #555;
                padding: 2px 5px;
                border-radius: 3px;
                font-family: "Courier New", monospace;
                font-size: 12px;
            }
            #collabStatus {
                font-weight: bold;
            }
            #collabStatus.disconnected {
                color: #f87171;
            }
            #collabStatus.connecting {
                color: #eab308;
            }
            #collabStatus.connected {
                color: #86efac;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="logo">editr</div>
            <div class="toolbar">
                <button
                    class="btn"
                    id="newFileBtn"
                    title="New File (Ctrl/Cmd + N)"
                >
                    <span class="btn-icon">📄</span>New
                </button>
                <button
                    class="btn"
                    id="openFileBtn"
                    title="Open File (Ctrl/Cmd + O)"
                >
                    <span class="btn-icon">📁</span>Open
                </button>
                <button
                    class="btn"
                    id="saveFileBtn"
                    title="Save File (Ctrl/Cmd + S)"
                >
                    <span class="btn-icon">💾</span>Save
                </button>
                <button
                    class="btn"
                    id="saveAsFileBtn"
                    title="Save As (Ctrl/Cmd + Shift + S)"
                >
                    <span class="btn-icon">📤</span>Save As
                </button>
                <button
                    class="btn"
                    id="renameFileBtn"
                    title="Rename File (Ctrl/Cmd + Shift + R)"
                >
                    <span class="btn-icon">✏️</span>Rename
                </button>
                <button
                    class="btn"
                    id="emailBtn"
                    title="Email File (Ctrl/Cmd + E)"
                >
                    <span class="btn-icon">✉️</span>Email
                </button>
                <button
                    class="btn"
                    id="collabBtn"
                    title="Collaborate (Ctrl/Cmd + Shift + C)"
                >
                    <span class="btn-icon">🤝</span>Collaborate
                </button>
                <button
                    class="btn"
                    id="previewBtn"
                    style="display: none"
                    title="Toggle Preview (Ctrl/Cmd + Alt + V)"
                >
                    <span class="btn-icon">👁️</span>Preview
                </button>
                <button
                    class="btn"
                    id="gridModeBtn"
                    style="display: none"
                    title="Toggle Grid Mode (Ctrl/Cmd + Alt + G)"
                >
                    <span class="btn-icon">⊞</span>Grid
                </button>
                <button
                    class="btn"
                    id="pdfBtn"
                    style="display: none"
                    title="Export to PDF"
                >
                    <span class="btn-icon">📋</span>PDF
                </button>
                <button
                    class="btn"
                    id="htmlBtn"
                    style="display: none"
                    title="Export to HTML"
                >
                    <span class="btn-icon">🌐</span>HTML
                </button>
                <button class="btn" id="findBtn" title="Find (Ctrl/Cmd + F)">
                    <span class="btn-icon">🔍</span>Find
                </button>
                <button
                    class="btn"
                    id="settingsBtn"
                    title="Settings (Ctrl/Cmd + ,)"
                >
                    <span class="btn-icon">⚙️</span>Settings
                </button>
                <button class="btn" id="helpBtn" title="Help (Ctrl/Cmd + /)">
                    <span class="btn-icon">❓</span>Help
                </button>
            </div>
        </div>
        <div class="main-container">
            <div class="content-area">
                <div class="tabs-container" id="tabsContainer"></div>
                <div class="editor-container" id="editorContainer">
                    <div class="editor-wrapper" id="editorWrapper">
                        <div class="line-numbers" id="lineNumbers">1</div>
                        <div class="editor-content">
                            <textarea class="editor" id="editor"></textarea>
                            <div class="find-dialog" id="findDialog">
                                <div class="find-input-group">
                                    <label>Find:</label>
                                    <input
                                        type="text"
                                        id="findInput"
                                        placeholder="Search text..."
                                    />
                                </div>
                                <div class="find-input-group">
                                    <label>Replace:</label>
                                    <input
                                        type="text"
                                        id="replaceInput"
                                        placeholder="Replace with..."
                                    />
                                </div>
                                <div class="find-info" id="findInfo"></div>
                                <div class="find-buttons">
                                    <button class="find-btn" id="findPrevBtn">
                                        ◀ Previous
                                    </button>
                                    <button class="find-btn" id="findNextBtn">
                                        Next ▶
                                    </button>
                                    <button class="find-btn" id="replaceBtn">
                                        Replace
                                    </button>
                                    <button class="find-btn" id="replaceAllBtn">
                                        Replace All
                                    </button>
                                    <button class="find-btn" id="closeFindBtn">
                                        ✖
                                    </button>
                                </div>
                            </div>
                            <div class="goto-dialog" id="gotoDialog">
                                <div class="goto-input-group">
                                    <label for="gotoInput"
                                        >Go to line number:</label
                                    >
                                    <input
                                        type="number"
                                        id="gotoInput"
                                        min="1"
                                        placeholder="Enter line number..."
                                    />
                                </div>
                                <div class="goto-buttons">
                                    <button class="goto-btn" id="cancelGotoBtn">
                                        Cancel
                                    </button>
                                    <button class="goto-btn" id="gotoBtn">
                                        Go
                                    </button>
                                </div>
                            </div>
                            <div
                                class="csv-grid-container"
                                id="csvGridContainer"
                            >
                                <div class="csv-filter-bar">
                                    <input
                                        type="text"
                                        id="csvFilterInput"
                                        placeholder="Filter rows..."
                                    />
                                </div>
                                <div class="csv-grid-wrapper">
                                    <table
                                        class="csv-grid"
                                        id="csvGrid"
                                    ></table>
                                </div>
                                <div
                                    class="csv-grid-controls"
                                    id="csvGridControls"
                                >
                                    <button id="addRowBtn">
                                        <span>➕</span>Add Row
                                    </button>
                                    <button id="addColBtn">
                                        <span>➕</span>Add Column
                                    </button>
                                    <button id="deleteRowBtn">
                                        <span>➖</span>Delete Row
                                    </button>
                                    <button id="deleteColBtn">
                                        <span>➖</span>Delete Column
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="preview-pane" id="previewPane"></div>
                </div>
            </div>
        </div>
        <div class="status-bar">
            <span id="statusText">Ready</span>
            <div class="status-bar-right">
                <span id="wordCount">Words: 0, Chars: 0</span>
                <span id="cursorPosition">Ln 1, Col 1</span>
            </div>
        </div>
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <h3>⚙️ Settings</h3>
                <div class="settings-section">
                    <h4>Text Expanders</h4>
                    <div id="settingsExpandersList"></div>
                    <button class="btn" id="addExpanderBtn">
                        <span class="btn-icon">➕</span>Add
                    </button>
                </div>
                <div class="settings-section">
                    <h4>Toolbar Buttons</h4>
                    <div id="buttonVisibilitySettings"></div>
                </div>
                <button class="btn" id="importSettingsBtn">
                    <span class="btn-icon">📥</span>Import Settings
                </button>
                <button class="btn" id="exportSettingsBtn">
                    <span class="btn-icon">📤</span>Export Settings
                </button>
                <div class="modal-buttons">
                    <button class="btn" id="closeSettingsBtn">
                        <span class="btn-icon">✖️</span>Close
                    </button>
                </div>
            </div>
        </div>
        <div id="expanderModal" class="modal">
            <div class="modal-content">
                <h3>➕ Add Text Expander</h3>
                <div class="input-group">
                    <label for="expanderTrigger">🔑 Trigger</label
                    ><input type="text" id="expanderTrigger" />
                </div>
                <div class="input-group">
                    <label for="expanderText">📝 Replacement Text</label
                    ><textarea id="expanderText"></textarea>
                </div>
                <h4>🔧 Dynamic Variables:</h4>
                <code>{date}</code> <code>{time}</code> <code>{datetime}</code>
                <code>{timestamp}</code>
                <div class="modal-buttons">
                    <button class="btn" id="cancelExpanderBtn">
                        <span class="btn-icon">❌</span>Cancel
                    </button>
                    <button class="btn" id="expanderSaveBtn">
                        <span class="btn-icon">✅</span>Add
                    </button>
                </div>
            </div>
        </div>
        <div id="helpModal" class="modal">
            <div class="modal-content">
                <h3>❓ Keyboard Shortcuts</h3>
                <table class="shortcuts-table">
                    <thead>
                        <tr>
                            <th>Shortcut</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><kbd>Ctrl/Cmd</kbd> + <kbd>N</kbd></td>
                            <td>Create a new file.</td>
                        </tr>
                        <tr>
                            <td><kbd>Ctrl/Cmd</kbd> + <kbd>O</kbd></td>
                            <td>Open a local file.</td>
                        </tr>
                        <tr>
                            <td><kbd>Ctrl/Cmd</kbd> + <kbd>S</kbd></td>
                            <td>Save the current file.</td>
                        </tr>
                        <tr>
                            <td>
                                <kbd>Ctrl/Cmd</kbd> + <kbd>Shift</kbd> +
                                <kbd>S</kbd>
                            </td>
                            <td>Save the current file with a new name.</td>
                        </tr>
                        <tr>
                            <td>
                                <kbd>Ctrl/Cmd</kbd> + <kbd>Shift</kbd> +
                                <kbd>R</kbd>
                            </td>
                            <td>Rename the current file.</td>
                        </tr>
                        <tr>
                            <td><kbd>Ctrl/Cmd</kbd> + <kbd>E</kbd></td>
                            <td>Email the current file.</td>
                        </tr>
                        <tr>
                            <td>
                                <kbd>Ctrl/Cmd</kbd> + <kbd>Shift</kbd> +
                                <kbd>C</kbd>
                            </td>
                            <td>Open Collaboration panel.</td>
                        </tr>
                        <tr>
                            <td><kbd>Ctrl/Cmd</kbd> + <kbd>F</kbd></td>
                            <td>Open the Find dialog.</td>
                        </tr>
                        <tr>
                            <td><kbd>Ctrl/Cmd</kbd> + <kbd>H</kbd></td>
                            <td>Open the Find & Replace dialog.</td>
                        </tr>
                        <tr>
                            <td><kbd>Ctrl/Cmd</kbd> + <kbd>G</kbd></td>
                            <td>Open the "Go to Line" dialog.</td>
                        </tr>
                        <tr>
                            <td><kbd>Ctrl/Cmd</kbd> + <kbd>Z</kbd></td>
                            <td>Undo the last action.</td>
                        </tr>
                        <tr>
                            <td>
                                <kbd>Ctrl/Cmd</kbd> + <kbd>Y</kbd> (or
                                <kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>Z</kbd>)
                            </td>
                            <td>Redo the last undone action.</td>
                        </tr>
                        <tr>
                            <td>
                                <kbd>Ctrl/Cmd</kbd> + <kbd>Alt</kbd> +
                                <kbd>V</kbd>
                            </td>
                            <td>Toggle Markdown Preview.</td>
                        </tr>
                        <tr>
                            <td>
                                <kbd>Ctrl/Cmd</kbd> + <kbd>Alt</kbd> +
                                <kbd>G</kbd>
                            </td>
                            <td>Toggle CSV Grid Mode.</td>
                        </tr>
                        <tr>
                            <td><kbd>Ctrl/Cmd</kbd> + <kbd>,</kbd></td>
                            <td>Open Settings.</td>
                        </tr>
                        <tr>
                            <td><kbd>Ctrl/Cmd</kbd> + <kbd>/</kbd></td>
                            <td>Open Help.</td>
                        </tr>
                    </tbody>
                </table>
                <div class="modal-buttons">
                    <button class="btn" id="closeHelpBtn">
                        <span class="btn-icon">✖️</span>Close
                    </button>
                </div>
            </div>
        </div>
        <div id="collabModal" class="modal">
            <div class="modal-content">
                <h3>🤝 Collaborate</h3>
                <p>
                    Status:
                    <span id="collabStatus" class="disconnected"
                        >Disconnected</span
                    >
                </p>
                <br />
                <div class="settings-section">
                    <h4>Start a New Session</h4>
                    <button class="btn" id="startCollabBtn">
                        1. Start Session & Get Offer Code
                    </button>
                    <div class="input-group">
                        <label for="collabOfferOutput"
                            >Your Offer Code (Send to peer):</label
                        >
                        <textarea
                            id="collabOfferOutput"
                            readonly
                            rows="3"
                        ></textarea>
                    </div>
                    <div class="input-group">
                        <label for="collabAnswerInput"
                            >3. Paste Peer's Answer Code:</label
                        >
                        <textarea
                            id="collabAnswerInput"
                            rows="3"
                            placeholder="Paste the code from your peer here..."
                        ></textarea>
                    </div>
                </div>
                <div class="settings-section">
                    <h4>Join an Existing Session</h4>
                    <div class="input-group">
                        <label for="collabOfferInput"
                            >2. Paste Peer's Offer Code:</label
                        >
                        <textarea
                            id="collabOfferInput"
                            rows="3"
                            placeholder="Paste the code from the host here..."
                        ></textarea>
                    </div>
                    <div class="input-group">
                        <label for="collabAnswerOutput"
                            >Your Answer Code (Send back to host):</label
                        >
                        <textarea
                            id="collabAnswerOutput"
                            readonly
                            rows="3"
                        ></textarea>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button
                        class="btn"
                        id="disconnectCollabBtn"
                        style="display: none"
                    >
                        Disconnect
                    </button>
                    <button class="btn" id="closeCollabBtn">Close</button>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                class TextEditor {
                    constructor() {
                        this.files = new Map();
                        this.activeFileId = null;
                        this.settings = {
                            expanders: [],
                            buttons: {
                                newFileBtn: true,
                                openFileBtn: true,
                                saveFileBtn: true,
                                saveAsFileBtn: true,
                                renameFileBtn: true,
                                emailBtn: true,
                                collabBtn: true,
                                previewBtn: true,
                                gridModeBtn: true,
                                pdfBtn: true,
                                htmlBtn: true,
                                findBtn: true,
                                settingsBtn: true,
                                helpBtn: true,
                            },
                        };
                        this.nextFileId = 1;
                        this.isPreviewActive = false;
                        this.isGridActive = false;
                        this.currentGridRow = 0;
                        this.currentGridCol = 0;
                        this.isInitializingGrid = false;
                        this.isSwitchingFile = false; // Prevents save prompt on open

                        // Find and replace state
                        this.findMatches = [];
                        this.currentMatchIndex = -1;
                        this.lastSearchTerm = "";

                        // Undo/Redo state
                        this.undoStack = [];
                        this.redoStack = [];
                        this.lastSavedState = "";

                        // CSV Sort state
                        this.sortState = { colIndex: -1, direction: "asc" };

                        // WebRTC state
                        this.peerConnection = null;
                        this.dataChannel = null;
                        this.isUpdatingFromPeer = false;

                        this.editorEl = document.getElementById("editor");
                        this.lineNumbersEl =
                            document.getElementById("lineNumbers");
                        this.tabsContainerEl =
                            document.getElementById("tabsContainer");
                        this.statusTextEl =
                            document.getElementById("statusText");
                        this.cursorPositionEl =
                            document.getElementById("cursorPosition");
                        this.wordCountEl = document.getElementById("wordCount");
                        this.settingsModal =
                            document.getElementById("settingsModal");
                        this.expanderModal =
                            document.getElementById("expanderModal");
                        this.helpModal = document.getElementById("helpModal");
                        this.collabModal =
                            document.getElementById("collabModal");
                        this.previewPane =
                            document.getElementById("previewPane");
                        this.editorWrapper =
                            document.getElementById("editorWrapper");
                        this.csvGrid = document.getElementById("csvGrid");
                        this.csvGridControls =
                            document.getElementById("csvGridControls");
                        this.csvFilterInput =
                            document.getElementById("csvFilterInput");

                        this.previewBtn = document.getElementById("previewBtn");
                        this.gridModeBtn =
                            document.getElementById("gridModeBtn");
                        this.pdfBtn = document.getElementById("pdfBtn");
                        this.htmlBtn = document.getElementById("htmlBtn");

                        // Find dialog elements
                        this.findDialog = document.getElementById("findDialog");
                        this.findInput = document.getElementById("findInput");
                        this.replaceInput =
                            document.getElementById("replaceInput");
                        this.findInfo = document.getElementById("findInfo");

                        // Goto dialog elements
                        this.gotoDialog = document.getElementById("gotoDialog");
                        this.gotoInput = document.getElementById("gotoInput");

                        this.init();
                    }

                    init() {
                        this.setupEventListeners();
                        this.loadSettings();
                        this.applySettings();
                        this.createNewFile();
                    }

                    setupEventListeners() {
                        document
                            .getElementById("newFileBtn")
                            .addEventListener("click", () =>
                                this.createNewFile(),
                            );
                        document
                            .getElementById("openFileBtn")
                            .addEventListener("click", () => this.openFile());
                        document
                            .getElementById("saveFileBtn")
                            .addEventListener("click", () => this.saveFile());
                        document
                            .getElementById("saveAsFileBtn")
                            .addEventListener("click", () => this.saveAsFile());
                        document
                            .getElementById("renameFileBtn")
                            .addEventListener("click", () => this.renameFile());
                        document
                            .getElementById("emailBtn")
                            .addEventListener("click", () => this.emailFile());
                        document
                            .getElementById("collabBtn")
                            .addEventListener("click", () =>
                                this.showCollabModal(),
                            );
                        document
                            .getElementById("settingsBtn")
                            .addEventListener("click", () =>
                                this.showSettingsModal(),
                            );
                        document
                            .getElementById("findBtn")
                            .addEventListener("click", () =>
                                this.showFindDialog(),
                            );
                        document
                            .getElementById("helpBtn")
                            .addEventListener("click", () =>
                                this.showHelpModal(),
                            );

                        this.previewBtn.addEventListener("click", () =>
                            this.togglePreview(),
                        );
                        this.gridModeBtn.addEventListener("click", () =>
                            this.toggleGridMode(),
                        );
                        this.pdfBtn.addEventListener("click", () =>
                            this.exportToPDF(),
                        );
                        this.htmlBtn.addEventListener("click", () =>
                            this.exportToHTML(),
                        );

                        // Handle tab switching and closing
                        this.tabsContainerEl.addEventListener("click", (e) => {
                            const tab = e.target.closest(".tab");
                            if (!tab) return;

                            const fileId = tab.dataset.fileId;
                            if (e.target.classList.contains("close-tab-btn")) {
                                e.stopPropagation();
                                this.closeFile(fileId);
                            } else if (!e.target.isContentEditable) {
                                this.switchToFile(fileId);
                            }
                        });

                        // CSV Grid controls
                        document
                            .getElementById("addRowBtn")
                            .addEventListener("click", () => this.addGridRow());
                        document
                            .getElementById("addColBtn")
                            .addEventListener("click", () =>
                                this.addGridColumn(),
                            );
                        document
                            .getElementById("deleteRowBtn")
                            .addEventListener("click", () =>
                                this.deleteGridRow(),
                            );
                        document
                            .getElementById("deleteColBtn")
                            .addEventListener("click", () =>
                                this.deleteGridColumn(),
                            );
                        this.csvFilterInput.addEventListener("input", (e) =>
                            this.filterCsvGrid(e.target.value),
                        );

                        document
                            .getElementById("closeSettingsBtn")
                            .addEventListener("click", () =>
                                this.closeSettingsModal(),
                            );
                        document
                            .getElementById("closeHelpBtn")
                            .addEventListener("click", () =>
                                this.closeHelpModal(),
                            );
                        document
                            .getElementById("addExpanderBtn")
                            .addEventListener("click", () =>
                                this.showExpanderModal(),
                            );
                        document
                            .getElementById("importSettingsBtn")
                            .addEventListener("click", () =>
                                this.importSettings(),
                            );
                        document
                            .getElementById("exportSettingsBtn")
                            .addEventListener("click", () =>
                                this.exportSettings(),
                            );
                        document
                            .getElementById("cancelExpanderBtn")
                            .addEventListener("click", () =>
                                this.closeExpanderModal(),
                            );
                        document
                            .getElementById("expanderSaveBtn")
                            .addEventListener("click", () =>
                                this.addExpander(),
                            );

                        // Collaboration modal events
                        document
                            .getElementById("closeCollabBtn")
                            .addEventListener("click", () =>
                                this.closeCollabModal(),
                            );
                        document
                            .getElementById("startCollabBtn")
                            .addEventListener("click", () =>
                                this.startCollaboration(),
                            );
                        document
                            .getElementById("collabOfferInput")
                            .addEventListener("paste", (e) =>
                                this.handleOfferPaste(e),
                            );
                        document
                            .getElementById("collabAnswerInput")
                            .addEventListener("paste", (e) =>
                                this.handleAnswerPaste(e),
                            );
                        document
                            .getElementById("disconnectCollabBtn")
                            .addEventListener("click", () =>
                                this.disconnectCollaboration(),
                            );

                        this.editorEl.addEventListener("input", () =>
                            this.handleEditorInput(),
                        );
                        this.editorEl.addEventListener("keydown", (e) =>
                            this.handleBracketClosing(e),
                        );
                        this.editorEl.addEventListener("keyup", () =>
                            this.updateStatusBar(),
                        );
                        this.editorEl.addEventListener("click", () =>
                            this.updateStatusBar(),
                        );
                        this.editorEl.addEventListener("scroll", () =>
                            this.syncLineNumbers(),
                        );

                        // Find dialog event listeners
                        document
                            .getElementById("findNextBtn")
                            .addEventListener("click", () => this.findNext());
                        document
                            .getElementById("findPrevBtn")
                            .addEventListener("click", () =>
                                this.findPrevious(),
                            );
                        document
                            .getElementById("replaceBtn")
                            .addEventListener("click", () =>
                                this.replaceCurrent(),
                            );
                        document
                            .getElementById("replaceAllBtn")
                            .addEventListener("click", () => this.replaceAll());
                        document
                            .getElementById("closeFindBtn")
                            .addEventListener("click", () =>
                                this.closeFindDialog(),
                            );

                        this.findInput.addEventListener("input", () =>
                            this.performFind(),
                        );
                        this.findInput.addEventListener("keydown", (e) => {
                            if (e.key === "Enter") {
                                e.preventDefault();
                                if (e.shiftKey) {
                                    this.findPrevious();
                                } else {
                                    this.findNext();
                                }
                            } else if (e.key === "Escape") {
                                this.closeFindDialog();
                            }
                        });

                        this.replaceInput.addEventListener("keydown", (e) => {
                            if (e.key === "Enter") {
                                e.preventDefault();
                                this.replaceCurrent();
                            } else if (e.key === "Escape") {
                                this.closeFindDialog();
                            }
                        });

                        // Global keyboard shortcuts
                        document.addEventListener("keydown", (e) => {
                            if (e.ctrlKey || e.metaKey) {
                                if (e.key === "n") {
                                    e.preventDefault();
                                    this.createNewFile();
                                } else if (e.key === "o") {
                                    e.preventDefault();
                                    this.openFile();
                                } else if (
                                    e.shiftKey &&
                                    e.key.toLowerCase() === "s"
                                ) {
                                    e.preventDefault();
                                    this.saveAsFile();
                                } else if (e.key === "s") {
                                    e.preventDefault();
                                    this.saveFile();
                                } else if (
                                    e.shiftKey &&
                                    e.key.toLowerCase() === "r"
                                ) {
                                    e.preventDefault();
                                    this.renameFile();
                                } else if (e.key.toLowerCase() === "e") {
                                    e.preventDefault();
                                    this.emailFile();
                                } else if (
                                    e.shiftKey &&
                                    e.key.toLowerCase() === "c"
                                ) {
                                    e.preventDefault();
                                    this.showCollabModal();
                                } else if (
                                    e.altKey &&
                                    e.key.toLowerCase() === "v"
                                ) {
                                    e.preventDefault();
                                    this.togglePreview();
                                } else if (
                                    e.altKey &&
                                    e.key.toLowerCase() === "g"
                                ) {
                                    e.preventDefault();
                                    this.toggleGridMode();
                                } else if (e.key === ",") {
                                    e.preventDefault();
                                    this.showSettingsModal();
                                } else if (e.key === "/") {
                                    e.preventDefault();
                                    this.showHelpModal();
                                } else if (e.key === "f") {
                                    e.preventDefault();
                                    this.showFindDialog();
                                } else if (e.key === "h") {
                                    e.preventDefault();
                                    this.showFindDialog();
                                    this.replaceInput.focus();
                                } else if (e.key === "g") {
                                    e.preventDefault();
                                    this.showGotoDialog();
                                } else if (e.key === "z" && !e.shiftKey) {
                                    e.preventDefault();
                                    this.undo();
                                } else if (
                                    e.key === "y" ||
                                    (e.key === "z" && e.shiftKey)
                                ) {
                                    e.preventDefault();
                                    this.redo();
                                }
                            }
                        });

                        // Goto dialog event listeners
                        document
                            .getElementById("gotoBtn")
                            .addEventListener("click", () => this.gotoLine());
                        document
                            .getElementById("cancelGotoBtn")
                            .addEventListener("click", () =>
                                this.closeGotoDialog(),
                            );

                        this.gotoInput.addEventListener("keydown", (e) => {
                            if (e.key === "Enter") {
                                e.preventDefault();
                                this.gotoLine();
                            } else if (e.key === "Escape") {
                                this.closeGotoDialog();
                            }
                        });

                        // Show/hide grid controls on right-click
                        document.addEventListener("contextmenu", (e) => {
                            if (
                                this.isGridActive &&
                                e.target.closest(".csv-grid-container")
                            ) {
                                e.preventDefault();
                                this.showGridControls(e.clientX, e.clientY);
                            } else {
                                this.hideGridControls();
                            }
                        });

                        document.addEventListener("click", (e) => {
                            if (!e.target.closest(".csv-grid-controls")) {
                                this.hideGridControls();
                            }
                        });

                        // Event delegation for deleting expanders
                        document
                            .getElementById("settingsExpandersList")
                            .addEventListener("click", (e) => {
                                if (
                                    e.target.classList.contains(
                                        "delete-expander",
                                    )
                                ) {
                                    const trigger = e.target.dataset.trigger;
                                    if (trigger) {
                                        const expanders = new Map(
                                            this.settings.expanders,
                                        );
                                        expanders.delete(trigger);
                                        this.settings.expanders = Array.from(
                                            expanders.entries(),
                                        );
                                        this.saveSettings();
                                        this.updateSettingsModal();
                                    }
                                }
                            });
                    }

                    handleBracketClosing(e) {
                        const bracketMap = {
                            "(": ")",
                            "[": "]",
                            "{": "}",
                            '"': '"',
                            "'": "'",
                        };
                        const openBracket = e.key;
                        const closeBracket = bracketMap[openBracket];

                        if (!closeBracket) return;

                        e.preventDefault();
                        const start = this.editorEl.selectionStart;
                        const end = this.editorEl.selectionEnd;
                        const selectedText = this.editorEl.value.substring(
                            start,
                            end,
                        );

                        const textBefore = this.editorEl.value.substring(
                            0,
                            start,
                        );
                        const textAfter = this.editorEl.value.substring(end);

                        const newText =
                            openBracket + selectedText + closeBracket;
                        this.editorEl.value = textBefore + newText + textAfter;

                        if (start === end) {
                            this.editorEl.selectionStart =
                                this.editorEl.selectionEnd = start + 1;
                        } else {
                            this.editorEl.selectionStart =
                                start + openBracket.length;
                            this.editorEl.selectionEnd =
                                end + openBracket.length;
                        }
                        this.handleEditorInput();
                    }

                    closeFile(fileIdToClose) {
                        const fileToClose = this.files.get(fileIdToClose);
                        if (!fileToClose) return;

                        this.files.delete(fileIdToClose);

                        if (this.activeFileId === fileIdToClose) {
                            if (this.files.size > 0) {
                                const nextFileId = this.files
                                    .keys()
                                    .next().value;
                                this.switchToFile(nextFileId);
                            } else {
                                this.createNewFile();
                            }
                        } else {
                            this.renderTabs();
                        }
                    }

                    togglePreview() {
                        this.isPreviewActive = !this.isPreviewActive;
                        this.previewPane.classList.toggle(
                            "active",
                            this.isPreviewActive,
                        );
                        if (this.isPreviewActive) this.updatePreview();
                    }

                    updatePreview() {
                        const file = this.files.get(this.activeFileId);
                        if (file && this.isPreviewActive)
                            this.previewPane.innerHTML = marked.parse(
                                file.content,
                            );
                    }

                    toggleGridMode() {
                        this.isGridActive = !this.isGridActive;
                        if (!this.isGridActive) {
                            this.csvFilterInput.value = "";
                        }
                        this.editorWrapper.classList.toggle(
                            "grid-mode-active",
                            this.isGridActive,
                        );
                        if (this.isGridActive) {
                            this.isInitializingGrid = true;
                            this.renderCsvGrid();
                            this.isInitializingGrid = false;
                        }
                    }

                    renderCsvGrid() {
                        const file = this.files.get(this.activeFileId);
                        if (!file) return;

                        const lines = file.content
                            .split("\n")
                            .filter((line) => line.trim());
                        const data = lines.map((line) => line.split(","));

                        if (data.length === 0) {
                            data.push(["Column 1", "Column 2", "Column 3"]);
                            data.push(["", "", ""]);
                        }

                        let tableHTML = "<thead><tr>";
                        data[0].forEach((header, index) => {
                            let sortClass = "";
                            if (this.sortState.colIndex === index) {
                                sortClass =
                                    this.sortState.direction === "asc"
                                        ? "sorted-asc"
                                        : "sorted-desc";
                            }
                            tableHTML += `<th class="grid-header-controls ${sortClass}" data-col-index="${index}">${header}</th>`;
                        });
                        tableHTML += "</tr></thead><tbody>";

                        data.slice(1).forEach((row, rowIndex) => {
                            tableHTML += "<tr>";
                            row.forEach((cell, colIndex) => {
                                tableHTML += `<td><input type="text" class="csv-grid-input" value="${cell}" data-row="${rowIndex}" data-col="${colIndex}"></td>`;
                            });
                            tableHTML += "</tr>";
                        });
                        this.csvGrid.innerHTML = tableHTML + "</tbody>";

                        this.csvGrid.querySelectorAll("th").forEach((th) => {
                            th.addEventListener("click", (e) => {
                                const colIndex = parseInt(
                                    e.currentTarget.dataset.colIndex,
                                    10,
                                );
                                if (!isNaN(colIndex)) {
                                    this.sortCsvColumn(colIndex);
                                }
                            });
                        });
                        this.setupGridNavigation();
                    }

                    sortCsvColumn(colIndex) {
                        const file = this.files.get(this.activeFileId);
                        if (!file) return;

                        if (this.sortState.colIndex === colIndex) {
                            this.sortState.direction =
                                this.sortState.direction === "asc"
                                    ? "desc"
                                    : "asc";
                        } else {
                            this.sortState.colIndex = colIndex;
                            this.sortState.direction = "asc";
                        }

                        const directionModifier =
                            this.sortState.direction === "asc" ? 1 : -1;

                        const lines = file.content
                            .split("\n")
                            .filter((line) => line.trim());
                        const header = lines.shift();
                        const dataRows = lines.map((line) => line.split(","));

                        dataRows.sort((a, b) => {
                            const valA = a[colIndex] || "";
                            const valB = b[colIndex] || "";

                            const numA = parseFloat(valA);
                            const numB = parseFloat(valB);

                            if (!isNaN(numA) && !isNaN(numB)) {
                                return (numA - numB) * directionModifier;
                            }

                            return valA.localeCompare(valB) * directionModifier;
                        });

                        const newContent = [
                            header,
                            ...dataRows.map((row) => row.join(",")),
                        ].join("\n");

                        file.content = newContent;
                        file.modified = true;
                        this.editorEl.value = file.content;
                        this.renderCsvGrid();
                        this.renderTabs();
                        this.filterCsvGrid(this.csvFilterInput.value);
                    }

                    filterCsvGrid(query) {
                        const lowerCaseQuery = query.toLowerCase();
                        const rows = this.csvGrid.querySelectorAll("tbody tr");

                        rows.forEach((row) => {
                            const rowText = row.textContent.toLowerCase();
                            if (rowText.includes(lowerCaseQuery)) {
                                row.style.display = "";
                            } else {
                                row.style.display = "none";
                            }
                        });
                    }

                    setupGridNavigation() {
                        const inputs =
                            this.csvGrid.querySelectorAll(".csv-grid-input");

                        inputs.forEach((input) => {
                            input.addEventListener("input", (e) => {
                                if (!this.isInitializingGrid) {
                                    this.updateCsvFromGrid(e);
                                }
                            });
                            input.addEventListener("focus", (e) => {
                                this.currentGridRow = parseInt(
                                    e.target.dataset.row,
                                );
                                this.currentGridCol = parseInt(
                                    e.target.dataset.col,
                                );
                            });

                            input.addEventListener("keydown", (e) => {
                                const row = parseInt(e.target.dataset.row);
                                const col = parseInt(e.target.dataset.col);

                                switch (e.key) {
                                    case "ArrowUp":
                                        e.preventDefault();
                                        this.navigateGrid(row - 1, col);
                                        break;
                                    case "ArrowDown":
                                    case "Enter":
                                        e.preventDefault();
                                        this.navigateGrid(row + 1, col);
                                        break;
                                    case "ArrowLeft":
                                        if (e.target.selectionStart === 0) {
                                            e.preventDefault();
                                            this.navigateGrid(row, col - 1);
                                        }
                                        break;
                                    case "ArrowRight":
                                    case "Tab":
                                        if (
                                            e.key === "ArrowRight" &&
                                            e.target.selectionEnd ===
                                                e.target.value.length
                                        ) {
                                            e.preventDefault();
                                            this.navigateGrid(row, col + 1);
                                        } else if (e.key === "Tab") {
                                            e.preventDefault();
                                            this.navigateGrid(row, col + 1);
                                        }
                                        break;
                                    case "Delete":
                                        if (e.ctrlKey || e.metaKey) {
                                            e.preventDefault();
                                            if (e.shiftKey) {
                                                this.deleteGridColumn(col);
                                            } else {
                                                this.deleteGridRow(row);
                                            }
                                        }
                                        break;
                                    case "Insert":
                                        e.preventDefault();
                                        if (e.shiftKey) {
                                            this.addGridColumn(col);
                                        } else {
                                            this.addGridRow(row + 1);
                                        }
                                        break;
                                }
                            });
                        });
                    }

                    navigateGrid(targetRow, targetCol) {
                        const input = this.csvGrid.querySelector(
                            `[data-row="${targetRow}"][data-col="${targetCol}"]`,
                        );
                        if (input) {
                            input.focus();
                            this.currentGridRow = targetRow;
                            this.currentGridCol = targetCol;
                        }
                    }

                    showGridControls(x, y) {
                        this.csvGridControls.style.left = x + "px";
                        this.csvGridControls.style.top = y + "px";
                        this.csvGridControls.classList.add("active");
                    }

                    hideGridControls() {
                        this.csvGridControls.classList.remove("active");
                    }

                    addGridRow(atIndex = null) {
                        const file = this.files.get(this.activeFileId);
                        if (!file) return;

                        const lines = file.content
                            .split("\n")
                            .filter((line) => line.trim());
                        const data = lines.map((line) => line.split(","));

                        const insertIndex =
                            atIndex !== null ? atIndex + 1 : data.length;
                        const newRow = new Array(data[0].length).fill("");
                        data.splice(insertIndex, 0, newRow);

                        file.content = data
                            .map((row) => row.join(","))
                            .join("\n");
                        file.modified = true;
                        this.editorEl.value = file.content;
                        this.renderCsvGrid();
                        this.renderTabs();
                    }

                    addGridColumn(atIndex = null) {
                        const file = this.files.get(this.activeFileId);
                        if (!file) return;

                        const lines = file.content
                            .split("\n")
                            .filter((line) => line.trim());
                        const data = lines.map((line) => line.split(","));

                        const insertIndex =
                            atIndex !== null ? atIndex + 1 : data[0].length;
                        data.forEach((row, rowIndex) => {
                            row.splice(
                                insertIndex,
                                0,
                                rowIndex === 0 ? "New Column" : "",
                            );
                        });

                        file.content = data
                            .map((row) => row.join(","))
                            .join("\n");
                        file.modified = true;
                        this.editorEl.value = file.content;
                        this.renderCsvGrid();
                        this.renderTabs();
                    }

                    deleteGridRow(rowIndex = null) {
                        const file = this.files.get(this.activeFileId);
                        if (!file) return;

                        const lines = file.content
                            .split("\n")
                            .filter((line) => line.trim());
                        const data = lines.map((line) => line.split(","));

                        if (data.length <= 2) return; // Keep at least header + 1 row

                        const deleteIndex =
                            rowIndex !== null
                                ? rowIndex + 1
                                : this.currentGridRow + 1;
                        data.splice(deleteIndex, 1);

                        file.content = data
                            .map((row) => row.join(","))
                            .join("\n");
                        file.modified = true;
                        this.editorEl.value = file.content;
                        this.renderCsvGrid();
                        this.renderTabs();
                        this.hideGridControls();
                    }

                    deleteGridColumn(colIndex = null) {
                        const file = this.files.get(this.activeFileId);
                        if (!file) return;

                        const lines = file.content
                            .split("\n")
                            .filter((line) => line.trim());
                        const data = lines.map((line) => line.split(","));

                        if (data[0].length <= 1) return; // Keep at least 1 column

                        const deleteIndex =
                            colIndex !== null ? colIndex : this.currentGridCol;
                        data.forEach((row) => {
                            row.splice(deleteIndex, 1);
                        });

                        file.content = data
                            .map((row) => row.join(","))
                            .join("\n");
                        file.modified = true;
                        this.editorEl.value = file.content;
                        this.renderCsvGrid();
                        this.renderTabs();
                        this.hideGridControls();
                    }

                    updateCsvFromGrid() {
                        const headers = Array.from(
                            this.csvGrid.querySelectorAll("th"),
                        ).map((th) =>
                            th.textContent.replace(/[▲▼]/g, "").trim(),
                        );

                        let newContent = headers.join(",") + "\n";

                        const rows = Array.from(
                            this.csvGrid.querySelectorAll("tbody tr"),
                        );
                        rows.forEach((row) => {
                            const cells = Array.from(
                                row.querySelectorAll(".csv-grid-input"),
                            ).map((input) => input.value);
                            newContent += cells.join(",") + "\n";
                        });

                        const file = this.files.get(this.activeFileId);
                        if (file) {
                            file.content = newContent.trim();
                            file.modified = true;
                            this.editorEl.value = file.content;
                            this.renderTabs();
                        }
                    }

                    updateToolbarButtons(file) {
                        const isMarkdown = file.name.endsWith(".md");
                        const isCsv = file.name.endsWith(".csv");

                        // These buttons are conditional on file type
                        document.getElementById("previewBtn").style.display =
                            isMarkdown && this.settings.buttons.previewBtn
                                ? "flex"
                                : "none";
                        document.getElementById("pdfBtn").style.display =
                            isMarkdown && this.settings.buttons.pdfBtn
                                ? "flex"
                                : "none";
                        document.getElementById("htmlBtn").style.display =
                            isMarkdown && this.settings.buttons.htmlBtn
                                ? "flex"
                                : "none";
                        document.getElementById("gridModeBtn").style.display =
                            isCsv && this.settings.buttons.gridModeBtn
                                ? "flex"
                                : "none";
                    }

                    switchToFile(fileId) {
                        this.isSwitchingFile = true;
                        this.activeFileId = fileId;
                        const file = this.files.get(fileId);
                        if (file) {
                            this.editorEl.value = file.content;
                            this.updateToolbarButtons(file);
                            this.isPreviewActive = false;
                            this.isGridActive = false;
                            this.csvFilterInput.value = "";
                            this.sortState = { colIndex: -1, direction: "asc" };
                            this.previewPane.classList.remove("active");
                            this.editorWrapper.classList.remove(
                                "grid-mode-active",
                            );
                            // Reset undo/redo stacks for new file
                            this.undoStack = [];
                            this.redoStack = [];
                            this.lastSavedState = file.content;
                        }
                        this.renderTabs();
                        this.updateStatusBar();
                        this.updateLineNumbers();
                        this.isSwitchingFile = false;
                    }

                    createNewFile() {
                        const fileId = `file_${this.nextFileId++}`;
                        const file = {
                            id: fileId,
                            name: `untitled-${this.files.size + 1}.txt`,
                            content: "",
                            modified: false,
                        };
                        this.files.set(fileId, file);
                        this.switchToFile(fileId);
                    }

                    openFile() {
                        const input = document.createElement("input");
                        input.type = "file";
                        input.accept = ".txt,.md,.csv,.js,.html,.css,.json";
                        input.onchange = (e) => {
                            const file = e.target.files[0];
                            if (!file) return;
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const newFile = {
                                    id: `file_${this.nextFileId++}`,
                                    name: file.name,
                                    content: e.target.result,
                                    modified: false,
                                };
                                this.files.set(newFile.id, newFile);
                                this.switchToFile(newFile.id);
                            };
                            reader.readAsText(file);
                        };
                        input.click();
                    }

                    handleEditorInput() {
                        if (this.isSwitchingFile) return;

                        // Send data to peer if connected and not updating from peer
                        if (
                            this.dataChannel &&
                            this.dataChannel.readyState === "open" &&
                            !this.isUpdatingFromPeer
                        ) {
                            this.dataChannel.send(this.editorEl.value);
                        }

                        const file = this.files.get(this.activeFileId);
                        if (file) {
                            // Save current state to undo stack before making changes
                            if (file.content !== this.editorEl.value) {
                                this.saveToUndoStack(file.content);
                            }

                            file.content = this.editorEl.value;
                            file.modified = true;
                            this.renderTabs();
                            this.checkTextExpanders();
                            if (this.isPreviewActive) this.updatePreview();
                            if (this.isGridActive && !this.isInitializingGrid) {
                                this.isInitializingGrid = true;
                                this.renderCsvGrid();
                                this.isInitializingGrid = false;
                            }
                        }
                        this.updateStatusBar();
                    }

                    checkTextExpanders() {
                        const cursorPos = this.editorEl.selectionStart;
                        const textBeforeCursor = this.editorEl.value.substring(
                            0,
                            cursorPos,
                        );
                        const expanders = new Map(this.settings.expanders);
                        for (const [trigger, replacement] of expanders) {
                            if (textBeforeCursor.endsWith(trigger)) {
                                const expandedText =
                                    this.processExpansion(replacement);
                                this.editorEl.value =
                                    this.editorEl.value.substring(
                                        0,
                                        cursorPos - trigger.length,
                                    ) +
                                    expandedText +
                                    this.editorEl.value.substring(cursorPos);
                                this.editorEl.setSelectionRange(
                                    cursorPos -
                                        trigger.length +
                                        expandedText.length,
                                    cursorPos -
                                        trigger.length +
                                        expandedText.length,
                                );
                                this.handleEditorInput();
                                break;
                            }
                        }
                    }

                    processExpansion(text) {
                        const now = new Date();
                        return text
                            .replace(/\{date\}/g, now.toLocaleDateString())
                            .replace(/\{time\}/g, now.toLocaleTimeString())
                            .replace(/\{datetime\}/g, now.toLocaleString())
                            .replace(/\{timestamp\}/g, Date.now().toString());
                    }

                    saveFile() {
                        const file = this.files.get(this.activeFileId);
                        if (!file) return;
                        const blob = new Blob([file.content], {
                            type: "text/plain",
                        });
                        const a = document.createElement("a");
                        a.href = URL.createObjectURL(blob);
                        a.download = file.name.replace(/\*$/, "");
                        a.click();
                        URL.revokeObjectURL(a.href);
                        file.modified = false;
                        this.lastSavedState = file.content;
                        this.renderTabs();
                    }

                    saveAsFile() {
                        const file = this.files.get(this.activeFileId);
                        if (!file) return;

                        const newName = prompt(
                            "Enter new file name:",
                            file.name.replace(/\*$/, ""),
                        );
                        if (newName && newName !== file.name) {
                            file.name = newName;
                            this.saveFile(); // This will save with the new name and update the UI
                        }
                    }

                    renameFile() {
                        const file = this.files.get(this.activeFileId);
                        if (!file) return;

                        const newName = prompt(
                            "Rename file to:",
                            file.name.replace(/\*$/, ""),
                        );
                        if (newName && newName !== file.name) {
                            file.name = newName;
                            file.modified = true;
                            this.renderTabs();
                            this.updateStatusBar();
                            this.updateToolbarButtons(file);
                        }
                    }

                    emailFile() {
                        const file = this.files.get(this.activeFileId);
                        if (!file) return;

                        const subject = encodeURIComponent(
                            file.name.replace(/\*$/, ""),
                        );
                        const body = encodeURIComponent(file.content);
                        window.location.href = `mailto:?subject=${subject}&body=${body}`;
                    }

                    renderTabs() {
                        this.tabsContainerEl.innerHTML = "";
                        this.files.forEach((file) => {
                            const tab = document.createElement("div");
                            tab.className = `tab ${file.id === this.activeFileId ? "active" : ""}`;
                            tab.dataset.fileId = file.id;

                            const fileNameSpan = document.createElement("span");
                            fileNameSpan.className = "tab-filename";
                            fileNameSpan.textContent =
                                file.name + (file.modified ? "*" : "");

                            const closeBtn = document.createElement("span");
                            closeBtn.className = "close-tab-btn";
                            closeBtn.textContent = "×";
                            closeBtn.title = "Close tab";

                            tab.appendChild(fileNameSpan);
                            tab.appendChild(closeBtn);
                            this.tabsContainerEl.appendChild(tab);
                        });
                    }

                    updateStatusBar() {
                        const file = this.files.get(this.activeFileId);
                        this.statusTextEl.textContent = file
                            ? file.name.replace(/\*$/, "")
                            : "Ready";

                        const content = this.editorEl.value;
                        const charCount = content.length;
                        const wordCount = content
                            .trim()
                            .split(/\s+/)
                            .filter(Boolean).length;
                        this.wordCountEl.textContent = `Words: ${wordCount}, Chars: ${charCount}`;

                        const pos = this.editorEl.selectionStart;
                        const text = this.editorEl.value.substring(0, pos);
                        const lines = text.split("\n");
                        this.cursorPositionEl.textContent = `Ln ${lines.length}, Col ${lines[lines.length - 1].length + 1}`;
                        this.updateLineNumbers();
                    }

                    updateLineNumbers() {
                        const content = this.editorEl.value;
                        const lines = content.split("\n");
                        const lineCount = lines.length;

                        let lineNumbersHtml = "";
                        for (let i = 1; i <= lineCount; i++) {
                            lineNumbersHtml += i + "\n";
                        }

                        this.lineNumbersEl.textContent = lineNumbersHtml.trim();
                    }

                    syncLineNumbers() {
                        this.lineNumbersEl.scrollTop = this.editorEl.scrollTop;
                    }

                    // Find and Replace functionality
                    showFindDialog() {
                        this.findDialog.classList.add("active");
                        this.findInput.focus();
                        if (this.findInput.value) {
                            this.performFind();
                        }
                    }

                    closeFindDialog() {
                        this.findDialog.classList.remove("active");
                        this.clearHighlights();
                        this.editorEl.focus();
                    }

                    performFind() {
                        const searchTerm = this.findInput.value;
                        if (!searchTerm) {
                            this.clearHighlights();
                            this.findInfo.textContent = "";
                            return;
                        }

                        this.findMatches = [];
                        this.currentMatchIndex = -1;
                        this.lastSearchTerm = searchTerm;

                        const content = this.editorEl.value;
                        const searchRegex = new RegExp(
                            this.escapeRegex(searchTerm),
                            "gi",
                        );
                        let match;

                        while ((match = searchRegex.exec(content)) !== null) {
                            this.findMatches.push({
                                start: match.index,
                                end: match.index + match[0].length,
                            });
                        }

                        this.updateFindInfo();
                        if (this.findMatches.length > 0) {
                            this.currentMatchIndex = 0;
                            this.highlightCurrentMatch();
                        }
                    }

                    findNext() {
                        if (this.findMatches.length === 0) {
                            this.performFind();
                            return;
                        }

                        this.currentMatchIndex =
                            (this.currentMatchIndex + 1) %
                            this.findMatches.length;
                        this.highlightCurrentMatch();
                        this.updateFindInfo();
                    }

                    findPrevious() {
                        if (this.findMatches.length === 0) {
                            this.performFind();
                            return;
                        }

                        this.currentMatchIndex =
                            this.currentMatchIndex <= 0
                                ? this.findMatches.length - 1
                                : this.currentMatchIndex - 1;
                        this.highlightCurrentMatch();
                        this.updateFindInfo();
                    }

                    highlightCurrentMatch() {
                        if (
                            this.currentMatchIndex >= 0 &&
                            this.currentMatchIndex < this.findMatches.length
                        ) {
                            const match =
                                this.findMatches[this.currentMatchIndex];
                            this.editorEl.setSelectionRange(
                                match.start,
                                match.end,
                            );
                            this.editorEl.focus();
                        }
                    }

                    replaceCurrent() {
                        if (
                            this.currentMatchIndex >= 0 &&
                            this.currentMatchIndex < this.findMatches.length
                        ) {
                            const match =
                                this.findMatches[this.currentMatchIndex];
                            const replaceText = this.replaceInput.value;

                            const content = this.editorEl.value;
                            const newContent =
                                content.substring(0, match.start) +
                                replaceText +
                                content.substring(match.end);

                            this.editorEl.value = newContent;
                            this.handleEditorInput();

                            const newCursorPos =
                                match.start + replaceText.length;
                            this.editorEl.setSelectionRange(
                                newCursorPos,
                                newCursorPos,
                            );

                            this.performFind();
                        }
                    }

                    replaceAll() {
                        const searchTerm = this.findInput.value;
                        const replaceText = this.replaceInput.value;

                        if (!searchTerm) return;

                        const content = this.editorEl.value;
                        const searchRegex = new RegExp(
                            this.escapeRegex(searchTerm),
                            "g",
                        );
                        const newContent = content.replace(
                            searchRegex,
                            replaceText,
                        );

                        if (newContent !== content) {
                            this.editorEl.value = newContent;
                            this.handleEditorInput();
                            this.performFind();
                        }
                    }

                    clearHighlights() {
                        this.findMatches = [];
                        this.currentMatchIndex = -1;
                    }

                    updateFindInfo() {
                        if (this.findMatches.length === 0) {
                            this.findInfo.textContent = this.findInput.value
                                ? "No matches found"
                                : "";
                        } else {
                            this.findInfo.textContent = `${this.currentMatchIndex + 1} of ${this.findMatches.length}`;
                        }
                    }

                    escapeRegex(string) {
                        return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
                    }

                    saveToUndoStack(content) {
                        if (
                            this.undoStack.length > 0 &&
                            this.undoStack[this.undoStack.length - 1] ===
                                content
                        ) {
                            return;
                        }
                        this.undoStack.push(content);
                        this.redoStack = [];
                    }

                    undo() {
                        if (this.undoStack.length === 0) return;
                        const prevState = this.undoStack.pop();
                        this.redoStack.push(this.editorEl.value);

                        this.isSwitchingFile = true;
                        const file = this.files.get(this.activeFileId);
                        this.editorEl.value = prevState;
                        if (file) {
                            file.content = prevState;
                            file.modified =
                                file.content !== this.lastSavedState;
                        }
                        this.isSwitchingFile = false;

                        this.updateStatusBar();
                        this.renderTabs();
                    }

                    redo() {
                        if (this.redoStack.length === 0) return;
                        const nextState = this.redoStack.pop();
                        this.undoStack.push(this.editorEl.value);

                        this.isSwitchingFile = true;
                        const file = this.files.get(this.activeFileId);
                        this.editorEl.value = nextState;
                        if (file) {
                            file.content = nextState;
                            file.modified =
                                file.content !== this.lastSavedState;
                        }
                        this.isSwitchingFile = false;

                        this.updateStatusBar();
                        this.renderTabs();
                    }

                    showGotoDialog() {
                        this.gotoDialog.classList.add("active");
                        this.gotoInput.value = "";
                        this.gotoInput.focus();
                    }

                    closeGotoDialog() {
                        this.gotoDialog.classList.remove("active");
                        this.editorEl.focus();
                    }

                    gotoLine() {
                        const lineNum = parseInt(this.gotoInput.value, 10);
                        if (isNaN(lineNum) || lineNum < 1) {
                            this.closeGotoDialog();
                            return;
                        }

                        const lines = this.editorEl.value.split("\n");
                        const targetLine = Math.min(lineNum, lines.length) - 1;

                        let charIndex = 0;
                        for (let i = 0; i < targetLine; i++) {
                            charIndex += lines[i].length + 1; // +1 for newline
                        }

                        this.editorEl.focus();
                        this.editorEl.setSelectionRange(charIndex, charIndex);
                        this.updateStatusBar();
                        this.closeGotoDialog();
                    }

                    exportToPDF() {
                        const file = this.files.get(this.activeFileId);
                        if (!file || !file.name.endsWith(".md")) return;
                        const printWindow = window.open("", "_blank");
                        printWindow.document.write(
                            "<html><head><title>Print</title></head><body>" +
                                marked.parse(file.content) +
                                "</body></html>",
                        );
                        printWindow.document.close();
                        printWindow.focus();
                        printWindow.print();
                        printWindow.close();
                    }

                    exportToHTML() {
                        const file = this.files.get(this.activeFileId);
                        if (!file || !file.name.endsWith(".md")) return;
                        const htmlContent =
                            "<!DOCTYPE html><html><head><title>" +
                            file.name +
                            "</title></head><body>" +
                            marked.parse(file.content) +
                            "</body></html>";
                        const blob = new Blob([htmlContent], {
                            type: "text/html",
                        });
                        const a = document.createElement("a");
                        a.href = URL.createObjectURL(blob);
                        a.download = file.name.replace(/\.md$/, ".html");
                        a.click();
                        URL.revokeObjectURL(a.href);
                    }

                    showSettingsModal() {
                        this.updateSettingsModal();
                        this.settingsModal.style.display = "block";
                    }
                    closeSettingsModal() {
                        this.settingsModal.style.display = "none";
                    }

                    showHelpModal() {
                        this.helpModal.style.display = "block";
                    }
                    closeHelpModal() {
                        this.helpModal.style.display = "none";
                    }

                    showCollabModal() {
                        this.collabModal.style.display = "block";
                    }
                    closeCollabModal() {
                        this.collabModal.style.display = "none";
                    }

                    showExpanderModal() {
                        this.expanderModal.style.display = "block";
                    }
                    closeExpanderModal() {
                        document.getElementById("expanderTrigger").value = "";
                        document.getElementById("expanderText").value = "";
                        this.expanderModal.style.display = "none";
                    }

                    addExpander() {
                        const trigger = document
                            .getElementById("expanderTrigger")
                            .value.trim();
                        const text =
                            document.getElementById("expanderText").value;
                        if (trigger && text) {
                            const expanders = new Map(this.settings.expanders);
                            expanders.set(trigger, text);
                            this.settings.expanders = Array.from(
                                expanders.entries(),
                            );
                            this.saveSettings();
                            this.updateSettingsModal();
                            this.closeExpanderModal();
                        }
                    }

                    updateSettingsModal() {
                        // Update expanders list
                        const listEl = document.getElementById(
                            "settingsExpandersList",
                        );
                        listEl.innerHTML = "";
                        const expanders = new Map(this.settings.expanders);

                        if (expanders.size === 0) {
                            const placeholder = document.createElement("div");
                            placeholder.className = "expander-placeholder";
                            placeholder.textContent =
                                "No text expanders have been added yet.";
                            listEl.appendChild(placeholder);
                        } else {
                            expanders.forEach((text, trigger) => {
                                const item = document.createElement("div");
                                item.className = "expander-item";
                                const textContainer =
                                    document.createElement("div");
                                textContainer.className =
                                    "expander-text-container";
                                const triggerSpan =
                                    document.createElement("span");
                                triggerSpan.className = "expander-trigger";
                                triggerSpan.textContent = trigger;
                                const arrowSpan =
                                    document.createElement("span");
                                arrowSpan.className = "expander-arrow";
                                arrowSpan.textContent = "→";
                                const replacementSpan =
                                    document.createElement("span");
                                replacementSpan.className =
                                    "expander-replacement";
                                replacementSpan.textContent = text;
                                textContainer.appendChild(triggerSpan);
                                textContainer.appendChild(arrowSpan);
                                textContainer.appendChild(replacementSpan);
                                const deleteSpan =
                                    document.createElement("span");
                                deleteSpan.className = "delete-expander";
                                deleteSpan.textContent = "🗑️ Delete";
                                deleteSpan.dataset.trigger = trigger;
                                item.appendChild(textContainer);
                                item.appendChild(deleteSpan);
                                listEl.appendChild(item);
                            });
                        }

                        // Update button visibility checkboxes
                        const buttonSettingsEl = document.getElementById(
                            "buttonVisibilitySettings",
                        );
                        buttonSettingsEl.innerHTML = "";
                        for (const btnId in this.settings.buttons) {
                            const btn = document.getElementById(btnId);
                            if (btn) {
                                const label = document.createElement("label");
                                label.className = "button-toggle";
                                const checkbox =
                                    document.createElement("input");
                                checkbox.type = "checkbox";
                                checkbox.checked = this.settings.buttons[btnId];
                                checkbox.dataset.btnId = btnId;
                                checkbox.addEventListener("change", (e) => {
                                    this.settings.buttons[
                                        e.target.dataset.btnId
                                    ] = e.target.checked;
                                    this.saveSettings();
                                    this.applySettings();
                                });
                                label.appendChild(checkbox);
                                label.appendChild(
                                    document.createTextNode(
                                        btn.textContent.trim(),
                                    ),
                                );
                                buttonSettingsEl.appendChild(label);
                            }
                        }
                    }

                    applySettings() {
                        for (const btnId in this.settings.buttons) {
                            const btn = document.getElementById(btnId);
                            if (btn) {
                                // Special handling for conditional buttons
                                if (
                                    [
                                        "previewBtn",
                                        "gridModeBtn",
                                        "pdfBtn",
                                        "htmlBtn",
                                    ].includes(btnId)
                                ) {
                                    // Their visibility is handled by updateToolbarButtons
                                    continue;
                                }
                                btn.style.display = this.settings.buttons[btnId]
                                    ? "flex"
                                    : "none";
                            }
                        }
                        // Re-evaluate conditional buttons based on the current file
                        const currentFile = this.files.get(this.activeFileId);
                        if (currentFile) {
                            this.updateToolbarButtons(currentFile);
                        }
                    }

                    saveSettings() {
                        try {
                            localStorage.setItem(
                                "editr_settings",
                                JSON.stringify(this.settings),
                            );
                        } catch (e) {
                            console.error(
                                "Failed to save settings to localStorage:",
                                e,
                            );
                        }
                    }

                    loadSettings() {
                        try {
                            const data = localStorage.getItem("editr_settings");
                            if (data) {
                                const loadedSettings = JSON.parse(data);
                                // Merge loaded settings with defaults to ensure new settings are not missed
                                this.settings.expanders =
                                    loadedSettings.expanders || [];
                                Object.assign(
                                    this.settings.buttons,
                                    loadedSettings.buttons,
                                );
                            }
                        } catch (e) {
                            console.error(
                                "Failed to load settings from localStorage:",
                                e,
                            );
                        }
                    }

                    exportSettings() {
                        if (
                            this.settings.expanders.length === 0 &&
                            Object.values(this.settings.buttons).every((v) => v)
                        ) {
                            alert("No custom settings to export.");
                            return;
                        }

                        const content = JSON.stringify(this.settings, null, 2);
                        const blob = new Blob([content], {
                            type: "application/json;charset=utf-8",
                        });
                        const a = document.createElement("a");
                        a.href = URL.createObjectURL(blob);
                        a.download = "editr-settings.json";
                        a.style.display = "none";
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(a.href);
                    }

                    importSettings() {
                        const input = document.createElement("input");
                        input.type = "file";
                        input.accept = ".json,application/json";
                        input.onchange = (e) => {
                            const file = e.target.files[0];
                            if (!file) return;

                            const reader = new FileReader();
                            reader.onload = (e) => {
                                try {
                                    const importedData = JSON.parse(
                                        e.target.result,
                                    );
                                    if (
                                        confirm(
                                            "This will overwrite your current settings. Continue?",
                                        )
                                    ) {
                                        this.settings.expanders =
                                            importedData.expanders || [];
                                        Object.assign(
                                            this.settings.buttons,
                                            importedData.buttons,
                                        );
                                        this.saveSettings();
                                        this.applySettings();
                                        this.updateSettingsModal();
                                        alert(
                                            "Settings imported successfully.",
                                        );
                                    }
                                } catch (err) {
                                    alert("Invalid settings file.");
                                    console.error(
                                        "Failed to parse settings file:",
                                        err,
                                    );
                                }
                            };
                            reader.onerror = () => {
                                alert("Error reading file.");
                            };
                            reader.readAsText(file);
                        };
                        input.click();
                    }

                    // --- WebRTC Collaboration Methods ---

                    async startCollaboration() {
                        this.updateCollabStatus("connecting", "Connecting...");
                        const configuration = {
                            iceServers: [
                                { urls: "stun:stun.l.google.com:19302" },
                            ],
                        };
                        this.peerConnection = new RTCPeerConnection(
                            configuration,
                        );

                        this.peerConnection.onicecandidate = (event) => {
                            if (event.candidate) {
                                document.getElementById(
                                    "collabOfferOutput",
                                ).value = JSON.stringify(
                                    this.peerConnection.localDescription,
                                );
                            }
                        };

                        this.dataChannel =
                            this.peerConnection.createDataChannel(
                                "text-editor",
                            );
                        this.setupDataChannel();

                        const offer = await this.peerConnection.createOffer();
                        await this.peerConnection.setLocalDescription(offer);

                        document.getElementById("collabOfferOutput").value =
                            JSON.stringify(offer);
                    }

                    async handleOfferPaste(event) {
                        const offerText = event.clipboardData.getData("text");
                        document.getElementById("collabOfferInput").value =
                            offerText;

                        this.updateCollabStatus("connecting", "Connecting...");
                        const configuration = {
                            iceServers: [
                                { urls: "stun:stun.l.google.com:19302" },
                            ],
                        };
                        this.peerConnection = new RTCPeerConnection(
                            configuration,
                        );

                        this.peerConnection.onicecandidate = (event) => {
                            if (event.candidate) {
                                document.getElementById(
                                    "collabAnswerOutput",
                                ).value = JSON.stringify(
                                    this.peerConnection.localDescription,
                                );
                            }
                        };

                        this.peerConnection.ondatachannel = (event) => {
                            this.dataChannel = event.channel;
                            this.setupDataChannel();
                        };

                        const offer = JSON.parse(offerText);
                        await this.peerConnection.setRemoteDescription(
                            new RTCSessionDescription(offer),
                        );

                        const answer = await this.peerConnection.createAnswer();
                        await this.peerConnection.setLocalDescription(answer);

                        document.getElementById("collabAnswerOutput").value =
                            JSON.stringify(answer);
                    }

                    async handleAnswerPaste(event) {
                        const answerText = event.clipboardData.getData("text");
                        document.getElementById("collabAnswerInput").value =
                            answerText;
                        const answer = JSON.parse(answerText);
                        if (
                            this.peerConnection &&
                            !this.peerConnection.currentRemoteDescription
                        ) {
                            await this.peerConnection.setRemoteDescription(
                                new RTCSessionDescription(answer),
                            );
                        }
                    }

                    setupDataChannel() {
                        this.dataChannel.onopen = () => {
                            this.updateCollabStatus("connected", "Connected");
                            document.getElementById(
                                "disconnectCollabBtn",
                            ).style.display = "flex";
                            // Sync initial content
                            this.dataChannel.send(this.editorEl.value);
                        };
                        this.dataChannel.onclose = () => {
                            this.updateCollabStatus(
                                "disconnected",
                                "Disconnected",
                            );
                            document.getElementById(
                                "disconnectCollabBtn",
                            ).style.display = "none";
                        };
                        this.dataChannel.onmessage = (event) => {
                            this.isUpdatingFromPeer = true;
                            const cursorPosition = this.editorEl.selectionStart;
                            this.editorEl.value = event.data;
                            this.editorEl.selectionStart =
                                this.editorEl.selectionEnd = cursorPosition;
                            this.handleEditorInput(); // To update file state and UI
                            this.isUpdatingFromPeer = false;
                        };
                    }

                    disconnectCollaboration() {
                        if (this.dataChannel) this.dataChannel.close();
                        if (this.peerConnection) this.peerConnection.close();
                        this.peerConnection = null;
                        this.dataChannel = null;
                        this.updateCollabStatus("disconnected", "Disconnected");
                        document.getElementById(
                            "disconnectCollabBtn",
                        ).style.display = "none";
                        document.getElementById("collabOfferOutput").value = "";
                        document.getElementById("collabAnswerInput").value = "";
                        document.getElementById("collabOfferInput").value = "";
                        document.getElementById("collabAnswerOutput").value =
                            "";
                    }

                    updateCollabStatus(statusClass, statusText) {
                        const statusEl =
                            document.getElementById("collabStatus");
                        statusEl.className = statusClass;
                        statusEl.textContent = statusText;
                    }
                }
                new TextEditor();
            });
        </script>
    </body>
</html>
