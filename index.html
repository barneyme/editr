<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>editr</title>
        <link
            rel="icon"
            href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjMDAwMDAwIi8+Cjx0ZXh0IHg9IjE2IiB5PSIyMiIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE4IiBmb250LXdlaWdodD0iNDAwIiBmaWxsPSIjZmZmZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5lPC90ZXh0Pgo8L3N2Zz4K"
            type="image/svg+xml"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Oxygen, Ubuntu, Cantarell, sans-serif;
                background: #1e1e1e;
                color: #e0e0e0;
                height: 100vh;
                overflow: hidden;
            }
            .header {
                background: #2d2d30;
                border-bottom: 1px solid #3e3e42;
                padding: 8px 16px;
                display: flex;
                align-items: center;
                gap: 12px;
            }
            .logo {
                font-weight: 600;
                color: #2563eb;
            }
            .toolbar {
                display: flex;
                gap: 8px;
                align-items: center;
            }
            .btn {
                background: #3c3c3c;
                border: 1px solid #555;
                color: #e0e0e0;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
            }
            .main-container {
                display: flex;
                height: calc(100vh - 50px);
            }
            .content-area {
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            .editor-container {
                flex: 1;
                display: flex;
            }
            .editor-wrapper {
                flex: 1;
                position: relative;
            }
            .tabs-container {
                background: #2d2d30;
                border-bottom: 1px solid #3e3e42;
                display: flex;
                overflow-x: auto;
                min-height: 36px;
            }
            .tab {
                display: flex;
                align-items: center;
                padding: 8px 8px 8px 16px;
                border-right: 1px solid #3e3e42;
                cursor: pointer;
                font-size: 13px;
                white-space: nowrap;
                background: #1e1e1e;
                color: #cccccc;
                gap: 8px;
            }
            .tab.active {
                background: #1e1e1e;
                color: #ffffff;
                border-bottom: 2px solid #2563eb;
            }
            .close-tab-btn {
                font-family: Arial, sans-serif;
                font-weight: bold;
                padding: 0px 5px 2px 5px;
                border-radius: 4px;
                line-height: 16px;
                font-size: 16px;
            }
            .close-tab-btn:hover {
                background-color: #3e3e42;
            }
            .editor {
                width: 100%;
                height: 100%;
                border: none;
                background: #1e1e1e;
                color: #e0e0e0;
                font-family: "Courier New", Monaco, "Lucida Console", monospace;
                font-size: 14px;
                padding: 16px;
                resize: none;
                outline: none;
            }
            .preview-pane {
                width: 50%;
                background: #ffffff;
                color: #333;
                overflow-y: auto;
                padding: 16px;
                border-left: 1px solid #3e3e42;
                display: none;
            }
            .preview-pane.active {
                display: block;
            }
            .csv-grid-container {
                width: 100%;
                height: 100%;
                overflow: auto;
                background: #1e1e1e;
                display: none;
                position: relative;
            }
            .grid-mode-active .editor {
                display: none;
            }
            .grid-mode-active .csv-grid-container {
                display: block;
            }
            .csv-grid {
                width: 100%;
                border-collapse: collapse;
                font-size: 12px;
            }
            .csv-grid th,
            .csv-grid td {
                border: 1px solid #3e3e42;
                padding: 0;
                text-align: left;
                position: relative;
            }
            .csv-grid th {
                background: #2d2d30;
                font-weight: 600;
                padding: 4px 8px;
            }
            .csv-grid-input {
                width: 100%;
                height: 100%;
                background: transparent;
                border: none;
                color: inherit;
                font: inherit;
                padding: 4px 8px;
                outline: none;
                min-height: 24px;
            }
            .csv-grid-input:focus {
                background-color: #3c3c3c;
            }
            .csv-grid-controls {
                position: absolute;
                top: 0;
                right: 0;
                background: #2d2d30;
                border: 1px solid #3e3e42;
                border-radius: 4px;
                padding: 8px;
                display: none;
                z-index: 100;
            }
            .csv-grid-controls.active {
                display: block;
            }
            .csv-grid-controls button {
                background: #3c3c3c;
                border: 1px solid #555;
                color: #e0e0e0;
                padding: 4px 8px;
                border-radius: 2px;
                cursor: pointer;
                font-size: 11px;
                margin: 2px;
            }
            .csv-grid-controls button:hover {
                background: #4a4a4a;
            }
            .grid-header-controls {
                position: relative;
            }
            .header-menu-btn {
                position: absolute;
                right: 2px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                color: #888;
                cursor: pointer;
                font-size: 10px;
                opacity: 0;
            }
            .csv-grid th:hover .header-menu-btn {
                opacity: 1;
            }
            .status-bar {
                background: #2d2d30;
                border-top: 1px solid #3e3e42;
                padding: 4px 16px;
                font-size: 11px;
                color: #cccccc;
                display: flex;
                justify-content: space-between;
            }
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
            }
            .modal-content {
                background: #2d2d30;
                margin: 10% auto;
                padding: 20px;
                border: 1px solid #3e3e42;
                border-radius: 6px;
                width: 400px;
                color: #e0e0e0;
            }
            .input-group {
                margin-bottom: 12px;
            }
            .input-group label {
                display: block;
                margin-bottom: 4px;
            }
            .input-group input,
            .input-group textarea {
                width: 100%;
                padding: 8px;
                background: #1e1e1e;
                border: 1px solid #555;
                color: #e0e0e0;
            }
            .modal-buttons {
                display: flex;
                gap: 8px;
                justify-content: flex-end;
                margin-top: 16px;
            }
            .expander-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 4px 8px;
                background: #252526;
            }
            .delete-expander {
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="logo">editr</div>
            <div class="toolbar">
                <button class="btn" id="newFileBtn">New</button>
                <button class="btn" id="openFileBtn">Open</button>
                <button class="btn" id="saveFileBtn">Save</button>
                <button class="btn" id="saveAsFileBtn">Save As</button>
                <button class="btn" id="previewBtn" style="display: none">
                    Preview
                </button>
                <button class="btn" id="gridModeBtn" style="display: none">
                    Grid
                </button>
                <button class="btn" id="pdfBtn" style="display: none">
                    PDF
                </button>
                <button class="btn" id="htmlBtn" style="display: none">
                    HTML
                </button>
                <button class="btn" id="settingsBtn">Text</button>
            </div>
        </div>
        <div class="main-container">
            <div class="content-area">
                <div class="tabs-container" id="tabsContainer"></div>
                <div class="editor-container" id="editorContainer">
                    <div class="editor-wrapper" id="editorWrapper">
                        <textarea class="editor" id="editor"></textarea>
                        <div class="csv-grid-container" id="csvGridContainer">
                            <div class="csv-grid-controls" id="csvGridControls">
                                <button id="addRowBtn">Add Row</button>
                                <button id="addColBtn">Add Column</button>
                                <button id="deleteRowBtn">Delete Row</button>
                                <button id="deleteColBtn">Delete Column</button>
                            </div>
                            <table class="csv-grid" id="csvGrid"></table>
                        </div>
                    </div>
                    <div class="preview-pane" id="previewPane"></div>
                </div>
            </div>
        </div>
        <div class="status-bar">
            <span id="statusText">Ready</span>
            <span id="cursorPosition">Ln 1, Col 1</span>
        </div>
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <h3>Text Expanders</h3>
                <div id="settingsExpandersList"></div>
                <button class="btn" id="addExpanderBtn">Add</button>
                <button class="btn" id="importExpandersBtn">Import</button>
                <button class="btn" id="exportExpandersBtn">Export</button>
                <div class="modal-buttons">
                    <button class="btn" id="closeSettingsBtn">Close</button>
                </div>
            </div>
        </div>
        <div id="expanderModal" class="modal">
            <div class="modal-content">
                <h3>Add Text Expander</h3>
                <div class="input-group">
                    <label for="expanderTrigger">Trigger</label
                    ><input type="text" id="expanderTrigger" />
                </div>
                <div class="input-group">
                    <label for="expanderText">Replacement Text</label
                    ><textarea id="expanderText"></textarea>
                </div>
                <h4>Dynamic Variables:</h4>
                <code>{date}</code> <code>{time}</code> <code>{datetime}</code>
                <code>{timestamp}</code>
                <div class="modal-buttons">
                    <button class="btn" id="cancelExpanderBtn">Cancel</button
                    ><button class="btn" id="expanderSaveBtn">Add</button>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                class TextEditor {
                    constructor() {
                        this.files = new Map();
                        this.activeFileId = null;
                        this.expanders = new Map();
                        this.nextFileId = 1;
                        this.isPreviewActive = false;
                        this.isGridActive = false;
                        this.currentGridRow = 0;
                        this.currentGridCol = 0;
                        this.isInitializingGrid = false;
                        this.isSwitchingFile = false; // Prevents save prompt on open

                        this.editorEl = document.getElementById("editor");
                        this.tabsContainerEl =
                            document.getElementById("tabsContainer");
                        this.statusTextEl =
                            document.getElementById("statusText");
                        this.cursorPositionEl =
                            document.getElementById("cursorPosition");
                        this.settingsModal =
                            document.getElementById("settingsModal");
                        this.expanderModal =
                            document.getElementById("expanderModal");
                        this.previewPane =
                            document.getElementById("previewPane");
                        this.editorWrapper =
                            document.getElementById("editorWrapper");
                        this.csvGrid = document.getElementById("csvGrid");
                        this.csvGridControls =
                            document.getElementById("csvGridControls");

                        this.previewBtn = document.getElementById("previewBtn");
                        this.gridModeBtn =
                            document.getElementById("gridModeBtn");
                        this.pdfBtn = document.getElementById("pdfBtn");
                        this.htmlBtn = document.getElementById("htmlBtn");

                        this.init();
                    }

                    init() {
                        this.setupEventListeners();
                        this.loadExpanders();
                        this.createNewFile();
                    }

                    setupEventListeners() {
                        document
                            .getElementById("newFileBtn")
                            .addEventListener("click", () =>
                                this.createNewFile(),
                            );
                        document
                            .getElementById("openFileBtn")
                            .addEventListener("click", () => this.openFile());
                        document
                            .getElementById("saveFileBtn")
                            .addEventListener("click", () => this.saveFile());
                        document
                            .getElementById("saveAsFileBtn")
                            .addEventListener("click", () => this.saveAsFile());
                        document
                            .getElementById("settingsBtn")
                            .addEventListener("click", () =>
                                this.showSettingsModal(),
                            );

                        this.previewBtn.addEventListener("click", () =>
                            this.togglePreview(),
                        );
                        this.gridModeBtn.addEventListener("click", () =>
                            this.toggleGridMode(),
                        );
                        this.pdfBtn.addEventListener("click", () =>
                            this.exportToPDF(),
                        );
                        this.htmlBtn.addEventListener("click", () =>
                            this.exportToHTML(),
                        );

                        // Handle tab switching and closing
                        this.tabsContainerEl.addEventListener("click", (e) => {
                            const tab = e.target.closest(".tab");
                            if (!tab) return;

                            const fileId = tab.dataset.fileId;
                            if (e.target.classList.contains("close-tab-btn")) {
                                e.stopPropagation();
                                this.closeFile(fileId);
                            } else {
                                this.switchToFile(fileId);
                            }
                        });

                        // CSV Grid controls
                        document
                            .getElementById("addRowBtn")
                            .addEventListener("click", () => this.addGridRow());
                        document
                            .getElementById("addColBtn")
                            .addEventListener("click", () =>
                                this.addGridColumn(),
                            );
                        document
                            .getElementById("deleteRowBtn")
                            .addEventListener("click", () =>
                                this.deleteGridRow(),
                            );
                        document
                            .getElementById("deleteColBtn")
                            .addEventListener("click", () =>
                                this.deleteGridColumn(),
                            );

                        document
                            .getElementById("closeSettingsBtn")
                            .addEventListener("click", () =>
                                this.closeSettingsModal(),
                            );
                        document
                            .getElementById("addExpanderBtn")
                            .addEventListener("click", () =>
                                this.showExpanderModal(),
                            );
                        document
                            .getElementById("importExpandersBtn")
                            .addEventListener("click", () =>
                                this.importExpanders(),
                            );
                        document
                            .getElementById("exportExpandersBtn")
                            .addEventListener("click", () =>
                                this.exportExpanders(),
                            );
                        document
                            .getElementById("cancelExpanderBtn")
                            .addEventListener("click", () =>
                                this.closeExpanderModal(),
                            );
                        document
                            .getElementById("expanderSaveBtn")
                            .addEventListener("click", () =>
                                this.addExpander(),
                            );

                        this.editorEl.addEventListener("input", () =>
                            this.handleEditorInput(),
                        );
                        this.editorEl.addEventListener("keyup", () =>
                            this.updateStatusBar(),
                        );
                        this.editorEl.addEventListener("click", () =>
                            this.updateStatusBar(),
                        );

                        // Show/hide grid controls on right-click
                        document.addEventListener("contextmenu", (e) => {
                            if (
                                this.isGridActive &&
                                e.target.closest(".csv-grid-container")
                            ) {
                                e.preventDefault();
                                this.showGridControls(e.clientX, e.clientY);
                            } else {
                                this.hideGridControls();
                            }
                        });

                        document.addEventListener("click", (e) => {
                            if (!e.target.closest(".csv-grid-controls")) {
                                this.hideGridControls();
                            }
                        });

                        // Event delegation for deleting expanders
                        document
                            .getElementById("settingsExpandersList")
                            .addEventListener("click", (e) => {
                                if (
                                    e.target.classList.contains(
                                        "delete-expander",
                                    )
                                ) {
                                    const trigger = e.target.dataset.trigger;
                                    if (trigger) {
                                        this.expanders.delete(trigger);
                                        this.saveExpanders();
                                        this.updateSettingsExpandersList();
                                    }
                                }
                            });
                    }

                    closeFile(fileIdToClose) {
                        const fileToClose = this.files.get(fileIdToClose);
                        if (!fileToClose) return;

                        this.files.delete(fileIdToClose);

                        if (this.activeFileId === fileIdToClose) {
                            if (this.files.size > 0) {
                                const nextFileId = this.files
                                    .keys()
                                    .next().value;
                                this.switchToFile(nextFileId);
                            } else {
                                this.createNewFile();
                            }
                        } else {
                            this.renderTabs();
                        }
                    }

                    togglePreview() {
                        this.isPreviewActive = !this.isPreviewActive;
                        this.previewPane.classList.toggle(
                            "active",
                            this.isPreviewActive,
                        );
                        if (this.isPreviewActive) this.updatePreview();
                    }

                    updatePreview() {
                        const file = this.files.get(this.activeFileId);
                        if (file && this.isPreviewActive)
                            this.previewPane.innerHTML = marked.parse(
                                file.content,
                            );
                    }

                    toggleGridMode() {
                        this.isGridActive = !this.isGridActive;
                        this.editorWrapper.classList.toggle(
                            "grid-mode-active",
                            this.isGridActive,
                        );
                        if (this.isGridActive) {
                            this.isInitializingGrid = true;
                            this.renderCsvGrid();
                            this.isInitializingGrid = false;
                        }
                    }

                    renderCsvGrid() {
                        const file = this.files.get(this.activeFileId);
                        if (!file) return;

                        const lines = file.content
                            .split("\n")
                            .filter((line) => line.trim());
                        const data = lines.map((line) => line.split(","));

                        if (data.length === 0) {
                            data.push(["Column 1", "Column 2", "Column 3"]);
                            data.push(["", "", ""]);
                        }

                        let tableHTML = "<thead><tr>";
                        data[0].forEach((header, index) => {
                            tableHTML += `<th class="grid-header-controls">${header}<button class="header-menu-btn" data-col="${index}">⋮</button></th>`;
                        });
                        tableHTML += "</tr></thead><tbody>";

                        data.slice(1).forEach((row, rowIndex) => {
                            tableHTML += "<tr>";
                            row.forEach((cell, colIndex) => {
                                tableHTML += `<td><input type="text" class="csv-grid-input" value="${cell}" data-row="${rowIndex}" data-col="${colIndex}"></td>`;
                            });
                            tableHTML += "</tr>";
                        });
                        this.csvGrid.innerHTML = tableHTML + "</tbody>";

                        this.setupGridNavigation();
                    }

                    setupGridNavigation() {
                        const inputs =
                            this.csvGrid.querySelectorAll(".csv-grid-input");

                        inputs.forEach((input) => {
                            input.addEventListener("input", (e) => {
                                if (!this.isInitializingGrid) {
                                    this.updateCsvFromGrid(e);
                                }
                            });
                            input.addEventListener("focus", (e) => {
                                this.currentGridRow = parseInt(
                                    e.target.dataset.row,
                                );
                                this.currentGridCol = parseInt(
                                    e.target.dataset.col,
                                );
                            });

                            input.addEventListener("keydown", (e) => {
                                const row = parseInt(e.target.dataset.row);
                                const col = parseInt(e.target.dataset.col);

                                switch (e.key) {
                                    case "ArrowUp":
                                        e.preventDefault();
                                        this.navigateGrid(row - 1, col);
                                        break;
                                    case "ArrowDown":
                                    case "Enter":
                                        e.preventDefault();
                                        this.navigateGrid(row + 1, col);
                                        break;
                                    case "ArrowLeft":
                                        if (e.target.selectionStart === 0) {
                                            e.preventDefault();
                                            this.navigateGrid(row, col - 1);
                                        }
                                        break;
                                    case "ArrowRight":
                                    case "Tab":
                                        if (
                                            e.key === "ArrowRight" &&
                                            e.target.selectionEnd ===
                                                e.target.value.length
                                        ) {
                                            e.preventDefault();
                                            this.navigateGrid(row, col + 1);
                                        } else if (e.key === "Tab") {
                                            e.preventDefault();
                                            this.navigateGrid(row, col + 1);
                                        }
                                        break;
                                    case "Delete":
                                        if (e.ctrlKey || e.metaKey) {
                                            e.preventDefault();
                                            if (e.shiftKey) {
                                                this.deleteGridColumn(col);
                                            } else {
                                                this.deleteGridRow(row);
                                            }
                                        }
                                        break;
                                    case "Insert":
                                        e.preventDefault();
                                        if (e.shiftKey) {
                                            this.addGridColumn(col);
                                        } else {
                                            this.addGridRow(row + 1);
                                        }
                                        break;
                                }
                            });
                        });
                    }

                    navigateGrid(targetRow, targetCol) {
                        const input = this.csvGrid.querySelector(
                            `[data-row="${targetRow}"][data-col="${targetCol}"]`,
                        );
                        if (input) {
                            input.focus();
                            this.currentGridRow = targetRow;
                            this.currentGridCol = targetCol;
                        }
                    }

                    showGridControls(x, y) {
                        this.csvGridControls.style.left = x + "px";
                        this.csvGridControls.style.top = y + "px";
                        this.csvGridControls.classList.add("active");
                    }

                    hideGridControls() {
                        this.csvGridControls.classList.remove("active");
                    }

                    addGridRow(atIndex = null) {
                        const file = this.files.get(this.activeFileId);
                        if (!file) return;

                        const lines = file.content
                            .split("\n")
                            .filter((line) => line.trim());
                        const data = lines.map((line) => line.split(","));

                        const insertIndex =
                            atIndex !== null ? atIndex + 1 : data.length;
                        const newRow = new Array(data[0].length).fill("");
                        data.splice(insertIndex, 0, newRow);

                        file.content = data
                            .map((row) => row.join(","))
                            .join("\n");
                        file.modified = true;
                        this.editorEl.value = file.content;
                        this.renderCsvGrid();
                        this.renderTabs();
                    }

                    addGridColumn(atIndex = null) {
                        const file = this.files.get(this.activeFileId);
                        if (!file) return;

                        const lines = file.content
                            .split("\n")
                            .filter((line) => line.trim());
                        const data = lines.map((line) => line.split(","));

                        const insertIndex =
                            atIndex !== null ? atIndex + 1 : data[0].length;
                        data.forEach((row, rowIndex) => {
                            row.splice(
                                insertIndex,
                                0,
                                rowIndex === 0 ? "New Column" : "",
                            );
                        });

                        file.content = data
                            .map((row) => row.join(","))
                            .join("\n");
                        file.modified = true;
                        this.editorEl.value = file.content;
                        this.renderCsvGrid();
                        this.renderTabs();
                    }

                    deleteGridRow(rowIndex = null) {
                        const file = this.files.get(this.activeFileId);
                        if (!file) return;

                        const lines = file.content
                            .split("\n")
                            .filter((line) => line.trim());
                        const data = lines.map((line) => line.split(","));

                        if (data.length <= 2) return; // Keep at least header + 1 row

                        const deleteIndex =
                            rowIndex !== null
                                ? rowIndex + 1
                                : this.currentGridRow + 1;
                        data.splice(deleteIndex, 1);

                        file.content = data
                            .map((row) => row.join(","))
                            .join("\n");
                        file.modified = true;
                        this.editorEl.value = file.content;
                        this.renderCsvGrid();
                        this.renderTabs();
                        this.hideGridControls();
                    }

                    deleteGridColumn(colIndex = null) {
                        const file = this.files.get(this.activeFileId);
                        if (!file) return;

                        const lines = file.content
                            .split("\n")
                            .filter((line) => line.trim());
                        const data = lines.map((line) => line.split(","));

                        if (data[0].length <= 1) return; // Keep at least 1 column

                        const deleteIndex =
                            colIndex !== null ? colIndex : this.currentGridCol;
                        data.forEach((row) => {
                            row.splice(deleteIndex, 1);
                        });

                        file.content = data
                            .map((row) => row.join(","))
                            .join("\n");
                        file.modified = true;
                        this.editorEl.value = file.content;
                        this.renderCsvGrid();
                        this.renderTabs();
                        this.hideGridControls();
                    }

                    updateCsvFromGrid() {
                        const inputs =
                            this.csvGrid.querySelectorAll(".csv-grid-input");
                        const headers = Array.from(
                            this.csvGrid.querySelectorAll("th"),
                        ).map((th) => th.textContent.replace("⋮", ""));

                        let newContent = headers.join(",") + "\n";

                        const rows = Array.from(
                            this.csvGrid.querySelectorAll("tbody tr"),
                        );
                        rows.forEach((row) => {
                            const cells = Array.from(
                                row.querySelectorAll(".csv-grid-input"),
                            ).map((input) => input.value);
                            newContent += cells.join(",") + "\n";
                        });

                        const file = this.files.get(this.activeFileId);
                        if (file) {
                            file.content = newContent.trim();
                            file.modified = true;
                            this.editorEl.value = file.content;
                            this.renderTabs();
                        }
                    }

                    updateToolbarButtons(file) {
                        const isMarkdown = file.name.endsWith(".md");
                        const isCsv = file.name.endsWith(".csv");
                        this.previewBtn.style.display = isMarkdown
                            ? "inline-block"
                            : "none";
                        this.pdfBtn.style.display = isMarkdown
                            ? "inline-block"
                            : "none";
                        this.htmlBtn.style.display = isMarkdown
                            ? "inline-block"
                            : "none";
                        this.gridModeBtn.style.display = isCsv
                            ? "inline-block"
                            : "none";
                    }

                    switchToFile(fileId) {
                        this.isSwitchingFile = true;
                        this.activeFileId = fileId;
                        const file = this.files.get(fileId);
                        if (file) {
                            this.editorEl.value = file.content;
                            this.updateToolbarButtons(file);
                            this.isPreviewActive = false;
                            this.isGridActive = false;
                            this.previewPane.classList.remove("active");
                            this.editorWrapper.classList.remove(
                                "grid-mode-active",
                            );
                        }
                        this.renderTabs();
                        this.updateStatusBar();
                        this.isSwitchingFile = false;
                    }

                    createNewFile() {
                        const fileId = `file_${this.nextFileId++}`;
                        const file = {
                            id: fileId,
                            name: `untitled-${this.files.size + 1}.txt`,
                            content: "",
                            modified: false,
                        };
                        this.files.set(fileId, file);
                        this.switchToFile(fileId);
                    }

                    openFile() {
                        const input = document.createElement("input");
                        input.type = "file";
                        input.accept = ".txt,.md,.csv,.js,.html,.css,.json";
                        input.onchange = (e) => {
                            const file = e.target.files[0];
                            if (!file) return;
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const newFile = {
                                    id: `file_${this.nextFileId++}`,
                                    name: file.name,
                                    content: e.target.result,
                                    modified: false,
                                };
                                this.files.set(newFile.id, newFile);
                                this.switchToFile(newFile.id);
                            };
                            reader.readAsText(file);
                        };
                        input.click();
                    }

                    handleEditorInput() {
                        if (this.isSwitchingFile) return;
                        const file = this.files.get(this.activeFileId);
                        if (file) {
                            file.content = this.editorEl.value;
                            file.modified = true;
                            this.renderTabs();
                            this.checkTextExpanders();
                            if (this.isPreviewActive) this.updatePreview();
                            if (this.isGridActive && !this.isInitializingGrid) {
                                this.isInitializingGrid = true;
                                this.renderCsvGrid();
                                this.isInitializingGrid = false;
                            }
                        }
                        this.updateStatusBar();
                    }

                    checkTextExpanders() {
                        const cursorPos = this.editorEl.selectionStart;
                        const textBeforeCursor = this.editorEl.value.substring(
                            0,
                            cursorPos,
                        );
                        for (const [trigger, replacement] of this.expanders) {
                            if (textBeforeCursor.endsWith(trigger)) {
                                const expandedText =
                                    this.processExpansion(replacement);
                                this.editorEl.value =
                                    this.editorEl.value.substring(
                                        0,
                                        cursorPos - trigger.length,
                                    ) +
                                    expandedText +
                                    this.editorEl.value.substring(cursorPos);
                                this.editorEl.setSelectionRange(
                                    cursorPos -
                                        trigger.length +
                                        expandedText.length,
                                    cursorPos -
                                        trigger.length +
                                        expandedText.length,
                                );
                                this.handleEditorInput();
                                break;
                            }
                        }
                    }

                    processExpansion(text) {
                        const now = new Date();
                        return text
                            .replace(/\{date\}/g, now.toLocaleDateString())
                            .replace(/\{time\}/g, now.toLocaleTimeString())
                            .replace(/\{datetime\}/g, now.toLocaleString())
                            .replace(/\{timestamp\}/g, Date.now().toString());
                    }

                    saveFile() {
                        const file = this.files.get(this.activeFileId);
                        if (!file) return;
                        const blob = new Blob([file.content], {
                            type: "text/plain",
                        });
                        const a = document.createElement("a");
                        a.href = URL.createObjectURL(blob);
                        a.download = file.name;
                        a.click();
                        URL.revokeObjectURL(a.href);
                        file.modified = false;
                        this.renderTabs();
                    }

                    saveAsFile() {
                        this.saveFile();
                    }

                    renderTabs() {
                        this.tabsContainerEl.innerHTML = "";
                        this.files.forEach((file) => {
                            const tab = document.createElement("div");
                            tab.className = `tab ${file.id === this.activeFileId ? "active" : ""}`;
                            tab.dataset.fileId = file.id;

                            const fileName = document.createElement("span");
                            fileName.textContent =
                                file.name + (file.modified ? "*" : "");

                            const closeBtn = document.createElement("span");
                            closeBtn.className = "close-tab-btn";
                            closeBtn.textContent = "x";
                            closeBtn.title = "Close tab";

                            tab.appendChild(fileName);
                            tab.appendChild(closeBtn);
                            this.tabsContainerEl.appendChild(tab);
                        });
                    }

                    updateStatusBar() {
                        const file = this.files.get(this.activeFileId);
                        this.statusTextEl.textContent = file
                            ? file.name
                            : "Ready";
                        const pos = this.editorEl.selectionStart;
                        const text = this.editorEl.value.substring(0, pos);
                        const lines = text.split("\n");
                        this.cursorPositionEl.textContent = `Ln ${lines.length}, Col ${lines[lines.length - 1].length + 1}`;
                    }

                    exportToPDF() {
                        const file = this.files.get(this.activeFileId);
                        if (!file || !file.name.endsWith(".md")) return;
                        const printWindow = window.open("", "_blank");
                        printWindow.document.write(
                            "<html><head><title>Print</title></head><body>" +
                                marked.parse(file.content) +
                                "</body></html>",
                        );
                        printWindow.document.close();
                        printWindow.focus();
                        printWindow.print();
                        printWindow.close();
                    }

                    exportToHTML() {
                        const file = this.files.get(this.activeFileId);
                        if (!file || !file.name.endsWith(".md")) return;
                        const htmlContent =
                            "<!DOCTYPE html><html><head><title>" +
                            file.name +
                            "</title></head><body>" +
                            marked.parse(file.content) +
                            "</body></html>";
                        const blob = new Blob([htmlContent], {
                            type: "text/html",
                        });
                        const a = document.createElement("a");
                        a.href = URL.createObjectURL(blob);
                        a.download = file.name.replace(/\.md$/, ".html");
                        a.click();
                        URL.revokeObjectURL(a.href);
                    }

                    showSettingsModal() {
                        this.updateSettingsExpandersList();
                        this.settingsModal.style.display = "block";
                    }
                    closeSettingsModal() {
                        this.settingsModal.style.display = "none";
                    }
                    showExpanderModal() {
                        this.expanderModal.style.display = "block";
                    }
                    closeExpanderModal() {
                        document.getElementById("expanderTrigger").value = "";
                        document.getElementById("expanderText").value = "";
                        this.expanderModal.style.display = "none";
                    }

                    addExpander() {
                        const trigger = document
                            .getElementById("expanderTrigger")
                            .value.trim();
                        const text =
                            document.getElementById("expanderText").value;
                        if (trigger && text) {
                            this.expanders.set(trigger, text);
                            this.saveExpanders();
                            this.updateSettingsExpandersList();
                            this.closeExpanderModal();
                        }
                    }

                    updateSettingsExpandersList() {
                        const listEl = document.getElementById(
                            "settingsExpandersList",
                        );
                        listEl.innerHTML = ""; // Clear the list first

                        if (this.expanders.size === 0) {
                            listEl.textContent =
                                "No text expanders have been added yet.";
                            return;
                        }

                        this.expanders.forEach((text, trigger) => {
                            const item = document.createElement("div");
                            item.className = "expander-item";

                            const triggerSpan = document.createElement("span");
                            const triggerBold = document.createElement("b");
                            triggerBold.textContent = trigger;
                            triggerSpan.appendChild(triggerBold);

                            const deleteSpan = document.createElement("span");
                            deleteSpan.className = "delete-expander";
                            deleteSpan.textContent = "Delete";
                            deleteSpan.dataset.trigger = trigger;

                            item.appendChild(triggerSpan);
                            item.appendChild(deleteSpan);
                            listEl.appendChild(item);
                        });
                    }

                    saveExpanders() {
                        try {
                            localStorage.setItem(
                                "editr_expanders",
                                JSON.stringify(
                                    Array.from(this.expanders.entries()),
                                ),
                            );
                        } catch (e) {
                            console.error(
                                "Failed to save expanders to localStorage:",
                                e,
                            );
                        }
                    }

                    loadExpanders() {
                        try {
                            const data =
                                localStorage.getItem("editr_expanders");
                            if (data) {
                                this.expanders = new Map(JSON.parse(data));
                            }
                        } catch (e) {
                            console.error(
                                "Failed to load expanders from localStorage:",
                                e,
                            );
                            this.expanders = new Map();
                        }
                    }

                    exportExpanders() {
                        if (this.expanders.size === 0) {
                            alert("No text expanders to export.");
                            return;
                        }

                        const lines = [];
                        for (const [
                            trigger,
                            text,
                        ] of this.expanders.entries()) {
                            lines.push(`${trigger}=${text}`);
                        }
                        const content = lines.join("\n");

                        const blob = new Blob([content], {
                            type: "text/plain;charset=utf-8",
                        });
                        const a = document.createElement("a");
                        a.href = URL.createObjectURL(blob);
                        a.download = "editr-expanders.txt";
                        a.style.display = "none";
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(a.href);
                    }

                    importExpanders() {
                        const input = document.createElement("input");
                        input.type = "file";
                        input.accept = ".txt,text/plain";
                        input.onchange = (e) => {
                            const file = e.target.files[0];
                            if (!file) return;

                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const content = e.target.result;
                                const lines = content.split("\n");
                                let importedCount = 0;

                                if (
                                    !confirm(
                                        "This will merge imported expanders and overwrite any with the same trigger. Continue?",
                                    )
                                ) {
                                    return;
                                }

                                for (const line of lines) {
                                    const trimmedLine = line.trim();
                                    if (!trimmedLine) continue;

                                    const separatorIndex =
                                        trimmedLine.indexOf("=");
                                    if (separatorIndex > 0) {
                                        const trigger = trimmedLine
                                            .substring(0, separatorIndex)
                                            .trim();
                                        const text = trimmedLine.substring(
                                            separatorIndex + 1,
                                        );
                                        if (trigger) {
                                            this.expanders.set(trigger, text);
                                            importedCount++;
                                        }
                                    }
                                }

                                if (importedCount > 0) {
                                    this.saveExpanders();
                                    this.updateSettingsExpandersList();
                                    alert(
                                        `Successfully imported and merged ${importedCount} expander(s).`,
                                    );
                                } else {
                                    alert(
                                        "Could not find any valid expanders in the selected file. Ensure format is 'trigger=replacement'.",
                                    );
                                }
                            };
                            reader.onerror = () => {
                                alert("Error reading file.");
                            };
                            reader.readAsText(file);
                        };
                        input.click();
                    }
                }
                new TextEditor();
            });
        </script>
    </body>
</html>
