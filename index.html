<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>editr</title>

        <link rel="manifest" href="manifest.json" />

        <meta name="theme-color" content="#3d3d3d" />

        <link
            rel="icon"
            href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><rect width="16" height="16" fill="%23808080"/><text x="50%" y="55%" font-family="sans-serif" font-size="12" font-weight="bold" fill="white" text-anchor="middle" dominant-baseline="middle">e</text></svg>'
        />
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>

        <style>
            /* --- editr Base Styles --- */
            body,
            html {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
                font-family: "Inter", sans-serif;
                background-color: #2d2d2d; /* New Orange Theme background */
                transition: background-color 0.2s;
                color: #f0f0f0;
            }

            #editr-container {
                width: 100%;
                height: 100%;
                position: relative;
            }

            #line-indicator {
                position: absolute;
                top: 2rem;
                left: 0;
                width: 4px;
                height: 25.6px;
                background-color: #ffb74d; /* Light Orange */
                z-index: 1;
                transition: top 0.1s ease-out;
                opacity: 0.5;
                pointer-events: none;
            }

            #editor {
                width: 100%;
                height: 100%;
                padding: 2rem;
                border: none;
                outline: none;
                resize: none;
                background-color: transparent;
                color: #f8f8f2; /* <<< KEPT THIS COLOR AS REQUESTED */
                font-family: "Fira Code", "Courier New", monospace;
                font-size: 16px;
                line-height: 1.6;
                box-sizing: border-box;
            }

            body.dragover {
                background-color: #383838;
            }
            #editor {
                border: 2px dashed transparent;
                box-sizing: border-box;
            }
            body.dragover #editor {
                border-color: #ff9800; /* Main Orange */
            }

            #editor::placeholder {
                color: #888888; /* Subtle */
                opacity: 1;
            }

            /* --- Markdown Preview Styles --- */
            #markdown-preview {
                padding: 2rem 4rem;
                height: 100vh;
                overflow-y: auto;
                box-sizing: border-box;
                color: #f0f0f0;
                max-width: 800px;
                margin: 0 auto;
                line-height: 1.7;
            }
            #markdown-preview h1 {
                font-size: 2.5em;
                font-weight: 600;
                margin-top: 0;
                margin-bottom: 0.7em;
                color: #ff9800; /* Main Orange */
                border-bottom: 1px solid #888888;
                padding-bottom: 0.3em;
            }
            #markdown-preview h2 {
                font-size: 2em;
                font-weight: 600;
                margin-top: 1.5em;
                margin-bottom: 0.6em;
                color: #ff9800; /* Main Orange */
                border-bottom: 1px solid #888888;
                padding-bottom: 0.3em;
            }
            #markdown-preview h3 {
                font-size: 1.5em;
                font-weight: 600;
                margin-top: 1.5em;
                margin-bottom: 0.5em;
                color: #ff9800; /* Main Orange */
            }
            #markdown-preview h4 {
                font-size: 1.2em;
                font-weight: 600;
                margin-top: 1.5em;
                margin-bottom: 0.5em;
                color: #ff9800; /* Main Orange */
            }
            #markdown-preview p {
                margin-bottom: 1.2em;
            }
            #markdown-preview a {
                color: #ffb74d;
                text-decoration: none;
            } /* Light Orange */
            #markdown-preview a:hover {
                text-decoration: underline;
            }
            #markdown-preview code {
                background-color: #3d3d3d;
                padding: 0.2em 0.4em;
                border-radius: 4px;
                font-family: "Fira Code", monospace;
                font-size: 0.9em;
            }
            #markdown-preview pre {
                background-color: #262626;
                padding: 1em;
                border-radius: 5px;
                border: 1px solid #3d3d3d;
                overflow-x: auto;
                margin-bottom: 1.2em;
            }
            #markdown-preview pre code {
                background-color: transparent;
                padding: 0;
                font-size: 1em;
            }
            #markdown-preview blockquote {
                border-left: 4px solid #888888;
                padding-left: 1em;
                color: #a9b1d6;
                margin-left: 0;
                margin-bottom: 1.2em;
            }
            #markdown-preview ul,
            #markdown-preview ol {
                padding-left: 2em;
                margin-bottom: 1.2em;
            }
            #markdown-preview li {
                margin-bottom: 0.5em;
            }
            #markdown-preview table {
                border-collapse: collapse;
                width: 100%;
                margin: 1.5em 0;
            }
            #markdown-preview th,
            #markdown-preview td {
                border: 1px solid #888888;
                padding: 0.6em 0.8em;
            }
            #markdown-preview th {
                background-color: #3d3d3d;
                font-weight: 600;
            }
            #markdown-preview hr {
                border: 0;
                height: 1px;
                background-color: #888888;
                margin: 2.5em 0;
            }

            /* --- CSV Grid Styles --- */
            #csv-grid {
                padding: 2rem;
                height: 100vh;
                overflow: auto;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
            }
            #csv-grid-table-container {
                flex-grow: 1;
                overflow: auto;
            }
            #csv-grid table {
                width: 100%;
                border-collapse: collapse;
                font-family: "Fira Code", monospace;
                font-size: 14px;
            }
            #csv-grid th,
            #csv-grid td {
                border: 1px solid #3d3d3d;
                padding: 8px 12px;
                text-align: left;
                white-space: nowrap;
            }
            #csv-grid thead {
                background-color: #3d3d3d;
                color: #f0f0f0;
                position: sticky;
                top: 0;
                z-index: 10;
            }
            #csv-grid tbody tr:nth-child(even) {
                background-color: #383838;
            }
            #csv-grid td[contenteditable="true"],
            #csv-grid th span[contenteditable="true"] {
                background-color: #2d2d2d;
                outline: none;
            }
            #csv-grid td[contenteditable="true"]:focus,
            #csv-grid th span[contenteditable="true"]:focus {
                background-color: #3d3d3d;
                outline: 2px solid #ff9800;
                box-shadow: 0 0 0 2px #2d2d2d;
            }
            .csv-action-btn {
                background: none;
                border: none;
                cursor: pointer;
                padding: 2px;
                font-size: 14px;
                color: #ff5555;
                opacity: 0.5;
                transition: opacity 0.2s;
            }
            .csv-action-btn:hover {
                opacity: 1;
            }
            #csv-grid th .csv-action-btn {
                color: #ff9800; /* Main Orange */
            }
            #csv-controls {
                padding-top: 1rem;
                flex-shrink: 0;
                display: flex;
                gap: 0.5rem;
            }

            #top-right-container {
                position: fixed;
                top: 16px;
                right: 24px;
                display: flex;
                align-items: center;
                gap: 16px;
                z-index: 1001;
            }

            #menu-trigger {
                width: 24px;
                height: 24px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 4px;
                transition: background-color 0.2s;
            }

            #menu-trigger:hover {
                background-color: rgba(255, 255, 255, 0.1);
            }

            #context-menu {
                position: fixed;
                display: none;
                z-index: 1000;
                background-color: #3d3d3d;
                border: 1px solid #888888;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                min-width: 180px;
                padding: 8px 0;
            }

            .menu-item {
                padding: 10px 20px;
                cursor: pointer;
                color: #f0f0f0;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 14px;
            }

            .menu-item:hover {
                background-color: #888888;
            }

            .menu-item .shortcut {
                color: #ff9800; /* Main Orange */
                font-size: 12px;
            }

            .menu-item .view-btn {
                padding: 4px 10px;
                border: 1px solid #888888;
                border-radius: 4px;
                background-color: transparent;
                color: #f0f0f0;
                cursor: pointer;
                font-size: 12px;
                transition: background-color 0.2s;
            }
            .menu-item .view-btn:hover {
                background-color: #ff9800;
                border-color: #ff9800;
            }
            .menu-item .view-btn.active {
                background-color: #ffd600; /* Yellow */
                border-color: #ffd600;
            }

            .menu-item a {
                color: inherit;
                text-decoration: none;
                cursor: pointer;
                display: block;
                width: 100%;
            }

            .menu-separator {
                height: 1px;
                background-color: #888888;
                margin: 8px 0;
            }

            #stats-display {
                color: #888888;
                font-family: "Fira Code", "Courier New", monospace;
                font-size: 14px;
                display: flex;
                gap: 16px;
                background-color: rgba(61, 61, 61, 0.5);
                padding: 4px 12px;
                border-radius: 6px;
                transition: opacity 0.3s;
            }

            .hidden {
                display: none !important;
            }

            #find-bar {
                position: fixed;
                bottom: 16px;
                right: 16px;
                background-color: #3d3d3d;
                border: 1px solid #888888;
                border-radius: 8px;
                padding: 8px;
                display: none;
                align-items: center;
                gap: 8px;
                z-index: 1001;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            #find-input {
                background-color: #2d2d2d;
                border: 1px solid #888888;
                color: #f0f0f0;
                border-radius: 4px;
                padding: 4px 8px;
                outline: none;
                width: 200px;
            }

            #find-input:focus {
                border-color: #ff9800;
            }

            .find-btn {
                background-color: transparent;
                border: none;
                color: #f0f0f0;
                cursor: pointer;
                padding: 4px;
                border-radius: 4px;
            }
            .find-btn:hover {
                background-color: #888888;
            }

            /* --- Integrated SNO Styles (Orange Themed) --- */
            #sno-container {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 10px;
                height: 100vh;
            }

            .sno-container {
                width: 100%;
                max-width: 1200px;
                margin: 0 auto;
            }

            .login-screen,
            .app-screen {
                background: #2d2d2d;
                border-radius: 8px;
                padding: 30px;
                border: 1px solid #888888;
                max-width: 400px;
                margin: 0 auto;
            }

            .app-screen {
                max-width: 1200px;
            }

            .app-screen.active {
                display: block;
            }

            #sno-container h1 {
                color: #f0f0f0;
                margin-bottom: 25px;
                font-size: 1.8em;
                font-weight: 600;
                text-align: center;
            }

            .input-group {
                margin-bottom: 15px;
                text-align: left;
            }

            #sno-container label {
                display: block;
                margin-bottom: 5px;
                color: #f0f0f0;
                font-weight: 500;
                font-size: 14px;
            }

            #sno-container input[type="password"],
            #sno-container input[type="text"],
            #sno-container textarea {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #888888;
                border-radius: 4px;
                font-size: 14px;
                background: #2d2d2d;
                color: #f0f0f0;
            }

            #sno-container input[type="password"]:focus,
            #sno-container input[type="text"]:focus,
            #sno-container textarea:focus {
                outline: none;
                border-color: #ff9800; /* Main Orange */
            }

            #sno-container textarea {
                resize: vertical;
                min-height: 300px;
                font-family: inherit;
            }

            .btn {
                background: #ff9800; /* Main Orange */
                color: #2d2d2d;
                border: 1px solid #ff9800;
                padding: 8px 16px;
                border-radius: 4px;
                font-size: 14px;
                cursor: pointer;
                transition: background 0.2s ease;
                font-weight: 500;
            }

            .btn:hover {
                background: #ffb74d;
            }

            .btn-secondary {
                background: #ffb74d; /* Light Orange */
                border-color: #ffb74d;
                color: #2d2d2d;
                margin-left: 8px;
            }
            .btn-secondary:hover {
                background: #ffcc80;
            }

            .btn-danger {
                background: #ff5555; /* Red */
                border-color: #ff5555;
            }
            .btn-danger:hover {
                background: #ff7070;
            }

            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                flex-wrap: wrap;
                gap: 15px;
            }
            .header h1 {
                margin-bottom: 0;
                text-align: left;
            }

            .search-box {
                flex: 1;
                min-width: 200px;
            }

            .notes-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 15px;
                margin-top: 20px;
            }

            .note-card {
                background: #3d3d3d;
                border-radius: 6px;
                padding: 15px;
                border: 1px solid #888888;
                transition: border-color 0.2s ease;
                cursor: pointer;
            }

            .note-card:hover {
                border-color: #ff9800; /* Main Orange */
            }

            .note-title {
                font-size: 1.1em;
                font-weight: 600;
                color: #f0f0f0;
                margin-bottom: 8px;
                word-break: break-word;
            }

            .note-preview {
                color: #e0e0e0;
                font-size: 0.9em;
                line-height: 1.4;
                margin-bottom: 12px;
                max-height: 80px;
                overflow: hidden;
                word-break: break-word;
            }

            .note-meta {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.75em;
                color: #888888;
            }

            .note-actions {
                display: flex;
                gap: 8px;
            }

            .btn-small {
                padding: 5px 10px;
                font-size: 12px;
                border-radius: 4px;
            }

            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                z-index: 1000;
            }

            .modal.active {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .modal-content {
                background: #2d2d2d;
                border-radius: 8px;
                padding: 25px;
                max-width: 700px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                border: 1px solid #ff9800;
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }
            .modal-header h2 {
                font-size: 1.4em;
                color: #f0f0f0;
            }

            .close-btn {
                background: none;
                border: none;
                font-size: 22px;
                cursor: pointer;
                color: #888888;
            }

            .empty-state {
                text-align: center;
                padding: 50px 20px;
                color: #888888;
            }

            .empty-state h3 {
                margin-bottom: 10px;
                color: #f0f0f0;
            }

            .error-message {
                color: #ff5555;
                font-size: 13px;
                margin-top: 5px;
                text-align: left;
            }

            .storage-info {
                font-size: 12px;
                color: #888888;
                margin-top: 20px;
                text-align: center;
            }

            /* Text Expander Modal Styles */
            #text-expander-modal .modal-content {
                max-width: 800px;
            }
            #expansions-list {
                max-height: 30vh;
                overflow-y: auto;
                border: 1px solid #3d3d3d;
                border-radius: 4px;
                margin-bottom: 15px;
            }
            .expansion-item {
                display: flex;
                align-items: center;
                padding: 8px 12px;
                border-bottom: 1px solid #3d3d3d;
            }
            .expansion-item:last-child {
                border-bottom: none;
            }
            .expansion-item-shortcut {
                font-family: "Fira Code", monospace;
                color: #ffb74d; /* Light Orange */
                width: 100px;
                flex-shrink: 0;
            }
            .expansion-item-value {
                flex-grow: 1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                color: #f0f0f0;
            }
            .expansion-item-actions {
                margin-left: 15px;
            }
            #new-expansion-form {
                display: grid;
                grid-template-columns: 150px 1fr;
                gap: 10px;
                align-items: center;
                margin-bottom: 20px;
            }
            #new-expansion-form input,
            #new-expansion-form textarea {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #888888;
                border-radius: 4px;
                font-size: 14px;
                background: #2d2d2d;
                color: #f0f0f0;
                font-family: inherit;
            }
            #new-expansion-form textarea {
                grid-column: 1 / -1;
                resize: vertical;
                min-height: 80px;
            }

            @media (max-width: 768px) {
                .header {
                    flex-direction: column;
                    align-items: stretch;
                }
                .header h1 {
                    text-align: center;
                }
                .notes-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>

        <style media="print">
            /* --- Print Styles --- */
            body * {
                visibility: hidden;
            }
            #markdown-preview,
            #markdown-preview * {
                visibility: visible;
            }
            #markdown-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                padding: 2cm;
                color: #000 !important;
                background-color: #fff !important;
                max-width: 100%;
            }
            #markdown-preview h1,
            #markdown-preview h2,
            #markdown-preview h3,
            #markdown-preview h4,
            #markdown-preview a {
                color: #000 !important;
            }
        </style>

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Inter:wght@400;500;600&display=swap"
            rel="stylesheet"
        />
    </head>
    <body>
        <div id="editr-container">
            <div id="line-indicator"></div>
            <textarea
                id="editor"
                spellcheck="false"
                placeholder="Right-click or ☰ for menu."
            ></textarea>
        </div>

        <div id="markdown-preview" class="hidden"></div>
        <div id="csv-grid" class="hidden"></div>

        <div id="top-right-container">
            <div id="stats-display">
                <span id="stats-line">↓ 1</span>
                <span id="stats-char">→ 1</span>
                <span id="stats-words">= 0</span>
            </div>

            <div id="menu-trigger" title="Menu">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="#f0f0f0"
                    viewBox="0 0 256 256"
                >
                    <path
                        d="M224,128a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,128ZM40,72H216a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16ZM216,184H40a8,8,0,0,0,0,16H216a8,8,0,0,0,0-16Z"
                    ></path>
                </svg>
            </div>
        </div>

        <div id="context-menu">
            <div class="menu-item" id="menu-new">
                <span>New</span>
                <span class="shortcut">Ctrl+N</span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-item" id="menu-open">
                <span>Open</span>
                <span class="shortcut">Ctrl+O</span>
            </div>
            <div
                class="menu-item"
                style="
                    padding: 0;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                "
            >
                <div
                    style="
                        display: flex;
                        gap: 0.5rem;
                        align-items: center;
                        padding: 10px 20px;
                    "
                >
                    <a id="menu-save" style="cursor: pointer">Save</a>
                    <a id="menu-save-as" style="cursor: pointer">(As)</a>
                </div>
                <span class="shortcut" style="padding-right: 20px">Ctrl+S</span>
            </div>
            <div class="menu-item" id="menu-close-file">
                <span>Close File</span>
                <span class="shortcut">Ctrl+W</span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-item" id="menu-next-file">
                <span>Next File</span>
                <span class="shortcut">Ctrl+→</span>
            </div>
            <div class="menu-item" id="menu-prev-file">
                <span>Last File</span>
                <span class="shortcut">Ctrl+←</span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-item" id="menu-find">
                <span>Find</span>
                <span class="shortcut">Ctrl+F</span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-item" id="menu-open-link">
                <span>Open Link</span>
                <span class="shortcut">Ctrl+U</span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-item" id="menu-sno">
                <span>Notes</span>
                <span class="shortcut">Ctrl+=</span>
            </div>
            <div class="menu-separator"></div>
            <div
                class="menu-item"
                style="display: flex; gap: 1rem; padding: 10px 20px"
            >
                <a id="menu-toggle-stats" style="cursor: pointer">Stats</a>
                <a id="menu-text-expander" style="cursor: pointer">Text</a>
                <div style="flex-grow: 1"></div>
                <button id="menu-md-view" class="view-btn">MD</button>
                <button id="menu-csv-view" class="view-btn">CSV</button>
            </div>
        </div>

        <div id="find-bar">
            <input type="text" id="find-input" placeholder="Find..." />
            <button
                id="find-prev"
                class="find-btn"
                title="Previous (Shift+Enter)"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    viewBox="0 0 256 256"
                >
                    <path
                        d="M224,128a8,8,0,0,1-8,8H122.34l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L122.34,120H216A8,8,0,0,1,224,128ZM40,40a8,8,0,0,0-8,8V208a8,8,0,0,0,16,0V48A8,8,0,0,0,40,40Z"
                    ></path>
                </svg>
            </button>
            <button id="find-next" class="find-btn" title="Next (Enter)">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    viewBox="0 0 256 256"
                >
                    <path
                        d="M216,40a8,8,0,0,0-8-8H48a8,8,0,0,0-8,8V208a8,8,0,0,0,16,0V48H208A8,8,0,0,0,216,40ZM133.66,122.34,75.31,64.05a8,8,0,0,0-11.31,11.31L122.34,128,64,180.69a8,8,0,0,0,11.31,11.31L133.66,133.66a8,8,0,0,0,0-11.32Z"
                    ></path>
                </svg>
            </button>
            <button id="find-close" class="find-btn" title="Close (Esc)">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    viewBox="0 0 256 256"
                >
                    <path
                        d="M208.49,191.51a12,12,0,0,1-17,17L128,145,64.49,208.49a12,12,0,0,1-17-17L111,128,47.51,64.49a12,12,0,0,1,17-17L128,111,63.51-63.52a12,12,0,0,1,17,17L145,128Z"
                    ></path>
                </svg>
            </button>
        </div>

        <div id="sno-container" class="hidden">
            <div class="sno-container">
                <div id="loginScreen" class="login-screen">
                    <h1>Notes.</h1>
                    <div class="input-group">
                        <label for="masterPassword">Password</label>
                        <input
                            type="password"
                            id="masterPassword"
                            placeholder="Enter your password"
                        />
                        <div id="loginError" class="error-message"></div>
                    </div>
                    <button class="btn" onclick="sno_login()">Unlock</button>
                    <div class="storage-info">
                        Data is encrypted and stored locally in your browser.
                    </div>
                </div>

                <div id="appScreen" class="app-screen hidden">
                    <div class="header">
                        <h1>Notes.</h1>
                        <div class="search-box">
                            <input
                                type="text"
                                id="searchInput"
                                placeholder="Search notes..."
                                oninput="sno_searchNotes()"
                            />
                        </div>
                        <div>
                            <button
                                class="btn"
                                onclick="sno_showNewNoteModal()"
                            >
                                + New Note
                            </button>
                            <button
                                class="btn btn-secondary"
                                onclick="sno_logout()"
                            >
                                Close Notes
                            </button>
                        </div>
                    </div>
                    <div id="notesContainer"></div>
                </div>
            </div>

            <div id="noteModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modalTitle">New Note</h2>
                        <button class="close-btn" onclick="sno_closeModal()">
                            &times;
                        </button>
                    </div>
                    <div class="input-group">
                        <label for="noteTitle">Title</label>
                        <input
                            type="text"
                            id="noteTitle"
                            placeholder="Enter note title"
                        />
                    </div>
                    <div class="input-group">
                        <label for="noteContent">Content</label>
                        <textarea
                            id="noteContent"
                            placeholder="Write your note content here..."
                        ></textarea>
                    </div>
                    <div style="text-align: right; margin-top: 20px">
                        <button
                            class="btn btn-secondary"
                            onclick="sno_closeModal()"
                        >
                            Cancel
                        </button>
                        <button class="btn" onclick="sno_saveNote()">
                            Save Note
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="text-expander-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Text Expander</h2>
                    <button id="close-expander-modal" class="close-btn">
                        &times;
                    </button>
                </div>

                <h3>My Shortcuts</h3>
                <div id="expansions-list"></div>

                <h3>Add/Edit Shortcut</h3>
                <div id="new-expansion-form">
                    <input
                        type="text"
                        id="expansion-shortcut-input"
                        placeholder=".letter (EG .a)"
                    />
                    <button id="add-expansion-btn" class="btn">
                        Add/Update
                    </button>
                    <textarea
                        id="expansion-value-input"
                        placeholder="Enter the text to expand to..."
                    ></textarea>
                </div>

                <div
                    style="
                        text-align: right;
                        margin-top: 20px;
                        display: flex;
                        justify-content: flex-end;
                        gap: 10px;
                    "
                >
                    <button
                        id="import-expansions-btn"
                        class="btn btn-secondary"
                    >
                        Import
                    </button>
                    <button
                        id="export-expansions-btn"
                        class="btn btn-secondary"
                    >
                        Export
                    </button>
                </div>
                <input
                    type="file"
                    id="import-expansions-input"
                    class="hidden"
                    accept=".txt"
                />
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                // --- DOM ELEMENTS ---
                const editor = document.getElementById("editor");
                const lineIndicator = document.getElementById("line-indicator");
                const contextMenu = document.getElementById("context-menu");
                const menuTrigger = document.getElementById("menu-trigger");
                const statsDisplay = document.getElementById("stats-display");
                const statsLine = document.getElementById("stats-line");
                const statsChar = document.getElementById("stats-char");
                const statsWords = document.getElementById("stats-words");
                const findBar = document.getElementById("find-bar");
                const findInput = document.getElementById("find-input");
                const findPrev = document.getElementById("find-prev");
                const findNext = document.getElementById("find-next");
                const findClose = document.getElementById("find-close");
                const body = document.body;
                const editrContainer =
                    document.getElementById("editr-container");
                const snoContainer = document.getElementById("sno-container");
                const markdownPreview =
                    document.getElementById("markdown-preview");
                const csvGrid = document.getElementById("csv-grid");
                const mdViewBtn = document.getElementById("menu-md-view");
                const csvViewBtn = document.getElementById("menu-csv-view");

                // --- ================================== ---
                // --- SNO (Secure Note) INTEGRATION CODE ---
                // --- ================================== ---

                let masterKey = null;
                let notes = [];
                let currentEditingId = null;
                let currentPasswordHash = null;
                const STORAGE_KEY = "sno_secure_note_vault";
                const VAULT_VERSION = "1.0";

                function sno_init() {
                    if (!sno_isLocalStorageAvailable()) {
                        sno_showError(
                            "This application requires local storage to function. Please enable it in your browser settings.",
                        );
                        return;
                    }
                    // Reset to login screen view
                    document
                        .getElementById("loginScreen")
                        .classList.remove("hidden");
                    document
                        .getElementById("appScreen")
                        .classList.add("hidden");
                    document.getElementById("masterPassword").value = "";
                    document.getElementById("searchInput").value = "";
                    sno_renderNotes();
                }

                function sno_showError(message) {
                    const loginScreen = document.getElementById("loginScreen");
                    let errorDiv = document.getElementById("criticalError");
                    if (!errorDiv) {
                        errorDiv = document.createElement("div");
                        errorDiv.id = "criticalError";
                        errorDiv.style.color = "#ff5555";
                        errorDiv.style.marginTop = "15px";
                        errorDiv.style.fontWeight = "bold";
                        loginScreen.appendChild(errorDiv);
                    }
                    errorDiv.textContent = message;
                }

                function sno_isLocalStorageAvailable() {
                    try {
                        const test = "__storage_test__";
                        localStorage.setItem(test, test);
                        localStorage.removeItem(test);
                        return true;
                    } catch (e) {
                        return false;
                    }
                }

                function sno_loadVaultsFromStorage() {
                    try {
                        const stored = localStorage.getItem(STORAGE_KEY);
                        if (stored) {
                            const data = JSON.parse(stored);
                            if (data.version === VAULT_VERSION) {
                                return data.vaults || {};
                            }
                        }
                    } catch (e) {
                        console.error("Error loading vaults from storage:", e);
                    }
                    return {};
                }

                function sno_saveVaultsToStorage(vaults) {
                    try {
                        const data = {
                            version: VAULT_VERSION,
                            vaults: vaults,
                            lastUpdated: new Date().toISOString(),
                        };
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                        return true;
                    } catch (e) {
                        console.error("Error saving vaults to storage:", e);
                        if (e.name === "QuotaExceededError") {
                            sno_showError(
                                "Storage quota exceeded. Please delete some notes.",
                            );
                        }
                        return false;
                    }
                }

                function sno_hashPassword(password) {
                    return CryptoJS.SHA256(password + "sno-salt-v1").toString();
                }

                function sno_login() {
                    const password =
                        document.getElementById("masterPassword").value;
                    const errorElement = document.getElementById("loginError");

                    if (!password) {
                        errorElement.textContent = "Please enter a password";
                        return;
                    }

                    masterKey = CryptoJS.PBKDF2(password, "sno-salt-v1", {
                        keySize: 256 / 32,
                        iterations: 10000,
                    });
                    currentPasswordHash = sno_hashPassword(password);
                    const userVaults = sno_loadVaultsFromStorage();

                    if (userVaults[currentPasswordHash]) {
                        try {
                            const encryptedNotes =
                                userVaults[currentPasswordHash];
                            const decryptedData = CryptoJS.AES.decrypt(
                                encryptedNotes,
                                masterKey.toString(),
                            ).toString(CryptoJS.enc.Utf8);
                            if (!decryptedData)
                                throw new Error("Decryption failed");
                            notes = JSON.parse(decryptedData);
                        } catch (e) {
                            console.error("Decryption error:", e);
                            errorElement.textContent =
                                "Invalid password - unable to decrypt notes.";
                            return;
                        }
                    } else {
                        notes = [];
                    }

                    errorElement.textContent = "";
                    document
                        .getElementById("loginScreen")
                        .classList.add("hidden");
                    document
                        .getElementById("appScreen")
                        .classList.remove("hidden");
                    document.getElementById("masterPassword").value = "";
                    sno_renderNotes();
                }

                function sno_logout() {
                    sno_saveNotesToStorage();
                    masterKey = null;
                    notes = [];
                    currentEditingId = null;
                    currentPasswordHash = null;

                    // Hide SNO view and show editr view
                    snoContainer.classList.add("hidden");
                    editrContainer.style.display = "block"; // Or 'flex' etc. as needed

                    // Clean up UI for next time
                    sno_init();
                    hideMenu();
                }

                function sno_saveNotesToStorage() {
                    if (!masterKey || !currentPasswordHash) return false;
                    try {
                        const userVaults = sno_loadVaultsFromStorage();
                        const notesJson = JSON.stringify(notes);
                        const encryptedNotes = CryptoJS.AES.encrypt(
                            notesJson,
                            masterKey.toString(),
                        ).toString();
                        userVaults[currentPasswordHash] = encryptedNotes;
                        return sno_saveVaultsToStorage(userVaults);
                    } catch (e) {
                        console.error("Failed to save notes:", e);
                        return false;
                    }
                }

                function sno_encrypt(text) {
                    if (!masterKey) return text;
                    return CryptoJS.AES.encrypt(
                        text,
                        masterKey.toString(),
                    ).toString();
                }

                function sno_decrypt(encryptedText) {
                    if (!masterKey) return encryptedText;
                    try {
                        const bytes = CryptoJS.AES.decrypt(
                            encryptedText,
                            masterKey.toString(),
                        );
                        return (
                            bytes.toString(CryptoJS.enc.Utf8) ||
                            "[Decryption Error]"
                        );
                    } catch (e) {
                        return "[Unable to decrypt]";
                    }
                }

                function sno_showNewNoteModal() {
                    currentEditingId = null;
                    document.getElementById("modalTitle").textContent =
                        "New Note";
                    document.getElementById("noteTitle").value = "";
                    document.getElementById("noteContent").value = "";
                    document
                        .getElementById("noteModal")
                        .classList.add("active");
                    document.getElementById("noteTitle").focus();
                }

                window.sno_editNote = function (id) {
                    // Expose to global scope for onclick
                    const note = notes.find((n) => n.id === id);
                    if (!note) return;
                    currentEditingId = id;
                    document.getElementById("modalTitle").textContent =
                        "Edit Note";
                    document.getElementById("noteTitle").value = sno_decrypt(
                        note.title,
                    );
                    document.getElementById("noteContent").value = sno_decrypt(
                        note.content,
                    );
                    document
                        .getElementById("noteModal")
                        .classList.add("active");
                    document.getElementById("noteTitle").focus();
                };

                function sno_saveNote() {
                    const title = document
                        .getElementById("noteTitle")
                        .value.trim();
                    const content = document
                        .getElementById("noteContent")
                        .value.trim();
                    if (!title) {
                        alert("Please enter a title.");
                        return;
                    }
                    const now = new Date().toISOString();
                    const noteData = {
                        title: sno_encrypt(title),
                        content: sno_encrypt(content),
                        lastModified: now,
                    };

                    if (currentEditingId) {
                        const noteIndex = notes.findIndex(
                            (n) => n.id === currentEditingId,
                        );
                        if (noteIndex !== -1) {
                            notes[noteIndex] = {
                                ...notes[noteIndex],
                                ...noteData,
                            };
                        }
                    } else {
                        noteData.id = Date.now().toString();
                        noteData.created = now;
                        notes.unshift(noteData);
                    }

                    if (!sno_saveNotesToStorage()) {
                        alert("Failed to save note. Storage might be full.");
                        return;
                    }
                    sno_closeModal();
                    sno_renderNotes();
                }

                window.sno_deleteNote = function (id) {
                    // Expose to global scope for onclick
                    if (
                        window.confirm(
                            "Are you sure you want to delete this note?",
                        )
                    ) {
                        notes = notes.filter((n) => n.id !== id);
                        sno_saveNotesToStorage();
                        sno_renderNotes();
                    }
                };

                function sno_closeModal() {
                    document
                        .getElementById("noteModal")
                        .classList.remove("active");
                    currentEditingId = null;
                }

                function sno_searchNotes() {
                    const query = document
                        .getElementById("searchInput")
                        .value.toLowerCase();
                    const filteredNotes = notes.filter((note) => {
                        const title = sno_decrypt(note.title).toLowerCase();
                        const content = sno_decrypt(note.content).toLowerCase();
                        return title.includes(query) || content.includes(query);
                    });
                    sno_renderNotes(filteredNotes);
                }

                function sno_renderNotes(notesToRender = notes) {
                    const container = document.getElementById("notesContainer");
                    const searchInput =
                        document.getElementById("searchInput").value;
                    if (notesToRender.length === 0) {
                        container.innerHTML = `
                        <div class="empty-state">
                            <h3>${notes.length === 0 ? "No notes yet" : "No notes found"}</h3>
                            <p>${notes.length === 0 ? "Create your first secure note to get started!" : `Your search for "${sno_escapeHtml(searchInput)}" did not match any notes.`}</p>
                        </div>`;
                        return;
                    }
                    const notesHTML = notesToRender
                        .map((note) => {
                            const title = sno_decrypt(note.title);
                            const content = sno_decrypt(note.content);
                            const preview =
                                content.length > 100
                                    ? content.substring(0, 100) + "..."
                                    : content;
                            const date = new Date(
                                note.lastModified,
                            ).toLocaleDateString();
                            return `
                        <div class="note-card" onclick="sno_editNote('${note.id}')">
                            <div class="note-title">${sno_escapeHtml(title)}</div>
                            <div class="note-preview">${sno_escapeHtml(preview)}</div>
                            <div class="note-meta">
                                <span>Modified: ${date}</span>
                                <div class="note-actions" onclick="event.stopPropagation()">
                                    <button class="btn btn-small btn-danger" onclick="sno_deleteNote('${note.id}')">Delete</button>
                                </div>
                            </div>
                        </div>`;
                        })
                        .join("");
                    container.innerHTML = `<div class="notes-grid">${notesHTML}</div>`;
                }

                function sno_escapeHtml(text) {
                    const div = document.createElement("div");
                    div.textContent = text;
                    return div.innerHTML;
                }

                // Attach SNO functions to window object so inline onclick handlers can find them
                window.sno_login = sno_login;
                window.sno_logout = sno_logout;
                window.sno_showNewNoteModal = sno_showNewNoteModal;
                window.sno_searchNotes = sno_searchNotes;
                window.sno_saveNote = sno_saveNote;
                window.sno_closeModal = sno_closeModal;

                // SNO Event Listeners
                document
                    .getElementById("masterPassword")
                    .addEventListener("keypress", (e) => {
                        if (e.key === "Enter") sno_login();
                    });
                document
                    .getElementById("noteModal")
                    .addEventListener("click", (e) => {
                        if (e.target === e.currentTarget) sno_closeModal();
                    });

                // --- ================= ---
                // --- editr CORE CODE ---
                // --- ================= ---

                // --- VIEW STATE MANAGEMENT ---
                let isMarkdownView = false;
                let isCsvView = false;
                const mdConverter = new showdown.Converter({
                    tables: true,
                    strikethrough: true,
                    tasklists: true,
                    emoji: true,
                });
                let csvData = [];

                // --- HELPER FUNCTION for short IDs ---
                const generateShortId = (length = 8) => {
                    const chars =
                        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
                    let result = "";
                    for (let i = 0; i < length; i++) {
                        result += chars.charAt(
                            Math.floor(Math.random() * chars.length),
                        );
                    }
                    return result;
                };

                // --- SESSION MANAGEMENT ---
                let sessionId = window.location.hash.substring(1);
                if (!sessionId) {
                    sessionId = generateShortId();
                    history.replaceState(null, "", `#${sessionId}`);
                }
                const storageKey = `editrTextSession-${sessionId}`;
                const statsStorageKey = `editrStatsHidden-${sessionId}`;

                // --- STATE MANAGEMENT ---
                let buffers = [];
                let activeBufferIndex = -1;
                let fileHandles = new Map();

                let lastSearchTerm = "";
                let searchResults = [];
                let currentResultIndex = -1;

                const saveState = () => {
                    const stateToSave = {
                        buffers: buffers,
                        activeBufferIndex: activeBufferIndex,
                    };
                    localStorage.setItem(
                        storageKey,
                        JSON.stringify(stateToSave),
                    );
                };

                const renderActiveBuffer = () => {
                    if (
                        activeBufferIndex < 0 ||
                        activeBufferIndex >= buffers.length
                    ) {
                        editor.value = "";
                        document.title = "editr";
                        updateStats();
                        return;
                    }
                    const activeBuffer = buffers[activeBufferIndex];
                    editor.value = activeBuffer.content;
                    document.title = activeBuffer.fileName
                        ? `${activeBuffer.fileName} - editr`
                        : "editr";
                    updateStats();
                };

                const createNewBuffer = (
                    content = "",
                    fileName = "untitled.txt",
                    fileHandle = null,
                ) => {
                    const newBuffer = {
                        id: generateShortId(),
                        content,
                        fileName,
                    };
                    buffers.push(newBuffer);
                    if (fileHandle) {
                        fileHandles.set(newBuffer.id, fileHandle);
                    }
                    activeBufferIndex = buffers.length - 1;
                    renderActiveBuffer();
                    saveState();
                };

                const loadState = () => {
                    const savedStateJSON = localStorage.getItem(storageKey);
                    if (savedStateJSON) {
                        try {
                            const savedState = JSON.parse(savedStateJSON);
                            buffers = savedState.buffers || [];
                            activeBufferIndex =
                                savedState.activeBufferIndex || 0;
                            if (buffers.length === 0) {
                                createNewBuffer();
                            } else {
                                renderActiveBuffer();
                            }
                        } catch (e) {
                            console.error("Failed to parse saved state:", e);
                            createNewBuffer();
                        }
                    } else {
                        createNewBuffer();
                    }
                };

                const updateLineIndicator = (currentLineNumber) => {
                    const editorStyles = window.getComputedStyle(editor);
                    const paddingTop = parseFloat(editorStyles.paddingTop);
                    const lineHeight = parseFloat(editorStyles.lineHeight);
                    const scrollTop = editor.scrollTop;

                    const topPosition =
                        paddingTop +
                        (currentLineNumber - 1) * lineHeight -
                        scrollTop;

                    lineIndicator.style.top = `${topPosition}px`;
                };

                editor.addEventListener("input", () => {
                    if (activeBufferIndex !== -1) {
                        buffers[activeBufferIndex].content = editor.value;
                        saveState();
                        updateStats();

                        if (isMarkdownView) {
                            const html = mdConverter.makeHtml(editor.value);
                            markdownPreview.innerHTML = html;
                        }
                    }
                });

                const updateStats = () => {
                    const text = editor.value;
                    const cursorPos = editor.selectionStart;
                    const words =
                        text.trim() === "" ? [] : text.trim().split(/\s+/);
                    statsWords.textContent = `= ${words.length}`;
                    const textUpToCursor = text.substring(0, cursorPos);
                    const lines = textUpToCursor.split("\n");
                    const currentLineNumber = lines.length;
                    const currentCharNumber =
                        lines[lines.length - 1].length + 1;
                    statsLine.textContent = `↓ ${currentLineNumber}`;
                    statsChar.textContent = `→ ${currentCharNumber}`;
                    updateLineIndicator(currentLineNumber);
                };
                editor.addEventListener("keyup", updateStats);
                editor.addEventListener("click", updateStats);
                editor.addEventListener("scroll", updateStats);

                const pairMap = {
                    "(": ")",
                    "[": "]",
                    "{": "}",
                    '"': '"',
                    "'": "'",
                    "`": "`",
                };
                const openChars = Object.keys(pairMap);

                editor.addEventListener("keydown", (e) => {
                    if (e.key === "Tab") {
                        e.preventDefault();
                        document.execCommand("insertText", false, "\t");
                        return;
                    }
                    if (e.key === "Enter") {
                        const cursorPos = editor.selectionStart;
                        const textBeforeCursor = editor.value.substring(
                            0,
                            cursorPos,
                        );

                        // Check for text expansion on Enter
                        const lastWord = textBeforeCursor.split(/\s+/).pop();
                        if (handleTextExpansion(lastWord, e)) return;

                        e.preventDefault();
                        const currentLineStart =
                            textBeforeCursor.lastIndexOf("\n") + 1;
                        const currentLine =
                            textBeforeCursor.substring(currentLineStart);
                        const leadingWhitespaceMatch =
                            currentLine.match(/^\s*/);
                        const indent = leadingWhitespaceMatch
                            ? leadingWhitespaceMatch[0]
                            : "";
                        document.execCommand(
                            "insertText",
                            false,
                            "\n" + indent,
                        );
                        return;
                    }
                    if (e.key === " ") {
                        const cursorPos = editor.selectionStart;
                        const textBeforeCursor = editor.value.substring(
                            0,
                            cursorPos,
                        );
                        const lastWord = textBeforeCursor.split(/\s+/).pop();
                        if (handleTextExpansion(lastWord, e)) return;
                    }
                    if (openChars.includes(e.key)) {
                        e.preventDefault();
                        const start = editor.selectionStart,
                            end = editor.selectionEnd;
                        const selectedText = editor.value.substring(start, end);
                        const textToInsert =
                            e.key + selectedText + pairMap[e.key];
                        document.execCommand("insertText", false, textToInsert);
                        if (start === end) {
                            editor.selectionStart = editor.selectionEnd =
                                start + 1;
                        } else {
                            editor.selectionStart = start + 1;
                            editor.selectionEnd = end + 1;
                        }
                    }
                });

                const toggleStats = (e) => {
                    e.stopPropagation();
                    const isHidden = statsDisplay.classList.toggle("hidden");
                    localStorage.setItem(statsStorageKey, isHidden);
                    hideMenu();
                    return `Stats display is now ${isHidden ? "hidden" : "visible"}.`;
                };
                document
                    .getElementById("menu-toggle-stats")
                    .addEventListener("click", toggleStats);
                if (localStorage.getItem(statsStorageKey) === "true") {
                    statsDisplay.classList.add("hidden");
                }

                // --- VIEW TOGGLE LOGIC ---
                const toggleMarkdownPreview = () => {
                    hideMenu();
                    isMarkdownView = !isMarkdownView;

                    if (isCsvView) {
                        isCsvView = false;
                        csvGrid.classList.add("hidden");
                        csvViewBtn.classList.remove("active");
                    }

                    if (isMarkdownView) {
                        const markdownText = editor.value;
                        const html = mdConverter.makeHtml(markdownText);
                        markdownPreview.innerHTML = html;
                        editrContainer.classList.add("hidden");
                        markdownPreview.classList.remove("hidden");
                        mdViewBtn.classList.add("active");
                    } else {
                        editrContainer.classList.remove("hidden");
                        markdownPreview.classList.add("hidden");
                        mdViewBtn.classList.remove("active");
                        editor.focus();
                    }
                };

                const toggleCsvGrid = () => {
                    hideMenu();
                    isCsvView = !isCsvView;

                    if (isMarkdownView) {
                        isMarkdownView = false;
                        markdownPreview.classList.add("hidden");
                        mdViewBtn.classList.remove("active");
                    }

                    if (isCsvView) {
                        editrContainer.classList.add("hidden");
                        csvGrid.classList.remove("hidden");
                        csvViewBtn.classList.add("active");
                        parseCsvAndRenderGrid();
                    } else {
                        editrContainer.classList.remove("hidden");
                        csvGrid.classList.add("hidden");
                        csvViewBtn.classList.remove("active");
                        editor.focus();
                    }
                };

                mdViewBtn.addEventListener("click", toggleMarkdownPreview);
                csvViewBtn.addEventListener("click", toggleCsvGrid);

                // --- CSV Grid Functions ---
                const parseCsvAndRenderGrid = () => {
                    const text = editor.value.trim();
                    csvData = text.split("\n").map((line) => line.split(","));
                    if (
                        csvData.length === 1 &&
                        csvData[0].length === 1 &&
                        csvData[0][0] === ""
                    ) {
                        csvData = [
                            ["Header1", "Header2"],
                            ["data1", "data2"],
                        ]; // Default data
                    }
                    renderCsvGrid();
                };

                const updateEditorFromCsv = () => {
                    const newText = csvData
                        .map((row) => row.join(","))
                        .join("\n");
                    editor.value = newText;
                    if (activeBufferIndex !== -1) {
                        buffers[activeBufferIndex].content = newText;
                    }
                    saveState();
                };

                const renderCsvGrid = () => {
                    csvGrid.innerHTML = "";
                    if (!csvData || csvData.length === 0) return;

                    const tableContainer = document.createElement("div");
                    tableContainer.id = "csv-grid-table-container";

                    const table = document.createElement("table");

                    const thead = document.createElement("thead");
                    const headerRow = document.createElement("tr");
                    csvData[0].forEach((header, index) => {
                        const th = document.createElement("th");
                        th.innerHTML = `
                            <span contenteditable="true" data-col-index="${index}">${sno_escapeHtml(header)}</span>
                            <button class="csv-action-btn delete-col-btn" data-col-index="${index}" title="Delete Column">🗑️</button>
                        `;
                        headerRow.appendChild(th);
                    });
                    headerRow.appendChild(document.createElement("th"));
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    const tbody = document.createElement("tbody");
                    for (let i = 1; i < csvData.length; i++) {
                        const dataRow = document.createElement("tr");
                        csvData[i].forEach((cell, j) => {
                            const td = document.createElement("td");
                            td.textContent = cell;
                            td.contentEditable = "true";
                            td.dataset.rowIndex = i;
                            td.dataset.colIndex = j;
                            dataRow.appendChild(td);
                        });
                        const actionTd = document.createElement("td");
                        actionTd.innerHTML = `<button class="csv-action-btn delete-row-btn" data-row-index="${i}" title="Delete Row">🗑️</button>`;
                        dataRow.appendChild(actionTd);
                        tbody.appendChild(dataRow);
                    }
                    table.appendChild(tbody);
                    tableContainer.appendChild(table);

                    const controls = document.createElement("div");
                    controls.id = "csv-controls";
                    controls.innerHTML = `
                        <button id="add-row-btn" class="btn btn-secondary">+ Add Row</button>
                        <button id="add-col-btn" class="btn btn-secondary">+ Add Column</button>
                    `;

                    csvGrid.appendChild(tableContainer);
                    csvGrid.appendChild(controls);
                };

                csvGrid.addEventListener("click", (e) => {
                    if (e.target.id === "add-row-btn") {
                        const numCols = csvData[0] ? csvData[0].length : 1;
                        csvData.push(new Array(numCols).fill(""));
                        updateEditorFromCsv();
                        renderCsvGrid();
                    } else if (e.target.id === "add-col-btn") {
                        const newHeader = prompt(
                            "Enter new column header:",
                            "NewColumn",
                        );
                        if (newHeader) {
                            csvData.forEach((row, i) =>
                                row.push(i === 0 ? newHeader : ""),
                            );
                            updateEditorFromCsv();
                            renderCsvGrid();
                        }
                    } else if (e.target.classList.contains("delete-row-btn")) {
                        const rowIndex = parseInt(
                            e.target.dataset.rowIndex,
                            10,
                        );
                        csvData.splice(rowIndex, 1);
                        updateEditorFromCsv();
                        renderCsvGrid();
                    } else if (e.target.classList.contains("delete-col-btn")) {
                        const colIndex = parseInt(
                            e.target.dataset.colIndex,
                            10,
                        );
                        csvData.forEach((row) => row.splice(colIndex, 1));
                        updateEditorFromCsv();
                        renderCsvGrid();
                    }
                });

                csvGrid.addEventListener(
                    "blur",
                    (e) => {
                        if (e.target.contentEditable === "true") {
                            if (e.target.tagName === "TD") {
                                const rowIndex = parseInt(
                                    e.target.dataset.rowIndex,
                                    10,
                                );
                                const colIndex = parseInt(
                                    e.target.dataset.colIndex,
                                    10,
                                );
                                csvData[rowIndex][colIndex] =
                                    e.target.textContent;
                            } else if (e.target.tagName === "SPAN") {
                                const colIndex = parseInt(
                                    e.target.dataset.colIndex,
                                    10,
                                );
                                csvData[0][colIndex] = e.target.textContent;
                            }
                            updateEditorFromCsv();
                        }
                    },
                    true,
                );

                csvGrid.addEventListener("keydown", (e) => {
                    if (e.target.contentEditable !== "true") return;

                    if (
                        ![
                            "ArrowUp",
                            "ArrowDown",
                            "ArrowLeft",
                            "ArrowRight",
                        ].includes(e.key)
                    ) {
                        return;
                    }

                    e.preventDefault();

                    const isHeader = e.target.tagName === "SPAN";
                    let currentRow, currentCol;

                    if (isHeader) {
                        currentRow = 0;
                        currentCol = parseInt(e.target.dataset.colIndex, 10);
                    } else {
                        currentRow = parseInt(e.target.dataset.rowIndex, 10);
                        currentCol = parseInt(e.target.dataset.colIndex, 10);
                    }

                    let nextRow = currentRow;
                    let nextCol = currentCol;

                    switch (e.key) {
                        case "ArrowUp":
                            nextRow--;
                            break;
                        case "ArrowDown":
                            nextRow++;
                            break;
                        case "ArrowLeft":
                            nextCol--;
                            break;
                        case "ArrowRight":
                            nextCol++;
                            break;
                    }

                    let nextEl = null;
                    if (nextRow === 0) {
                        nextEl = csvGrid.querySelector(
                            `th span[data-col-index="${nextCol}"]`,
                        );
                    } else {
                        nextEl = csvGrid.querySelector(
                            `td[data-row-index="${nextRow}"][data-col-index="${nextCol}"]`,
                        );
                    }

                    if (nextEl) {
                        nextEl.focus();
                        const selection = window.getSelection();
                        const range = document.createRange();
                        range.selectNodeContents(nextEl);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                });

                const showMenu = (x, y) => {
                    contextMenu.style.left = `${x}px`;
                    contextMenu.style.top = `${y}px`;
                    contextMenu.style.display = "block";
                };
                const hideMenu = () => (contextMenu.style.display = "none");
                document.addEventListener("contextmenu", (e) => {
                    e.preventDefault();
                    showMenu(e.clientX, e.clientY);
                });
                menuTrigger.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const rect = menuTrigger.getBoundingClientRect();
                    contextMenu.style.visibility = "hidden";
                    contextMenu.style.display = "block";
                    const menuWidth = contextMenu.offsetWidth;
                    const x = rect.right - menuWidth;
                    const y = rect.bottom + 4;
                    contextMenu.style.left = `${x}px`;
                    contextMenu.style.top = `${y}px`;
                    contextMenu.style.visibility = "visible";
                });
                document.addEventListener("click", () => hideMenu());

                const showFindBar = () => {
                    hideMenu();
                    findBar.style.display = "flex";
                    findInput.focus();
                    findInput.select();
                };
                const hideFindBar = () => {
                    findBar.style.display = "none";
                    editor.focus(); // Return focus to the editor
                };

                const selectResult = () => {
                    if (currentResultIndex === -1 || searchResults.length === 0)
                        return;
                    const foundPos = searchResults[currentResultIndex];
                    editor.focus();
                    editor.setSelectionRange(
                        foundPos,
                        foundPos + lastSearchTerm.length,
                    );
                    const totalLines = editor.value.split("\n").length;
                    const currentLine = editor.value
                        .substring(0, foundPos)
                        .split("\n").length;
                    editor.scrollTop =
                        (currentLine / totalLines) * editor.scrollHeight -
                        editor.clientHeight / 2;
                };

                const findNextMatch = () => {
                    const searchTerm = findInput.value;
                    if (!searchTerm) return;

                    if (searchTerm !== lastSearchTerm) {
                        lastSearchTerm = searchTerm;
                        searchResults = [];
                        const text = editor.value;
                        const regex = new RegExp(searchTerm, "gi");
                        let match;
                        while ((match = regex.exec(text)) !== null) {
                            searchResults.push(match.index);
                        }
                        currentResultIndex = -1;
                    }

                    if (searchResults.length === 0) return;
                    currentResultIndex =
                        (currentResultIndex + 1) % searchResults.length;
                    selectResult();
                };

                const findPrevMatch = () => {
                    if (!findInput.value) return;
                    if (findInput.value !== lastSearchTerm) {
                        findNextMatch();
                        return;
                    }
                    if (searchResults.length === 0) return;
                    currentResultIndex =
                        (currentResultIndex - 1 + searchResults.length) %
                        searchResults.length;
                    selectResult();
                };

                const toggleFindBar = () => {
                    if (findBar.style.display === "flex") {
                        hideFindBar();
                    } else {
                        showFindBar();
                    }
                };

                document
                    .getElementById("menu-find")
                    .addEventListener("click", toggleFindBar);
                findClose.addEventListener("click", hideFindBar);
                findNext.addEventListener("click", findNextMatch);
                findPrev.addEventListener("click", findPrevMatch);
                findInput.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        e.shiftKey ? findPrevMatch() : findNextMatch();
                    }
                    if (e.key === "Escape") hideFindBar();
                });

                // --- FILE OPERATIONS ---
                const newFile = () => {
                    hideMenu();
                    createNewBuffer();
                    return "New file created.";
                };

                const openFile = async () => {
                    hideMenu();
                    try {
                        const [fileHandle] = await window.showOpenFilePicker({
                            types: [
                                {
                                    description: "Text Files",
                                    accept: {
                                        "text/plain": [
                                            ".txt",
                                            ".md",
                                            ".js",
                                            ".html",
                                            ".css",
                                            ".json",
                                            ".xml",
                                            ".csv",
                                        ],
                                    },
                                },
                            ],
                        });
                        const file = await fileHandle.getFile();
                        const content = await file.text();
                        createNewBuffer(content, file.name, fileHandle);
                        return `Opened ${file.name}.`;
                    } catch (err) {
                        if (err.name !== "AbortError") {
                            console.error("Error opening file:", err);
                            return "Error opening file.";
                        }
                        return "File open cancelled.";
                    }
                };

                const saveFile = async () => {
                    hideMenu();
                    if (activeBufferIndex === -1)
                        return "No active file to save.";
                    const activeBuffer = buffers[activeBufferIndex];
                    const fileHandle = fileHandles.get(activeBuffer.id);

                    if (fileHandle) {
                        try {
                            const writable = await fileHandle.createWritable();
                            await writable.write(activeBuffer.content);
                            await writable.close();
                            return `Saved ${activeBuffer.fileName}.`;
                        } catch (err) {
                            console.error("Error saving file:", err);
                            return await saveFileAs();
                        }
                    } else {
                        return await saveFileAs();
                    }
                };

                const saveFileAs = async () => {
                    hideMenu();
                    if (activeBufferIndex === -1)
                        return "No active file to save.";
                    const activeBuffer = buffers[activeBufferIndex];
                    const content = activeBuffer.content;
                    const fileName = activeBuffer.fileName || "untitled.txt";

                    if (window.showSaveFilePicker) {
                        try {
                            const newFileHandle =
                                await window.showSaveFilePicker({
                                    suggestedName: fileName,
                                    types: [
                                        {
                                            description: "Text Files",
                                            accept: {
                                                "text/plain": [
                                                    ".txt",
                                                    ".md",
                                                    ".csv",
                                                    ".js",
                                                    ".html",
                                                    ".css",
                                                    ".json",
                                                ],
                                            },
                                        },
                                    ],
                                });
                            fileHandles.set(activeBuffer.id, newFileHandle);
                            activeBuffer.fileName = newFileHandle.name;
                            const writable =
                                await newFileHandle.createWritable();
                            await writable.write(content);
                            await writable.close();
                            renderActiveBuffer();
                            saveState();
                            return `Saved as ${newFileHandle.name}.`;
                        } catch (err) {
                            if (err.name !== "AbortError") {
                                console.error(
                                    "Error using showSaveFilePicker:",
                                    err,
                                );
                            }
                            return "Save cancelled.";
                        }
                    } else {
                        try {
                            const blob = new Blob([content], {
                                type: "text/plain;charset=utf-8",
                            });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement("a");
                            a.href = url;
                            a.download = fileName;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            return `Downloaded ${fileName}.`;
                        } catch (err) {
                            console.error(
                                "Error using fallback save method:",
                                err,
                            );
                            alert("Could not save the file.");
                            return "Could not save the file.";
                        }
                    }
                };

                const closeFile = () => {
                    hideMenu();
                    if (buffers.length <= 0 || activeBufferIndex < 0)
                        return "No file to close.";

                    const closedFileName = buffers[activeBufferIndex].fileName;
                    fileHandles.delete(buffers[activeBufferIndex].id);
                    buffers.splice(activeBufferIndex, 1);

                    if (buffers.length === 0) {
                        createNewBuffer();
                    } else {
                        if (activeBufferIndex >= buffers.length) {
                            activeBufferIndex = buffers.length - 1;
                        }
                        renderActiveBuffer();
                    }
                    saveState();
                    return `Closed ${closedFileName}.`;
                };

                const nextFile = () => {
                    hideMenu();
                    if (buffers.length > 1) {
                        activeBufferIndex =
                            (activeBufferIndex + 1) % buffers.length;
                        renderActiveBuffer();
                        saveState();
                        return `Switched to ${buffers[activeBufferIndex].fileName}.`;
                    }
                    return "No other files to switch to.";
                };
                const prevFile = () => {
                    hideMenu();
                    if (buffers.length > 1) {
                        activeBufferIndex =
                            (activeBufferIndex - 1 + buffers.length) %
                            buffers.length;
                        renderActiveBuffer();
                        saveState();
                        return `Switched to ${buffers[activeBufferIndex].fileName}.`;
                    }
                    return "No other files to switch to.";
                };

                const openLink = () => {
                    hideMenu();
                    const start = editor.selectionStart;
                    const end = editor.selectionEnd;
                    const fullText = editor.value;
                    const urlRegex = /https?:\/\/[^\s]+/;
                    const urlRegexGlobal = /https?:\/\/[^\s]+/g;

                    let textToScan = "";
                    let urlsToOpen = [];

                    if (start !== end) {
                        textToScan = fullText.substring(start, end);
                        urlsToOpen = textToScan.match(urlRegexGlobal);
                    } else {
                        const lineStart =
                            fullText.lastIndexOf("\n", start - 1) + 1;
                        let lineEnd = fullText.indexOf("\n", start);
                        if (lineEnd === -1) {
                            lineEnd = fullText.length;
                        }
                        textToScan = fullText.substring(lineStart, lineEnd);

                        const singleUrlMatch = textToScan.match(urlRegex);
                        if (singleUrlMatch) {
                            urlsToOpen = [singleUrlMatch[0]];
                        }
                    }

                    if (urlsToOpen && urlsToOpen.length > 0) {
                        if (urlsToOpen.length > 1) {
                            alert(
                                `Found ${urlsToOpen.length} links. Your browser's pop-up blocker may prevent some from opening.`,
                            );
                        }
                        urlsToOpen.forEach((url) => {
                            try {
                                new URL(url);
                                window.open(
                                    url,
                                    "_blank",
                                    "noopener,noreferrer",
                                );
                            } catch (e) {
                                console.warn(`Skipping invalid URL: ${url}`);
                            }
                        });
                    } else {
                        alert(
                            "No valid URL found in the current selection or on the current line.",
                        );
                    }
                };

                const showSnoView = () => {
                    hideMenu();
                    editrContainer.style.display = "none";
                    snoContainer.classList.remove("hidden");
                    sno_init();
                    return "Opening secure notes...";
                };

                // --- ======================= ---
                // --- TEXT EXPANDER CODE ---
                // --- ======================= ---

                const textExpanderModal = document.getElementById(
                    "text-expander-modal",
                );
                const expansionsList =
                    document.getElementById("expansions-list");
                const shortcutInput = document.getElementById(
                    "expansion-shortcut-input",
                );
                const valueInput = document.getElementById(
                    "expansion-value-input",
                );
                const addExpansionBtn =
                    document.getElementById("add-expansion-btn");
                const importBtn = document.getElementById(
                    "import-expansions-btn",
                );
                const exportBtn = document.getElementById(
                    "export-expansions-btn",
                );
                const importFileInput = document.getElementById(
                    "import-expansions-input",
                );

                const EXPANSIONS_STORAGE_KEY = "editrTextExpansions";
                let textExpansions = {};

                const loadTextExpansions = () => {
                    const stored = localStorage.getItem(EXPANSIONS_STORAGE_KEY);
                    if (stored) {
                        try {
                            textExpansions = JSON.parse(stored);
                        } catch (e) {
                            console.error("Could not parse text expansions", e);
                            textExpansions = {};
                        }
                    }
                    renderExpansionsList();
                };

                const saveTextExpansions = () => {
                    localStorage.setItem(
                        EXPANSIONS_STORAGE_KEY,
                        JSON.stringify(textExpansions),
                    );
                };

                const renderExpansionsList = () => {
                    expansionsList.innerHTML = "";
                    if (Object.keys(textExpansions).length === 0) {
                        expansionsList.innerHTML = `<div class="expansion-item" style="color: #888888;">No custom shortcuts defined.</div>`;
                        return;
                    }

                    const sortedKeys = Object.keys(textExpansions).sort();

                    for (const shortcut of sortedKeys) {
                        const value = textExpansions[shortcut];
                        const item = document.createElement("div");
                        item.className = "expansion-item";
                        item.innerHTML = `
                            <span class="expansion-item-shortcut">${sno_escapeHtml(shortcut)}</span>
                            <span class="expansion-item-value">${sno_escapeHtml(value)}</span>
                            <div class="expansion-item-actions">
                                <button class="btn btn-small" data-shortcut="${shortcut}">Edit</button>
                                <button class="btn btn-small btn-danger" data-shortcut="${shortcut}">Del</button>
                            </div>
                        `;
                        expansionsList.appendChild(item);
                    }
                };

                const showTextExpanderModal = () => {
                    hideMenu();
                    renderExpansionsList();
                    textExpanderModal.classList.add("active");
                };

                const hideTextExpanderModal = () => {
                    textExpanderModal.classList.remove("active");
                    shortcutInput.value = "";
                    valueInput.value = "";
                };

                const addOrUpdateExpansion = () => {
                    const shortcut = shortcutInput.value.trim();
                    const value = valueInput.value;

                    if (!shortcut.startsWith(".") || shortcut.length < 2) {
                        alert(
                            "Shortcut must start with '.' and be at least 2 characters long.",
                        );
                        return;
                    }
                    if (shortcut === ".d") {
                        alert(
                            "'.d' is a reserved shortcut for the current date and cannot be modified.",
                        );
                        return;
                    }
                    if (!value) {
                        alert("Expansion value cannot be empty.");
                        return;
                    }

                    textExpansions[shortcut] = value;
                    saveTextExpansions();
                    renderExpansionsList();
                    shortcutInput.value = "";
                    valueInput.value = "";
                    shortcutInput.focus();
                };

                expansionsList.addEventListener("click", (e) => {
                    const shortcut = e.target.dataset.shortcut;
                    if (!shortcut) return;

                    if (e.target.textContent === "Edit") {
                        shortcutInput.value = shortcut;
                        valueInput.value = textExpansions[shortcut];
                        valueInput.focus();
                    } else if (e.target.textContent === "Del") {
                        if (
                            confirm(
                                `Are you sure you want to delete the shortcut "${shortcut}"?`,
                            )
                        ) {
                            delete textExpansions[shortcut];
                            saveTextExpansions();
                            renderExpansionsList();
                        }
                    }
                });

                const handleTextExpansion = (shortcut, event) => {
                    let expansion = null;
                    if (shortcut === ".d") {
                        const d = new Date();
                        const year = d.getFullYear();
                        const month = String(d.getMonth() + 1).padStart(2, "0");
                        const day = String(d.getDate()).padStart(2, "0");
                        expansion = `${year}${month}${day}`;
                    } else if (textExpansions[shortcut]) {
                        expansion = textExpansions[shortcut];
                    }

                    if (expansion !== null) {
                        event.preventDefault();
                        const startPos =
                            editor.selectionStart - shortcut.length;
                        const endPos = editor.selectionStart;

                        // Replace the shortcut with the expansion
                        editor.setSelectionRange(startPos, endPos);
                        document.execCommand("insertText", false, expansion);

                        return true; // Indicate that an expansion happened
                    }
                    return false;
                };

                const exportExpansions = () => {
                    const dataStr =
                        "data:text/json;charset=utf-8," +
                        encodeURIComponent(
                            JSON.stringify(textExpansions, null, 2),
                        );
                    const downloadAnchorNode = document.createElement("a");
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute(
                        "download",
                        "b-edit-expansions.txt",
                    );
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                };

                const importExpansions = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const imported = JSON.parse(e.target.result);
                            if (
                                typeof imported !== "object" ||
                                imported === null
                            ) {
                                throw new Error("Invalid format");
                            }
                            // Simple merge: imported keys overwrite existing ones
                            textExpansions = { ...textExpansions, ...imported };
                            saveTextExpansions();
                            renderExpansionsList();
                            alert("Shortcuts imported successfully!");
                        } catch (err) {
                            alert(
                                "Error importing file. Please make sure it's a valid JSON file.",
                            );
                            console.error("Import error:", err);
                        } finally {
                            // Reset file input to allow importing the same file again
                            importFileInput.value = "";
                        }
                    };
                    reader.readAsText(file);
                };

                // --- MENU & SHORTCUT LISTENERS ---
                document
                    .getElementById("menu-new")
                    .addEventListener("click", newFile);
                document
                    .getElementById("menu-open")
                    .addEventListener("click", openFile);
                document
                    .getElementById("menu-save")
                    .addEventListener("click", saveFile);
                document
                    .getElementById("menu-save-as")
                    .addEventListener("click", saveFileAs);
                document
                    .getElementById("menu-close-file")
                    .addEventListener("click", closeFile);
                document
                    .getElementById("menu-next-file")
                    .addEventListener("click", nextFile);
                document
                    .getElementById("menu-prev-file")
                    .addEventListener("click", prevFile);
                document
                    .getElementById("menu-open-link")
                    .addEventListener("click", openLink);
                document
                    .getElementById("menu-sno")
                    .addEventListener("click", showSnoView);
                document
                    .getElementById("menu-text-expander")
                    .addEventListener("click", showTextExpanderModal);
                document
                    .getElementById("close-expander-modal")
                    .addEventListener("click", hideTextExpanderModal);
                textExpanderModal.addEventListener("click", (e) => {
                    if (e.target === e.currentTarget) hideTextExpanderModal();
                });
                addExpansionBtn.addEventListener("click", addOrUpdateExpansion);
                exportBtn.addEventListener("click", exportExpansions);
                importBtn.addEventListener("click", () =>
                    importFileInput.click(),
                );
                importFileInput.addEventListener("change", importExpansions);

                document.addEventListener("keydown", (e) => {
                    if (isMarkdownView || isCsvView) {
                        if (e.key === "Escape") {
                            if (isMarkdownView) toggleMarkdownPreview();
                            if (isCsvView) toggleCsvGrid();
                        }
                        return;
                    }

                    if (
                        findBar.style.display === "flex" &&
                        e.target === findInput
                    )
                        return;
                    if (snoContainer.classList.contains("hidden") === false) {
                        // SNO shortcuts
                        if (
                            e.key === "Escape" &&
                            document.querySelector(".modal.active")
                        ) {
                            sno_closeModal();
                        }
                        return;
                    }
                    if (textExpanderModal.classList.contains("active")) {
                        if (e.key === "Escape") hideTextExpanderModal();
                        if (
                            e.key === "Enter" &&
                            (e.target === shortcutInput ||
                                e.target === valueInput)
                        ) {
                            addOrUpdateExpansion();
                        }
                        return;
                    }

                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key.toLowerCase()) {
                            case "n":
                                e.preventDefault();
                                newFile();
                                break;
                            case "o":
                                e.preventDefault();
                                openFile();
                                break;
                            case "s":
                                e.preventDefault();
                                saveFile();
                                break;
                            case "u":
                                e.preventDefault();
                                openLink();
                                break;
                            case "f":
                                e.preventDefault();
                                toggleFindBar();
                                break;
                            case "w":
                                e.preventDefault();
                                closeFile();
                                break;
                            case "arrowright":
                                e.preventDefault();
                                nextFile();
                                break;
                            case "arrowleft":
                                e.preventDefault();
                                prevFile();
                                break;
                            case "=":
                                e.preventDefault();
                                showSnoView();
                                break;
                        }
                    }
                    if (e.key === "Escape") {
                        hideFindBar();
                    }
                });

                body.addEventListener("dragover", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    body.classList.add("dragover");
                });
                body.addEventListener("dragleave", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    body.classList.remove("dragover");
                });
                body.addEventListener("drop", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    body.classList.remove("dragover");
                    const file = e.dataTransfer.files[0];
                    if (
                        file &&
                        (file.type.startsWith("text/") ||
                            file.type === "" ||
                            file.name.match(
                                /\.(txt|md|js|html|css|json|xml|csv)$/,
                            ))
                    ) {
                        const reader = new FileReader();
                        reader.onload = (re) => {
                            createNewBuffer(re.target.result, file.name);
                        };
                        reader.readAsText(file);
                    }
                });

                window.addEventListener("beforeunload", () => {
                    if (masterKey && currentPasswordHash) {
                        sno_saveNotesToStorage();
                    }
                });

                // --- INITIALIZATION ---
                loadState();
                loadTextExpansions();
            });

            // --- SERVICE WORKER REGISTRATION ---
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () => {
                    navigator.serviceWorker
                        .register("/sw.js")
                        .then((reg) =>
                            console.log(
                                "SW registration successful:",
                                reg.scope,
                            ),
                        )
                        .catch((err) =>
                            console.log("SW registration failed:", err),
                        );
                });
            }
        </script>
    </body>
</html>
