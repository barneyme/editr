<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link rel="manifest" href="manifest.json" />

        <meta name="theme-color" content="#3d3d3d" />

        <link
            rel="icon"
            href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><rect width="16" height="16" fill="%23808080"/><text x="50%" y="55%" font-family="sans-serif" font-size="12" font-weight="bold" fill="white" text-anchor="middle" dominant-baseline="middle">e</text></svg>'
        />
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>

        <style>
            /* --- edit Base Styles --- */
            body,
            html {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
                font-family: "Inter", sans-serif;
                background-color: #2d2d2d; /* New Orange Theme background */
                transition: background-color 0.2s;
                color: #f0f0f0;
            }

            #edit-container {
                width: 100%;
                height: 100%;
                position: relative;
            }

            #line-indicator {
                position: absolute;
                top: 2rem;
                left: 0;
                width: 4px;
                height: 25.6px;
                background-color: #ffb74d; /* Light Orange */
                z-index: 1;
                transition: top 0.1s ease-out;
                opacity: 0.5;
                pointer-events: none;
            }

            #editor {
                width: 100%;
                height: 100%;
                padding: 2rem;
                border: none;
                outline: none;
                resize: none;
                background-color: transparent;
                color: #f8f8f2; /* <<< KEPT THIS COLOR AS REQUESTED */
                font-family: "Fira Code", "Courier New", monospace;
                font-size: 16px;
                line-height: 1.6;
                box-sizing: border-box;
            }

            body.dragover {
                background-color: #383838;
            }
            #editor {
                border: 2px dashed transparent;
                box-sizing: border-box;
            }
            body.dragover #editor {
                border-color: #ff9800; /* Main Orange */
            }

            #editor::placeholder {
                color: #888888; /* Subtle */
                opacity: 1;
            }

            /* --- Markdown Preview Styles --- */
            #markdown-preview {
                padding: 2rem 4rem;
                height: 100vh;
                overflow-y: auto;
                box-sizing: border-box;
                color: #f0f0f0;
                max-width: 800px;
                margin: 0 auto;
                line-height: 1.7;
            }
            #markdown-preview h1 {
                font-size: 2.5em;
                font-weight: 600;
                margin-top: 0;
                margin-bottom: 0.7em;
                color: #ff9800; /* Main Orange */
                border-bottom: 1px solid #888888;
                padding-bottom: 0.3em;
            }
            #markdown-preview h2 {
                font-size: 2em;
                font-weight: 600;
                margin-top: 1.5em;
                margin-bottom: 0.6em;
                color: #ff9800; /* Main Orange */
                border-bottom: 1px solid #888888;
                padding-bottom: 0.3em;
            }
            #markdown-preview h3 {
                font-size: 1.5em;
                font-weight: 600;
                margin-top: 1.5em;
                margin-bottom: 0.5em;
                color: #ff9800; /* Main Orange */
            }
            #markdown-preview h4 {
                font-size: 1.2em;
                font-weight: 600;
                margin-top: 1.5em;
                margin-bottom: 0.5em;
                color: #ff9800; /* Main Orange */
            }
            #markdown-preview p {
                margin-bottom: 1.2em;
            }
            #markdown-preview a {
                color: #ffb74d;
                text-decoration: none;
            } /* Light Orange */
            #markdown-preview a:hover {
                text-decoration: underline;
            }
            #markdown-preview code {
                background-color: #3d3d3d;
                padding: 0.2em 0.4em;
                border-radius: 4px;
                font-family: "Fira Code", monospace;
                font-size: 0.9em;
            }
            #markdown-preview pre {
                background-color: #262626;
                padding: 1em;
                border-radius: 5px;
                border: 1px solid #3d3d3d;
                overflow-x: auto;
                margin-bottom: 1.2em;
            }
            #markdown-preview pre code {
                background-color: transparent;
                padding: 0;
                font-size: 1em;
            }
            #markdown-preview blockquote {
                border-left: 4px solid #888888;
                padding-left: 1em;
                color: #a9b1d6;
                margin-left: 0;
                margin-bottom: 1.2em;
            }
            #markdown-preview ul,
            #markdown-preview ol {
                padding-left: 2em;
                margin-bottom: 1.2em;
            }
            #markdown-preview li {
                margin-bottom: 0.5em;
            }
            #markdown-preview table {
                border-collapse: collapse;
                width: 100%;
                margin: 1.5em 0;
            }
            #markdown-preview th,
            #markdown-preview td {
                border: 1px solid #888888;
                padding: 0.6em 0.8em;
            }
            #markdown-preview th {
                background-color: #3d3d3d;
                font-weight: 600;
            }
            #markdown-preview hr {
                border: 0;
                height: 1px;
                background-color: #888888;
                margin: 2.5em 0;
            }
            #markdown-preview .toc {
                background-color: #3d3d3d;
                border: 1px solid #888888;
                border-radius: 5px;
                padding: 1em 1.5em;
                margin-bottom: 2em;
            }
            #markdown-preview .toc h3 {
                margin-top: 0;
                color: #f0f0f0;
            }
            #markdown-preview .toc ul {
                padding-left: 1em;
                list-style-type: none;
            }
            #markdown-preview .toc li {
                margin-bottom: 0.7em;
            }

            /* --- CSV Grid Styles --- */
            #csv-grid {
                padding: 2rem;
                height: 100vh;
                overflow: auto;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
            }
            #csv-grid-table-container {
                flex-grow: 1;
                overflow: auto;
            }
            #csv-grid table {
                width: 100%;
                border-collapse: collapse;
                font-family: "Fira Code", monospace;
                font-size: 14px;
            }
            #csv-grid th,
            #csv-grid td {
                border: 1px solid #3d3d3d;
                padding: 8px 12px;
                text-align: left;
                white-space: nowrap;
            }
            #csv-grid th .csv-header-sortable {
                cursor: pointer;
                user-select: none;
            }
            #csv-grid th .csv-header-sortable:hover {
                color: #ffb74d; /* Light Orange */
            }
            #csv-grid thead {
                background-color: #3d3d3d;
                color: #f0f0f0;
                position: sticky;
                top: 0;
                z-index: 10;
            }
            #csv-grid tbody tr:nth-child(even) {
                background-color: #383838;
            }
            #csv-grid td[contenteditable="true"],
            #csv-grid th span[contenteditable="true"] {
                background-color: #2d2d2d;
                outline: none;
            }
            #csv-grid td[contenteditable="true"]:focus,
            #csv-grid th span[contenteditable="true"]:focus {
                background-color: #3d3d3d;
                outline: 2px solid #ff9800;
                box-shadow: 0 0 0 2px #2d2d2d;
            }
            .csv-action-btn {
                background: none;
                border: none;
                cursor: pointer;
                padding: 2px;
                font-size: 14px;
                color: #ff5555;
                opacity: 0.5;
                transition: opacity 0.2s;
            }
            .csv-action-btn:hover {
                opacity: 1;
            }
            #csv-grid th .csv-action-btn {
                color: #ff9800; /* Main Orange */
            }
            #csv-controls {
                padding-top: 1rem;
                flex-shrink: 0;
                display: flex;
                gap: 0.5rem;
            }

            #top-right-container {
                position: fixed;
                top: 16px;
                right: 24px;
                display: flex;
                align-items: center;
                gap: 16px;
                z-index: 1001;
            }

            #menu-trigger {
                width: 24px;
                height: 24px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 4px;
                transition: background-color 0.2s;
            }

            #menu-trigger:hover {
                background-color: rgba(255, 255, 255, 0.1);
            }

            #context-menu {
                position: fixed;
                display: none;
                z-index: 1000;
                background-color: #3d3d3d;
                border: 1px solid #888888;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                min-width: 180px;
                padding: 8px 0;
            }

            .menu-item {
                padding: 10px 20px;
                cursor: pointer;
                color: #f0f0f0;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 14px;
            }

            .menu-item:hover {
                background-color: #888888;
            }

            .menu-item .shortcut {
                color: #ff9800; /* Main Orange */
                font-size: 12px;
            }

            .menu-item .view-btn {
                padding: 4px 10px;
                border: 1px solid #888888;
                border-radius: 4px;
                background-color: transparent;
                color: #f0f0f0;
                cursor: pointer;
                font-size: 12px;
                transition: background-color 0.2s;
            }
            .menu-item .view-btn:hover {
                background-color: #ff9800;
                border-color: #ff9800;
            }
            .menu-item .view-btn.active {
                background-color: #ffd600; /* Yellow */
                border-color: #ffd600;
            }

            .menu-item a {
                color: inherit;
                text-decoration: none;
                cursor: pointer;
                display: block;
                width: 100%;
            }

            .menu-separator {
                height: 1px;
                background-color: #888888;
                margin: 8px 0;
            }

            #stats-display {
                color: #888888;
                font-family: "Fira Code", "Courier New", monospace;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 16px;
                background-color: rgba(61, 61, 61, 0.5);
                padding: 4px 12px;
                border-radius: 6px;
                transition: opacity 0.3s;
            }
            #stats-filename {
                color: #e0e0e0;
                max-width: 200px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .hidden {
                display: none !important;
            }

            #find-bar {
                position: fixed;
                bottom: 16px;
                right: 16px;
                background-color: #3d3d3d;
                border: 1px solid #888888;
                border-radius: 8px;
                padding: 8px;
                display: none;
                align-items: center;
                gap: 8px;
                z-index: 1001;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            #find-input {
                background-color: #2d2d2d;
                border: 1px solid #888888;
                color: #f0f0f0;
                border-radius: 4px;
                padding: 4px 8px;
                outline: none;
                width: 200px;
            }

            #find-input:focus {
                border-color: #ff9800;
            }

            .find-btn {
                background-color: transparent;
                border: none;
                color: #f0f0f0;
                cursor: pointer;
                padding: 4px;
                border-radius: 4px;
            }
            .find-btn:hover {
                background-color: #888888;
            }

            /* --- Integrated SNO Styles (Orange Themed) --- */
            #sno-container {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 10px;
                height: 100vh;
            }

            .login-screen {
                background: #2d2d2d;
                border-radius: 8px;
                padding: 30px;
                border: 1px solid #888888;
                max-width: 400px;
                margin: 0 auto;
            }

            #sno-container h1 {
                color: #f0f0f0;
                margin-bottom: 25px;
                font-size: 1.8em;
                font-weight: 600;
                text-align: center;
            }

            .input-group {
                margin-bottom: 15px;
                text-align: left;
            }

            #sno-container label {
                display: block;
                margin-bottom: 5px;
                color: #f0f0f0;
                font-weight: 500;
                font-size: 14px;
            }

            #sno-container input[type="password"] {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #888888;
                border-radius: 4px;
                font-size: 14px;
                background: #2d2d2d;
                color: #f0f0f0;
            }

            #sno-container input[type="password"]:focus {
                outline: none;
                border-color: #ff9800; /* Main Orange */
            }

            .btn {
                background: #ff9800; /* Main Orange */
                color: #2d2d2d;
                border: 1px solid #ff9800;
                padding: 8px 16px;
                border-radius: 4px;
                font-size: 14px;
                cursor: pointer;
                transition: background 0.2s ease;
                font-weight: 500;
            }

            .btn:hover {
                background: #ffb74d;
            }

            .error-message {
                color: #ff5555;
                font-size: 13px;
                margin-top: 5px;
                text-align: left;
            }

            .storage-info {
                font-size: 12px;
                color: #888888;
                margin-top: 20px;
                text-align: center;
            }

            /* Text Expander Modal Styles */
            #text-expander-modal .modal-content {
                max-width: 800px;
            }
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                z-index: 1000;
            }

            .modal.active {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .modal-content {
                background: #2d2d2d;
                border-radius: 8px;
                padding: 25px;
                max-width: 700px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                border: 1px solid #ff9800;
            }
            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }
            .modal-header h2 {
                font-size: 1.4em;
                color: #f0f0f0;
            }

            .close-btn {
                background: none;
                border: none;
                font-size: 22px;
                cursor: pointer;
                color: #888888;
            }
            #expansions-list {
                max-height: 30vh;
                overflow-y: auto;
                border: 1px solid #3d3d3d;
                border-radius: 4px;
                margin-bottom: 15px;
            }
            .expansion-item {
                display: flex;
                align-items: center;
                padding: 8px 12px;
                border-bottom: 1px solid #3d3d3d;
            }
            .expansion-item:last-child {
                border-bottom: none;
            }
            .expansion-item-shortcut {
                font-family: "Fira Code", monospace;
                color: #ffb74d; /* Light Orange */
                width: 100px;
                flex-shrink: 0;
            }
            .expansion-item-value {
                flex-grow: 1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                color: #f0f0f0;
            }
            .expansion-item-actions {
                margin-left: 15px;
            }
            #new-expansion-form {
                display: grid;
                grid-template-columns: 150px 1fr;
                gap: 10px;
                align-items: center;
                margin-bottom: 20px;
            }
            #new-expansion-form input,
            #new-expansion-form textarea {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #888888;
                border-radius: 4px;
                font-size: 14px;
                background: #2d2d2d;
                color: #f0f0f0;
                font-family: inherit;
            }
            #new-expansion-form textarea {
                grid-column: 1 / -1;
                resize: vertical;
                min-height: 80px;
            }
            .btn-secondary {
                background: #ffb74d; /* Light Orange */
                border-color: #ffb74d;
                color: #2d2d2d;
                margin-left: 8px;
            }
            .btn-secondary:hover {
                background: #ffcc80;
            }

            .btn-danger {
                background: #ff5555; /* Red */
                border-color: #ff5555;
            }
            .btn-danger:hover {
                background: #ff7070;
            }
            .btn-small {
                padding: 5px 10px;
                font-size: 12px;
                border-radius: 4px;
            }
        </style>

        <style media="print">
            /* --- Print Styles --- */
            body * {
                visibility: hidden;
            }
            #markdown-preview,
            #markdown-preview * {
                visibility: visible;
            }
            #markdown-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                padding: 2cm;
                color: #000 !important;
                background-color: #fff !important;
                max-width: 100%;
            }
            #markdown-preview h1,
            #markdown-preview h2,
            #markdown-preview h3,
            #markdown-preview h4,
            #markdown-preview a {
                color: #000 !important;
            }
        </style>

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Inter:wght@400;500;600&display=swap"
            rel="stylesheet"
        />
    </head>
    <body>
        <div id="edit-container">
            <div id="line-indicator"></div>
            <textarea
                id="editor"
                spellcheck="false"
                placeholder="Right-click or ☰ for menu."
            ></textarea>
        </div>

        <div id="markdown-preview" class="hidden"></div>
        <div id="csv-grid" class="hidden"></div>

        <div id="top-right-container">
            <div id="stats-display">
                <span id="stats-filename"></span>
                <span id="stats-line">↓ 1</span>
                <span id="stats-char">→ 1</span>
                <span id="stats-words">= 0</span>
            </div>

            <div id="menu-trigger" title="Menu">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="#f0f0f0"
                    viewBox="0 0 256 256"
                >
                    <path
                        d="M224,128a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,128ZM40,72H216a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16ZM216,184H40a8,8,0,0,0,0,16H216a8,8,0,0,0,0-16Z"
                    ></path>
                </svg>
            </div>
        </div>

        <div id="context-menu">
            <div class="menu-item" id="menu-new">
                <span>New</span>
                <span class="shortcut">Ctrl + N</span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-item" id="menu-open">
                <span>Open</span>
                <span class="shortcut">Ctrl + O</span>
            </div>
            <div
                class="menu-item"
                style="
                    padding: 0;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                "
            >
                <div
                    style="
                        display: flex;
                        gap: 0.5rem;
                        align-items: center;
                        padding: 10px 20px;
                    "
                >
                    <a id="menu-save" style="cursor: pointer">Save</a>
                    <a id="menu-save-as" style="cursor: pointer">(As)</a>
                </div>
                <span class="shortcut" style="padding-right: 20px"
                    >Ctrl + S</span
                >
            </div>
            <div class="menu-item" id="menu-close-file">
                <span>Close</span>
                <span class="shortcut">Ctrl + W</span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-item" id="menu-next-file">
                <span>Next</span>
                <span class="shortcut">Ctrl + →</span>
            </div>
            <div class="menu-item" id="menu-prev-file">
                <span>Last</span>
                <span class="shortcut">Ctrl + ←</span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-item" id="menu-find">
                <span>Find</span>
                <span class="shortcut">Ctrl + F</span>
            </div>
            <div class="menu-separator"></div>
            <div class="menu-item" id="menu-sno">
                <span>Lock</span>
                <span class="shortcut">Ctrl + =</span>
            </div>
            <div class="menu-separator menu-item-md hidden"></div>
            <div class="menu-item menu-item-md hidden" id="menu-save-html">
                <span>HTML</span>
            </div>
            <div class="menu-item menu-item-md hidden" id="menu-save-pdf">
                <span>PDF</span>
            </div>
            <div class="menu-separator"></div>
            <div
                class="menu-item"
                style="display: flex; gap: 1rem; padding: 10px 20px"
            >
                <a id="menu-help" style="cursor: pointer">Help</a>
                <a id="menu-text-expander" style="cursor: pointer">Text</a>
                <div style="flex-grow: 1"></div>
                <button id="menu-csv-view" class="view-btn">CSV</button>
                <button id="menu-md-view" class="view-btn">MD</button>
            </div>
        </div>

        <div id="find-bar">
            <input type="text" id="find-input" placeholder="Find..." />
            <button
                id="find-prev"
                class="find-btn"
                title="Previous (Shift+Enter)"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    viewBox="0 0 256 256"
                >
                    <path
                        d="M224,128a8,8,0,0,1-8,8H122.34l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L122.34,120H216A8,8,0,0,1,224,128ZM40,40a8,8,0,0,0-8,8V208a8,8,0,0,0,16,0V48A8,8,0,0,0,40,40Z"
                    ></path>
                </svg>
            </button>
            <button id="find-next" class="find-btn" title="Next (Enter)">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    viewBox="0 0 256 256"
                >
                    <path
                        d="M216,40a8,8,0,0,0-8-8H48a8,8,0,0,0-8,8V208a8,8,0,0,0,16,0V48H208A8,8,0,0,0,216,40ZM133.66,122.34,75.31,64.05a8,8,0,0,0-11.31,11.31L122.34,128,64,180.69a8,8,0,0,0,11.31,11.31L133.66,133.66a8,8,0,0,0,0-11.32Z"
                    ></path>
                </svg>
            </button>
            <button id="find-close" class="find-btn" title="Close (Esc)">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    fill="currentColor"
                    viewBox="0 0 256 256"
                >
                    <path
                        d="M208.49,191.51a12,12,0,0,1-17,17L128,145,64.49,208.49a12,12,0,0,1-17-17L111,128,47.51,64.49a12,12,0,0,1,17-17L128,111,63.51-63.52a12,12,0,0,1,17,17L145,128Z"
                    ></path>
                </svg>
            </button>
        </div>

        <div id="sno-container" class="hidden">
            <div id="loginScreen" class="login-screen">
                <h1>Lock</h1>
                <div class="input-group">
                    <label for="masterPassword">Password</label>
                    <input
                        type="password"
                        id="masterPassword"
                        placeholder="Enter your password"
                    />
                    <div id="loginError" class="error-message"></div>
                </div>
                <button class="btn" onclick="sno_unlockAndLoadBuffer()">
                    Unlock
                </button>
                <div class="storage-info">
                    Data is encrypted and stored locally in your browser.
                </div>
            </div>
        </div>

        <div id="text-expander-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Text Expander</h2>
                    <button id="close-expander-modal" class="close-btn">
                        &times;
                    </button>
                </div>

                <h3>Date Shortcut (.d)</h3>
                <div
                    style="
                        display: flex;
                        gap: 10px;
                        align-items: center;
                        margin-bottom: 20px;
                    "
                >
                    <input
                        type="text"
                        id="date-format-input"
                        placeholder="e.g., YYYY-MM-DD"
                        style="
                            flex-grow: 1;
                            padding: 8px 12px;
                            border: 1px solid #888888;
                            border-radius: 4px;
                            font-size: 14px;
                            background: #2d2d2d;
                            color: #f0f0f0;
                            font-family: &quot;Fira Code&quot;, monospace;
                        "
                    />
                    <button id="save-date-format-btn" class="btn">
                        Save Format
                    </button>
                </div>
                <p
                    style="
                        font-size: 12px;
                        color: #888;
                        margin-top: -15px;
                        margin-bottom: 20px;
                    "
                >
                    Use: DD, MM, MMM, YY, YYYY. Separators: - /
                </p>

                <h3>My Shortcuts</h3>
                <div id="expansions-list"></div>

                <h3>Add/Edit Shortcut</h3>
                <div id="new-expansion-form">
                    <input
                        type="text"
                        id="expansion-shortcut-input"
                        placeholder=".letter (EG .a)"
                    />
                    <button id="add-expansion-btn" class="btn">
                        Add/Update
                    </button>
                    <textarea
                        id="expansion-value-input"
                        placeholder="Enter the text to expand to..."
                    ></textarea>
                </div>

                <div
                    style="
                        text-align: right;
                        margin-top: 20px;
                        display: flex;
                        justify-content: flex-end;
                        gap: 10px;
                    "
                >
                    <button
                        id="import-expansions-btn"
                        class="btn btn-secondary"
                    >
                        Import
                    </button>
                    <button
                        id="export-expansions-btn"
                        class="btn btn-secondary"
                    >
                        Export
                    </button>
                </div>
                <input
                    type="file"
                    id="import-expansions-input"
                    class="hidden"
                    accept=".txt"
                />
            </div>
        </div>

        <div id="help-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Help</h2>
                    <button id="close-help-modal" class="close-btn">
                        &times;
                    </button>
                </div>
                <div
                    style="
                        max-height: 60vh;
                        overflow-y: auto;
                        padding-right: 15px;
                    "
                >
                    <style>
                        .help-section {
                            margin-top: 1.5rem;
                            margin-bottom: 1.5rem;
                            padding-bottom: 1rem;
                            border-bottom: 1px solid #555;
                        }
                        .help-section:last-child {
                            border-bottom: none;
                            margin-bottom: 0;
                        }
                        .help-section h3 {
                            font-size: 1.25em;
                            font-weight: 600;
                            margin-bottom: 0.75rem;
                            color: #ffb74d;
                        }
                        .help-section h4 {
                            font-size: 1.1em;
                            font-weight: 500;
                            margin-top: 1rem;
                            margin-bottom: 0.5rem;
                            color: #e0e0e0;
                        }
                        .help-section ul {
                            padding-left: 20px;
                            line-height: 1.6;
                        }
                        .help-section li {
                            margin-bottom: 0.5rem;
                        }
                        .help-section pre {
                            background-color: #262626;
                            padding: 0.5em 1em;
                            border-radius: 4px;
                            margin-top: 0.5rem;
                        }
                        .help-section code {
                            font-family: "Fira Code", monospace;
                            color: #ffb74d;
                        }
                        .help-section li code {
                            color: #ffb74d;
                            background-color: #3d3d3d;
                            padding: 2px 5px;
                            border-radius: 3px;
                        }
                        .help-section strong {
                            color: #f0f0f0;
                        }
                    </style>
                    <div class="help-section">
                        <h3>File Management</h3>
                        <ul>
                            <li>
                                <strong>New (Ctrl + N):</strong> Opens a new
                                editor in a new browser tab.
                            </li>
                            <li>
                                <strong>Open (Ctrl + O):</strong> Open a text,
                                markdown, or CSV file from your computer.
                            </li>
                            <li>
                                <strong>Save (Ctrl + S):</strong> Saves the
                                current file. If opened from your computer, it
                                will try to save back to the original file.
                                Otherwise, it will prompt you to "Save As".
                            </li>
                            <li>
                                <strong>Save As:</strong> Lets you save the
                                current text to a new file on your computer.
                            </li>
                            <li>
                                <strong
                                    >Next/Last File (Ctrl + → / Ctrl +
                                    ←):</strong
                                >
                                Cycle between open files (buffers).
                            </li>
                            <li>
                                <strong>Close File (Ctrl + W):</strong> Closes
                                the current file.
                            </li>
                        </ul>
                    </div>

                    <div class="help-section">
                        <h3>Core Editing</h3>
                        <ul>
                            <li>
                                <strong>Standard Text Editing:</strong> Supports
                                features like tab indentation, auto-pairing of
                                brackets `()`, `[]`, `{}`, quotes `""`, `''`,
                                and backticks ` `` `.
                            </li>
                            <li>
                                <strong>Auto-Indented Lists:</strong> Pressing
                                `Enter` in a bulleted (`*`, `-`) or numbered
                                (`1.`) list automatically continues the list.
                                Press `Enter` on an empty list item to exit the
                                list.
                            </li>
                            <li>
                                <strong>Drag & Drop:</strong> Drag a text file
                                from your computer and drop it onto the window
                                to open it.
                            </li>
                        </ul>
                    </div>

                    <div class="help-section">
                        <h3>Markdown Shortcuts</h3>
                        <ul>
                            <li><strong>Bold:</strong> `Ctrl + B`</li>
                            <li><strong>Italics:</strong> `Ctrl + I`</li>
                            <li>
                                <strong>Strikethrough:</strong> `Ctrl + Shift +
                                S`
                            </li>
                            <li>
                                <strong>To-Do Item:</strong> `Ctrl + Shift + C`
                            </li>
                            <li><strong>Link:</strong> `Ctrl + K`</li>
                            <li><strong>Image:</strong> `Ctrl + Shift + I`</li>
                            <li>
                                <strong>Heading:</strong> `Ctrl + H` to cycle
                                levels
                            </li>
                            <li>
                                <strong>Blockquote:</strong> `Ctrl + Shift +> `
                            </li>
                            <li><strong>Inline Code:</strong> `Ctrl + E`</li>
                            <li><strong>Insert Table:</strong> `Ctrl + T`</li>
                            <li>
                                <strong>Insert Horizontal Rule:</strong> `Ctrl +
                                -`
                            </li>
                        </ul>
                        <ul>
                            <li>
                                <strong>Table Column Alignment:</strong> You can
                                align content in table columns by adding colons
                                to the header separator line.
                                <pre><code>| Left | Center | Right |
|:---|:------:|------:|
| a  |    b   |     c |</code></pre>
                            </li>
                        </ul>
                    </div>

                    <div class="help-section">
                        <h3>Views</h3>
                        <ul>
                            <li>
                                <strong>CSV View:</strong> Renders
                                comma-separated text in an editable grid. You
                                can add/delete rows and columns, edit cells, and
                                the underlying text is updated automatically.
                            </li>
                            <li>
                                <strong>MD View:</strong> Renders Markdown text
                                as formatted HTML. From this view, you can save
                                the content as a self-contained HTML file or
                                print it (e.g., to a PDF).
                            </li>
                        </ul>
                    </div>

                    <div class="help-section">
                        <h3>Table of Contents</h3>
                        <ul>
                            <li>
                                For long documents, you can automatically
                                generate a Table of Contents (ToC).
                            </li>
                            <li>
                                Simply type <code>[TOC]</code> on its own line
                                where you want the table of contents to appear.
                            </li>
                            <li>
                                When you switch to <strong>MD View</strong>,
                                this tag will be replaced with a clickable list
                                of all the headings (e.g.,
                                <code># Heading 1</code>,
                                <code>## Subheading</code>) in your document.
                            </li>
                        </ul>
                    </div>

                    <div class="help-section">
                        <h3>To-Do Lists</h3>
                        <ul>
                            <li>
                                You can create interactive to-do lists directly
                                in your text. This is powered by Markdown.
                            </li>
                            <li>
                                Use <code>- [ ]</code> for an incomplete task
                                and <code>- [x]</code> for a completed task.
                            </li>
                            <li>
                                When viewed in <strong>MD View</strong>, these
                                will be rendered as clickable checkboxes.
                            </li>
                            <li>
                                <strong>Shortcut:</strong> Use
                                <code>Ctrl + Shift + C</code> to insert a new
                                to-do item on the current line.
                            </li>
                        </ul>
                        <pre><code>- [ ] Finish report
- [x] Send email
- [ ] Start new project</code></pre>
                    </div>

                    <div class="help-section">
                        <h3>Text Expander</h3>
                        <ul>
                            <li>
                                <strong>Open Manager:</strong> Click "Text" in
                                the main menu to add, edit, or remove text
                                expansion shortcuts.
                            </li>
                            <li>
                                <strong>Usage:</strong> In the editor, type a
                                shortcut (e.g., <code>.sig</code>) followed by a
                                <strong>space</strong> or
                                <strong>Enter</strong> to replace it with its
                                full text.
                            </li>
                            <li>
                                <strong>Rules:</strong> Shortcuts must start
                                with a period (<code>.</code>) and be at least
                                two characters long.
                            </li>
                            <li>
                                <strong>Built-in Date Shortcut:</strong> The
                                shortcut <code>.d</code> expands to the current
                                date. You can customize its format in the Text
                                Expander manager using <code>DD</code>,
                                <code>MM</code>, <code>MMM</code>,
                                <code>YY</code>, <code>YYYY</code> with
                                <code>-</code> or <code>/</code> separators.
                            </li>
                            <li>
                                <strong>Import/Export:</strong> You can back up
                                your shortcuts to a file or import them from
                                another machine using the manager.
                            </li>
                        </ul>
                    </div>

                    <div class="help-section">
                        <h3>Productivity Shortcuts</h3>
                        <ul>
                            <li><strong>Find:</strong> `Ctrl + F`</li>
                            <li>
                                <strong>Open Link in Text:</strong> `Ctrl + U`
                            </li>
                            <li><strong>Lock Note:</strong> `Ctrl + =`</li>
                            <li>
                                <strong>Email File:</strong> `Ctrl + Shift + E`
                                - Opens your default email client with the
                                current file's content in a new message.
                            </li>
                            <li>
                                <strong>New Calendar:</strong> `Ctrl + J` -
                                Opens a new buffer with the current date and a
                                text-based calendar for the current month.
                            </li>
                            <li>
                                <strong>New Calculator:</strong> `Ctrl + M` -
                                Opens a text-based calculator. Type an equation
                                (e.g., `(5+3)*2`) and press Enter to see the
                                result.
                            </li>
                        </ul>
                    </div>

                    <div class="help-section">
                        <h3>Install</h3>
                        <ul>
                            <li>
                                <a
                                    href="https://sourceforge.net/projects/edit/files/latest/download"
                                    >Download for Windows and Mac</a
                                >
                            </li>
                            <li>
                                <a
                                    href="#"
                                    id="pwa-install-link"
                                    style="display: none; cursor: pointer"
                                    >Install as an App (PWA)</a
                                >
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                // --- DOM ELEMENTS ---
                const editor = document.getElementById("editor");
                const lineIndicator = document.getElementById("line-indicator");
                const contextMenu = document.getElementById("context-menu");
                const menuTrigger = document.getElementById("menu-trigger");
                const statsDisplay = document.getElementById("stats-display");
                const statsFileName = document.getElementById("stats-filename");
                const statsLine = document.getElementById("stats-line");
                const statsChar = document.getElementById("stats-char");
                const statsWords = document.getElementById("stats-words");
                const findBar = document.getElementById("find-bar");
                const findInput = document.getElementById("find-input");
                const findPrev = document.getElementById("find-prev");
                const findNext = document.getElementById("find-next");
                const findClose = document.getElementById("find-close");
                const body = document.body;
                const editContainer = document.getElementById("edit-container");
                const snoContainer = document.getElementById("sno-container");
                const markdownPreview =
                    document.getElementById("markdown-preview");
                const csvGrid = document.getElementById("csv-grid");
                const mdViewBtn = document.getElementById("menu-md-view");
                const csvViewBtn = document.getElementById("menu-csv-view");
                const mdMenuItems = document.querySelectorAll(".menu-item-md");
                const saveHtmlBtn = document.getElementById("menu-save-html");
                const savePdfBtn = document.getElementById("menu-save-pdf");
                const helpModal = document.getElementById("help-modal");

                // --- ================================== --- //
                // --- SNO (Secure Note) INTEGRATION CODE --- //
                // --- ================================== --- //

                let masterKey = null;
                let notes = [];
                let currentPasswordHash = null;
                const STORAGE_KEY = "sno_secure_note_vault";
                const VAULT_VERSION = "1.0";

                function sno_showError(message) {
                    const loginScreen = document.getElementById("loginScreen");
                    let errorDiv = document.getElementById("criticalError");
                    if (!errorDiv) {
                        errorDiv = document.createElement("div");
                        errorDiv.id = "criticalError";
                        errorDiv.style.color = "#ff5555";
                        errorDiv.style.marginTop = "15px";
                        errorDiv.style.fontWeight = "bold";
                        loginScreen.appendChild(errorDiv);
                    }
                    errorDiv.textContent = message;
                }

                function sno_isLocalStorageAvailable() {
                    try {
                        const test = "__storage_test__";
                        localStorage.setItem(test, test);
                        localStorage.removeItem(test);
                        return true;
                    } catch (e) {
                        return false;
                    }
                }

                function sno_loadVaultsFromStorage() {
                    try {
                        const stored = localStorage.getItem(STORAGE_KEY);
                        if (stored) {
                            const data = JSON.parse(stored);
                            if (data.version === VAULT_VERSION) {
                                return data.vaults || {};
                            }
                        }
                    } catch (e) {
                        console.error("Error loading vaults from storage:", e);
                    }
                    return {};
                }

                function sno_saveVaultsToStorage(vaults) {
                    try {
                        const data = {
                            version: VAULT_VERSION,
                            vaults: vaults,
                            lastUpdated: new Date().toISOString(),
                        };
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                        return true;
                    } catch (e) {
                        console.error("Error saving vaults to storage:", e);
                        if (e.name === "QuotaExceededError") {
                            sno_showError(
                                "Storage quota exceeded. Please delete some notes.",
                            );
                        }
                        return false;
                    }
                }

                function sno_hashPassword(password) {
                    return CryptoJS.SHA256(password + "sno-salt-v1").toString();
                }

                function sno_unlockAndLoadBuffer() {
                    const password =
                        document.getElementById("masterPassword").value;
                    const errorElement = document.getElementById("loginError");

                    if (!password) {
                        errorElement.textContent = "Please enter a password";
                        return;
                    }

                    masterKey = CryptoJS.PBKDF2(password, "sno-salt-v1", {
                        keySize: 256 / 32,
                        iterations: 10000,
                    });

                    currentPasswordHash = sno_hashPassword(password);
                    const userVaults = sno_loadVaultsFromStorage();

                    if (userVaults[currentPasswordHash]) {
                        try {
                            const encryptedNotes =
                                userVaults[currentPasswordHash];
                            const decryptedData = CryptoJS.AES.decrypt(
                                encryptedNotes,
                                masterKey.toString(),
                            ).toString(CryptoJS.enc.Utf8);
                            if (!decryptedData)
                                throw new Error("Decryption failed");
                            notes = JSON.parse(decryptedData);
                        } catch (e) {
                            console.error("Decryption error:", e);
                            errorElement.textContent =
                                "Invalid password - unable to decrypt notes.";
                            return;
                        }
                    } else {
                        notes = []; // New vault
                    }

                    errorElement.textContent = "";
                    document.getElementById("masterPassword").value = "";
                    snoContainer.classList.add("hidden");
                    editContainer.style.display = "block";

                    const notesText = sno_formatNotesToText(notes);
                    createNewBuffer(notesText, "Locked-Notes.txt", null, {
                        isSno: true,
                    });
                }

                function sno_saveSnoBuffer() {
                    if (!masterKey || !currentPasswordHash) return false;
                    const snoBuffer = buffers.find((b) => b.isSno);
                    if (!snoBuffer) return false;

                    const newNotes = sno_parseTextToNotes(snoBuffer.content);

                    try {
                        const userVaults = sno_loadVaultsFromStorage();
                        const notesJson = JSON.stringify(newNotes);
                        const encryptedNotes = CryptoJS.AES.encrypt(
                            notesJson,
                            masterKey.toString(),
                        ).toString();
                        userVaults[currentPasswordHash] = encryptedNotes;
                        sno_saveVaultsToStorage(userVaults);
                        return true;
                    } catch (e) {
                        console.error("Encryption or storage error:", e);
                        sno_showError(
                            "Failed to save notes. Check browser storage.",
                        );
                        return false;
                    }
                }

                function sno_formatNotesToText(notes) {
                    return notes
                        .map((note) => `\n---\n\n${note.content}`)
                        .join("");
                }

                function sno_parseTextToNotes(text) {
                    if (!text || text.trim() === "") return [];
                    return text
                        .split(/\n---\n/)
                        .map((content) => ({ content: content.trim() }))
                        .filter((note) => note.content !== "");
                }

                function sno_toggleLockScreen() {
                    if (snoContainer.classList.contains("hidden")) {
                        snoContainer.classList.remove("hidden");
                        editContainer.style.display = "none";
                    } else {
                        snoContainer.classList.add("hidden");
                        editContainer.style.display = "block";
                    }
                }

                function sno_checkForExistingVaults() {
                    const vaults = sno_loadVaultsFromStorage();
                    const hasVaults = Object.keys(vaults).length > 0;
                    if (hasVaults) {
                        sno_toggleLockScreen();
                    } else {
                        editContainer.style.display = "block";
                        snoContainer.classList.add("hidden");
                    }
                }

                // --- ================================ --- //
                // --- GENERAL APPLICATION CODE --- //
                // --- ================================ --- //

                let buffers = [
                    {
                        content: "",
                        fileName: "New Note.txt",
                        isSno: false,
                        originalContent: "",
                        originalFileName: "New Note.txt",
                    },
                ];
                let currentBufferIndex = 0;
                let originalFileHandle = null;

                function updateStats() {
                    const text = editor.value;
                    const words = text.match(/\b\w+\b/g) || [];
                    const lines = text.split(/\r*\n/);
                    const currentLine =
                        lines[
                            editor.value
                                .substr(0, editor.selectionStart)
                                .split(/\r*\n/).length - 1
                        ];
                    const charCount = text.length;

                    statsWords.textContent = `= ${words.length}`;
                    statsChar.textContent = `→ ${charCount}`;
                    statsLine.textContent = `↓ ${
                        editor.value
                            .substr(0, editor.selectionStart)
                            .split(/\r*\n/).length
                    }`;
                }

                function updateFileNameDisplay() {
                    if (
                        buffers[currentBufferIndex] &&
                        buffers[currentBufferIndex].fileName
                    ) {
                        statsFileName.textContent =
                            buffers[currentBufferIndex].fileName;
                    } else {
                        statsFileName.textContent = "";
                    }
                }

                function saveState() {
                    localStorage.setItem(
                        "edit_app_buffers",
                        JSON.stringify(buffers),
                    );
                    localStorage.setItem(
                        "edit_app_current_buffer_index",
                        currentBufferIndex,
                    );
                }

                function loadState() {
                    const savedBuffers =
                        localStorage.getItem("edit_app_buffers");
                    const savedIndex = localStorage.getItem(
                        "edit_app_current_buffer_index",
                    );

                    if (savedBuffers && savedIndex) {
                        buffers = JSON.parse(savedBuffers);
                        currentBufferIndex = parseInt(savedIndex, 10);
                        if (buffers[currentBufferIndex]) {
                            editor.value = buffers[currentBufferIndex].content;
                            originalFileHandle =
                                buffers[currentBufferIndex].originalFileHandle;
                        }
                    } else {
                        buffers = [
                            {
                                content: "",
                                fileName: "New Note.txt",
                                isSno: false,
                                originalContent: "",
                            },
                        ];
                        currentBufferIndex = 0;
                    }
                    updateFileNameDisplay();
                    updateStats();
                }

                function saveCurrentBufferState() {
                    buffers[currentBufferIndex].content = editor.value;
                    buffers[currentBufferIndex].isDirty =
                        buffers[currentBufferIndex].content !==
                        buffers[currentBufferIndex].originalContent;
                    saveState();
                }

                function saveCurrentFileAs() {
                    const currentBuffer = buffers[currentBufferIndex];
                    if (!currentBuffer) return;

                    const blob = new Blob([currentBuffer.content], {
                        type: "text/plain;charset=utf-8",
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = currentBuffer.fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }

                async function saveFileToFileSystem() {
                    try {
                        const currentBuffer = buffers[currentBufferIndex];
                        if (!currentBuffer) return;

                        if (currentBuffer.originalFileHandle) {
                            const writable =
                                await currentBuffer.originalFileHandle.createWritable();
                            await writable.write(currentBuffer.content);
                            await writable.close();
                            currentBuffer.isDirty = false;
                        } else {
                            const handle = await showSaveFilePicker({
                                suggestedName: currentBuffer.fileName,
                                types: [
                                    {
                                        description: "Text Files",
                                        accept: {
                                            "text/plain": [
                                                ".txt",
                                                ".md",
                                                ".csv",
                                            ],
                                        },
                                    },
                                ],
                            });
                            const writable = await handle.createWritable();
                            await writable.write(currentBuffer.content);
                            await writable.close();
                            currentBuffer.originalFileHandle = handle;
                            currentBuffer.isDirty = false;
                        }
                    } catch (err) {
                        console.error("Save file error:", err);
                        if (err.name === "AbortError") {
                            // User cancelled the save operation
                            return;
                        }
                        alert(
                            "Could not save file. Please try 'Save As' instead.",
                        );
                    }
                }

                function loadFileFromSystem() {
                    const input = document.createElement("input");
                    input.type = "file";
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (!file) return;

                        const reader = new FileReader();
                        reader.onload = (re) => {
                            createNewBuffer(re.target.result, file.name);
                        };
                        reader.readAsText(file);
                    };
                    input.click();
                }

                function createNewBuffer(
                    content = "",
                    fileName = "New Note.txt",
                    originalFileHandle = null,
                    options = {},
                ) {
                    saveCurrentBufferState();
                    const newBuffer = {
                        content: content,
                        fileName: fileName,
                        originalContent: content,
                        originalFileHandle: originalFileHandle,
                        isSno: options.isSno || false,
                    };
                    buffers.push(newBuffer);
                    currentBufferIndex = buffers.length - 1;
                    editor.value = newBuffer.content;
                    updateFileNameDisplay();
                    updateStats();
                    saveState();
                }

                function switchBuffer(direction) {
                    saveCurrentBufferState();
                    currentBufferIndex += direction;
                    if (currentBufferIndex < 0) {
                        currentBufferIndex = buffers.length - 1;
                    } else if (currentBufferIndex >= buffers.length) {
                        currentBufferIndex = 0;
                    }
                    editor.value = buffers[currentBufferIndex].content;
                    updateFileNameDisplay();
                    updateStats();
                }

                function closeCurrentBuffer() {
                    if (buffers.length > 1) {
                        buffers.splice(currentBufferIndex, 1);
                        if (currentBufferIndex >= buffers.length) {
                            currentBufferIndex = buffers.length - 1;
                        }
                        editor.value = buffers[currentBufferIndex].content;
                        updateFileNameDisplay();
                        updateStats();
                    } else {
                        // Last buffer, clear content instead of closing
                        editor.value = "";
                        buffers[0].content = "";
                        buffers[0].isDirty = false;
                        buffers[0].originalContent = "";
                        buffers[0].isSno = false;
                        updateFileNameDisplay();
                        updateStats();
                    }
                    saveState();
                }

                function openContextMenu(x, y) {
                    contextMenu.style.left = `${x}px`;
                    contextMenu.style.top = `${y}px`;
                    contextMenu.style.display = "block";
                }

                function hideContextMenu() {
                    contextMenu.style.display = "none";
                }

                function toggleView(view) {
                    const currentView = editor.dataset.view;
                    if (currentView === view) {
                        showEditorView();
                    } else {
                        showView(view);
                    }
                }

                function showView(view) {
                    if (view === "md") {
                        showMarkdownPreview();
                    } else if (view === "csv") {
                        showCsvGrid();
                    }
                }

                function showEditorView() {
                    markdownPreview.classList.add("hidden");
                    csvGrid.classList.add("hidden");
                    editContainer.classList.remove("hidden");
                    editor.dataset.view = "editor";
                    mdViewBtn.classList.remove("active");
                    csvViewBtn.classList.remove("active");
                    mdMenuItems.forEach((item) => item.classList.add("hidden"));
                }

                // --- Markdown preview functions ---
                let markdownConverter = null;
                function showMarkdownPreview() {
                    if (!markdownConverter) {
                        markdownConverter = new showdown.Converter({
                            tables: true,
                            tasklists: true,
                            ghCodeBlocks: true,
                        });
                    }
                    const text = editor.value;
                    const html = markdownConverter.makeHtml(text);
                    markdownPreview.innerHTML = html;
                    markdownPreview.classList.remove("hidden");
                    editContainer.classList.add("hidden");
                    csvGrid.classList.add("hidden");
                    editor.dataset.view = "md";
                    mdViewBtn.classList.add("active");
                    csvViewBtn.classList.remove("active");
                    mdMenuItems.forEach((item) =>
                        item.classList.remove("hidden"),
                    );
                    renderCheckboxes();
                    renderTableOfContents();
                }

                function renderCheckboxes() {
                    markdownPreview
                        .querySelectorAll('input[type="checkbox"]')
                        .forEach((checkbox) => {
                            checkbox.disabled = false;
                            checkbox.addEventListener("change", (event) => {
                                const checked = event.target.checked;
                                const listItem = event.target.closest("li");
                                if (listItem) {
                                    const lines = editor.value.split("\n");
                                    const startLine = getLineNumber(listItem);
                                    if (
                                        startLine >= 0 &&
                                        startLine < lines.length
                                    ) {
                                        let line = lines[startLine];
                                        const checkboxText = checked
                                            ? "- [x]"
                                            : "- [ ]";
                                        lines[startLine] = line.replace(
                                            /- \[[ x]\]/,
                                            checkboxText,
                                        );
                                        editor.value = lines.join("\n");
                                        saveCurrentBufferState();
                                        showMarkdownPreview();
                                    }
                                }
                            });
                        });
                }

                function getLineNumber(element) {
                    let line = 0;
                    let node = element;
                    while (node.previousElementSibling) {
                        node = node.previousElementSibling;
                        if (node.tagName === "LI") {
                            line++;
                        }
                    }
                    const parent = element.parentNode;
                    const markdownText = editor.value;
                    const markdownLines = markdownText.split("\n");
                    let foundList = false;
                    for (let i = 0; i < markdownLines.length; i++) {
                        if (
                            markdownLines[i].startsWith("-") ||
                            markdownLines[i].startsWith("*") ||
                            markdownLines[i].match(/^\d+\./)
                        ) {
                            foundList = true;
                            if (line === 0) {
                                return i;
                            }
                            line--;
                        } else if (foundList) {
                            // End of list
                            break;
                        }
                    }
                    return -1;
                }

                function renderTableOfContents() {
                    const tocElement = markdownPreview.querySelector(".toc");
                    if (tocElement) {
                        tocElement.innerHTML =
                            "<h3>Table of Contents</h3><ul></ul>";
                        const tocList = tocElement.querySelector("ul");
                        let headings =
                            markdownPreview.querySelectorAll("h1, h2, h3, h4");
                        let headingIndex = 0;
                        headings.forEach((heading) => {
                            const headingId = `heading-${headingIndex++}`;
                            heading.id = headingId;
                            const li = document.createElement("li");
                            const a = document.createElement("a");
                            a.href = `#${headingId}`;
                            a.textContent = heading.textContent;
                            a.style.marginLeft = `${(heading.tagName[1] - 1) * 15}px`;
                            li.appendChild(a);
                            tocList.appendChild(li);
                        });
                    }
                }

                function saveAsHtml() {
                    const text = editor.value;
                    const html = markdownConverter.makeHtml(text);
                    const fullHtml = `<!DOCTYPE html><html><head><title>${
                        buffers[currentBufferIndex].fileName
                    }</title><style>${
                        document.querySelector("style[media='print']")
                            .textContent
                    }</style><style>${
                        document.querySelector("style:not([media])").textContent
                    }</style></head><body><div id="markdown-preview">${html}</div></body></html>`;
                    const blob = new Blob([fullHtml], {
                        type: "text/html;charset=utf-8",
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download =
                        buffers[currentBufferIndex].fileName.replace(
                            /\.[^/.]+$/,
                            "",
                        ) + ".html";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }

                function saveAsPdf() {
                    showMarkdownPreview();
                    window.print();
                    showEditorView();
                }

                // --- CSV Grid Functions ---
                function showCsvGrid() {
                    const text = editor.value;
                    const lines = text
                        .split("\n")
                        .map((line) => line.split(","));
                    const tableHtml = `
                    <div id="csv-grid-table-container">
                        <table>
                            <thead>
                                <tr id="csv-header-row">
                                    <th></th>
                                    ${lines[0].map((header, i) => `<th><span class="csv-header-sortable" data-col="${i}">${header}</span><button class="csv-action-btn delete-col-btn" data-col="${i}">✕</button></th>`).join("")}
                                    <th><button class="csv-action-btn add-col-btn">╋</button></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lines
                                    .slice(1)
                                    .map(
                                        (row, rowIndex) => `
                                    <tr data-row="${rowIndex}">
                                        <td><button class="csv-action-btn delete-row-btn" data-row="${rowIndex}">✕</button></td>
                                        ${row.map((cell, colIndex) => `<td contenteditable="true" data-row="${rowIndex}" data-col="${colIndex}">${cell}</td>`).join("")}
                                    </tr>
                                `,
                                    )
                                    .join("")}
                            </tbody>
                        </table>
                    </div>
                    <div id="csv-controls">
                        <button class="btn add-row-btn">Add Row</button>
                    </div>
                    `;
                    csvGrid.innerHTML = tableHtml;
                    csvGrid.classList.remove("hidden");
                    editContainer.classList.add("hidden");
                    markdownPreview.classList.add("hidden");
                    editor.dataset.view = "csv";
                    mdViewBtn.classList.remove("active");
                    csvViewBtn.classList.add("active");
                    mdMenuItems.forEach((item) => item.classList.add("hidden"));
                    setupCsvEvents();
                }

                function updateTextFromCsv() {
                    const table = csvGrid.querySelector("table");
                    if (!table) return;

                    let newText = "";
                    const headers = Array.from(
                        table.querySelectorAll("th span"),
                    ).map((th) => th.textContent.trim());
                    newText += headers.join(",") + "\n";

                    const rows = table.querySelectorAll("tbody tr");
                    rows.forEach((row) => {
                        const cells = Array.from(row.querySelectorAll("td"));
                        const rowData = cells.map((cell) =>
                            cell.textContent.trim(),
                        );
                        newText += rowData.join(",") + "\n";
                    });

                    editor.value = newText.trim();
                    saveCurrentBufferState();
                }

                function setupCsvEvents() {
                    csvGrid.addEventListener("input", (e) => {
                        if (
                            e.target.tagName === "TD" ||
                            e.target.tagName === "SPAN"
                        ) {
                            updateTextFromCsv();
                        }
                    });

                    csvGrid.addEventListener("click", (e) => {
                        if (e.target.classList.contains("add-row-btn")) {
                            const tbody = csvGrid.querySelector("tbody");
                            const newRow = document.createElement("tr");
                            const cols = tbody.querySelector("tr")
                                ? tbody.querySelector("tr").children.length - 1
                                : 1;
                            newRow.innerHTML = `<td><button class="csv-action-btn delete-row-btn">✕</button></td>${Array.from(
                                { length: cols },
                            )
                                .map(
                                    (_, i) =>
                                        `<td contenteditable="true"></td>`,
                                )
                                .join("")}`;
                            tbody.appendChild(newRow);
                            updateTextFromCsv();
                        } else if (
                            e.target.classList.contains("delete-row-btn")
                        ) {
                            const row = e.target.closest("tr");
                            row.remove();
                            updateTextFromCsv();
                        } else if (e.target.classList.contains("add-col-btn")) {
                            const headerRow =
                                csvGrid.querySelector("#csv-header-row");
                            const lastHeaderCell = headerRow.lastElementChild;
                            const newHeader = document.createElement("th");
                            newHeader.innerHTML = `<span contenteditable="true">New Col</span><button class="csv-action-btn delete-col-btn">✕</button>`;
                            headerRow.insertBefore(newHeader, lastHeaderCell);

                            const rows = csvGrid.querySelectorAll("tbody tr");
                            rows.forEach((row) => {
                                const newCell = document.createElement("td");
                                newCell.contentEditable = true;
                                row.appendChild(newCell);
                            });
                            updateTextFromCsv();
                        } else if (
                            e.target.classList.contains("delete-col-btn")
                        ) {
                            const colIndex =
                                Array.from(
                                    e.target.parentNode.parentNode.children,
                                ).indexOf(e.target.parentNode) - 1;
                            const headerCells = csvGrid.querySelectorAll("th");
                            if (headerCells[colIndex + 1]) {
                                headerCells[colIndex + 1].remove();
                            }
                            const rows = csvGrid.querySelectorAll("tbody tr");
                            rows.forEach((row) => {
                                if (row.children[colIndex + 1]) {
                                    row.children[colIndex + 1].remove();
                                }
                            });
                            updateTextFromCsv();
                        }
                    });
                }

                // --- Find bar functions ---
                let findIndex = -1;
                let findMatches = [];
                let findText = "";

                function showFindBar() {
                    findBar.style.display = "flex";
                    findInput.focus();
                }

                function hideFindBar() {
                    findBar.style.display = "none";
                    findInput.value = "";
                    editor.setSelectionRange(0, 0);
                    findIndex = -1;
                    findMatches = [];
                    findText = "";
                }

                function findNextMatch(direction) {
                    const text = editor.value;
                    const query = findInput.value;
                    if (query === "") return;

                    if (query !== findText) {
                        findText = query;
                        findMatches = [];
                        let lastIndex = text.indexOf(query, 0);
                        while (lastIndex !== -1) {
                            findMatches.push(lastIndex);
                            lastIndex = text.indexOf(query, lastIndex + 1);
                        }
                        findIndex = -1;
                    }

                    if (findMatches.length === 0) return;

                    findIndex += direction;
                    if (findIndex < 0) {
                        findIndex = findMatches.length - 1;
                    } else if (findIndex >= findMatches.length) {
                        findIndex = 0;
                    }

                    const matchStart = findMatches[findIndex];
                    const matchEnd = matchStart + query.length;
                    editor.focus();
                    editor.setSelectionRange(matchStart, matchEnd);
                }

                // --- Text Expander functions ---
                let textExpansions = {};
                const TEXT_EXPANSION_STORAGE_KEY = "edit_app_text_expansions";

                function loadTextExpansions() {
                    try {
                        const stored = localStorage.getItem(
                            TEXT_EXPANSION_STORAGE_KEY,
                        );
                        if (stored) {
                            textExpansions = JSON.parse(stored);
                        }
                    } catch (e) {
                        console.error("Error loading text expansions:", e);
                    }
                }

                function saveTextExpansions() {
                    try {
                        localStorage.setItem(
                            TEXT_EXPANSION_STORAGE_KEY,
                            JSON.stringify(textExpansions),
                        );
                    } catch (e) {
                        console.error("Error saving text expansions:", e);
                    }
                }

                function applyTextExpansion(trigger, text) {
                    if (textExpansions[trigger]) {
                        const expansion = textExpansions[trigger];
                        const start =
                            editor.selectionStart - trigger.length - 1;
                        const end = editor.selectionEnd;
                        const newValue =
                            editor.value.substring(0, start) +
                            expansion +
                            editor.value.substring(end);
                        editor.value = newValue;
                        const newCursorPos = start + expansion.length;
                        editor.setSelectionRange(newCursorPos, newCursorPos);
                        updateStats();
                        return true;
                    }
                    return false;
                }

                function getFormattedDate(format) {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = now.getMonth() + 1;
                    const day = now.getDate();
                    const shortYear = year.toString().slice(-2);
                    const monthName = now.toLocaleString("default", {
                        month: "long",
                    });
                    const shortMonthName = now.toLocaleString("default", {
                        month: "short",
                    });

                    return format
                        .replace(/YYYY/g, year)
                        .replace(/YY/g, shortYear)
                        .replace(/MMM/g, shortMonthName)
                        .replace(/MM/g, String(month).padStart(2, "0"))
                        .replace(/DD/g, String(day).padStart(2, "0"));
                }

                // --- Event Listeners and Handlers ---
                editor.addEventListener("input", (e) => {
                    const cursorPosition = editor.selectionStart;
                    const textBeforeCursor = editor.value.substring(
                        0,
                        cursorPosition,
                    );

                    // Check for text expansions
                    const lastSpace = textBeforeCursor.lastIndexOf(" ");
                    const lastEnter = textBeforeCursor.lastIndexOf("\n");
                    const startOfWord = Math.max(lastSpace, lastEnter) + 1;
                    const lastWord = textBeforeCursor
                        .substring(startOfWord)
                        .trim();

                    if (lastWord.startsWith(".") && lastWord.length > 1) {
                        if (e.inputType === "insertText" && e.data === " ") {
                            // Trim the space added by the expansion
                            editor.value =
                                editor.value.substring(0, cursorPosition - 1) +
                                editor.value.substring(cursorPosition);
                            editor.setSelectionRange(
                                cursorPosition - 1,
                                cursorPosition - 1,
                            );

                            if (
                                applyTextExpansion(
                                    lastWord.trim(),
                                    textBeforeCursor,
                                )
                            ) {
                                return;
                            }
                        } else if (e.inputType === "insertLineBreak") {
                            editor.value =
                                editor.value.substring(0, cursorPosition - 1) +
                                editor.value.substring(cursorPosition);
                            editor.setSelectionRange(
                                cursorPosition - 1,
                                cursorPosition - 1,
                            );

                            if (
                                applyTextExpansion(
                                    lastWord.trim(),
                                    textBeforeCursor,
                                )
                            ) {
                                return;
                            }
                        }
                    }

                    // Auto-indent for lists
                    if (e.inputType === "insertLineBreak") {
                        const lines = editor.value
                            .substring(0, editor.selectionStart)
                            .split("\n");
                        const currentLine = lines[lines.length - 2];
                        const match = currentLine.match(/^\s*([-*]|\d+\.)\s/);

                        if (match) {
                            const prefix = match[0];
                            const isNumberedList = prefix.match(/^\s*\d+\.\s/);
                            let newPrefix = prefix.replace(/\s+$/, "");

                            if (isNumberedList) {
                                const number = parseInt(
                                    newPrefix.match(/\d+/)[0],
                                    10,
                                );
                                newPrefix = newPrefix.replace(
                                    /\d+/,
                                    number + 1,
                                );
                            }

                            if (currentLine.trim() === prefix.trim()) {
                                // Double enter, exit list
                                editor.value =
                                    editor.value.substring(
                                        0,
                                        cursorPosition - prefix.length - 1,
                                    ) + editor.value.substring(cursorPosition);
                                editor.setSelectionRange(
                                    cursorPosition - prefix.length - 1,
                                    cursorPosition - prefix.length - 1,
                                );
                            } else {
                                editor.value =
                                    editor.value.substring(
                                        0,
                                        editor.selectionStart,
                                    ) +
                                    " ".repeat(prefix.length) +
                                    editor.value.substring(
                                        editor.selectionStart,
                                    );
                                editor.setSelectionRange(
                                    cursorPosition + prefix.length,
                                    cursorPosition + prefix.length,
                                );
                            }
                        }
                    }

                    updateStats();
                });

                // --- Line indicator update ---
                editor.addEventListener("scroll", () => {
                    const scrollRatio =
                        editor.scrollTop /
                        (editor.scrollHeight - editor.clientHeight);
                    const totalHeight =
                        editor.clientHeight - lineIndicator.clientHeight;
                    lineIndicator.style.top = `${2 + scrollRatio * totalHeight}px`;
                });

                editor.addEventListener("click", () => {
                    hideContextMenu();
                    updateStats();
                });
                editor.addEventListener("contextmenu", (e) => {
                    e.preventDefault();
                    openContextMenu(e.clientX, e.clientY);
                });

                menuTrigger.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const rect = menuTrigger.getBoundingClientRect();
                    openContextMenu(rect.left, rect.bottom + 8);
                });

                // Hide menu when clicking outside
                document.addEventListener("click", (e) => {
                    if (
                        !contextMenu.contains(e.target) &&
                        !menuTrigger.contains(e.target)
                    ) {
                        hideContextMenu();
                    }
                });

                // --- Keyboard Shortcuts ---
                document.addEventListener("keydown", (e) => {
                    if (e.key === "Escape") {
                        if (findBar.style.display !== "none") {
                            hideFindBar();
                            e.preventDefault();
                        } else if (!snoContainer.classList.contains("hidden")) {
                            sno_toggleLockScreen();
                            e.preventDefault();
                        }
                    }
                    if (e.ctrlKey && e.key === "n") {
                        createNewBuffer();
                        e.preventDefault();
                    }
                    if (e.ctrlKey && e.key === "o") {
                        loadFileFromSystem();
                        e.preventDefault();
                    }
                    if (e.ctrlKey && e.key === "s") {
                        saveFileToFileSystem();
                        e.preventDefault();
                    }
                    if (e.ctrlKey && e.key === "w") {
                        closeCurrentBuffer();
                        e.preventDefault();
                    }
                    if (e.ctrlKey && e.key === "ArrowRight") {
                        switchBuffer(1);
                        e.preventDefault();
                    }
                    if (e.ctrlKey && e.key === "ArrowLeft") {
                        switchBuffer(-1);
                        e.preventDefault();
                    }
                    if (e.ctrlKey && e.key === "f") {
                        showFindBar();
                        e.preventDefault();
                    }
                    if (e.ctrlKey && e.key === "=") {
                        sno_toggleLockScreen();
                        e.preventDefault();
                    }

                    if (e.key === "Enter" && findInput.value !== "") {
                        findNextMatch(e.shiftKey ? -1 : 1);
                        e.preventDefault();
                    }
                });

                // --- Find bar events ---
                findInput.addEventListener("input", () => {
                    findIndex = -1; // Reset search on input change
                    findNextMatch(1);
                });
                findPrev.addEventListener("click", () => findNextMatch(-1));
                findNext.addEventListener("click", () => findNextMatch(1));
                findClose.addEventListener("click", hideFindBar);

                // --- Menu item events ---
                document
                    .getElementById("menu-new")
                    .addEventListener("click", () => createNewBuffer());
                document
                    .getElementById("menu-open")
                    .addEventListener("click", loadFileFromSystem);
                document
                    .getElementById("menu-save")
                    .addEventListener("click", saveFileToFileSystem);
                document
                    .getElementById("menu-save-as")
                    .addEventListener("click", saveCurrentFileAs);
                document
                    .getElementById("menu-close-file")
                    .addEventListener("click", closeCurrentBuffer);
                document
                    .getElementById("menu-next-file")
                    .addEventListener("click", () => switchBuffer(1));
                document
                    .getElementById("menu-prev-file")
                    .addEventListener("click", () => switchBuffer(-1));
                document
                    .getElementById("menu-find")
                    .addEventListener("click", showFindBar);
                document
                    .getElementById("menu-sno")
                    .addEventListener("click", sno_toggleLockScreen);
                mdViewBtn.addEventListener("click", () => toggleView("md"));
                csvViewBtn.addEventListener("click", () => toggleView("csv"));
                saveHtmlBtn.addEventListener("click", saveAsHtml);
                savePdfBtn.addEventListener("click", saveAsPdf);

                // --- Help modal events ---
                const helpLink = document.getElementById("menu-help");
                const closeHelpBtn =
                    document.getElementById("close-help-modal");
                helpLink.addEventListener("click", () => {
                    helpModal.classList.add("active");
                });
                closeHelpBtn.addEventListener("click", () => {
                    helpModal.classList.remove("active");
                });
                window.addEventListener("click", (event) => {
                    if (event.target == helpModal) {
                        helpModal.classList.remove("active");
                    }
                });

                // --- PWA install button ---
                let deferredPrompt;
                const pwaInstallLink =
                    document.getElementById("pwa-install-link");

                window.addEventListener("beforeinstallprompt", (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    pwaInstallLink.style.display = "block";
                    pwaInstallLink.addEventListener("click", () => {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === "accepted") {
                                console.log("User accepted the install prompt");
                            } else {
                                console.log(
                                    "User dismissed the install prompt",
                                );
                            }
                            deferredPrompt = null;
                        });
                    });
                });

                // --- Text Expander Modal ---
                const textExpanderLink =
                    document.getElementById("menu-text-expander");
                const textExpanderModal = document.getElementById(
                    "text-expander-modal",
                );
                const closeExpanderBtn = document.getElementById(
                    "close-expander-modal",
                );
                const addExpansionBtn =
                    document.getElementById("add-expansion-btn");
                const expansionsList =
                    document.getElementById("expansions-list");
                const expansionShortcutInput = document.getElementById(
                    "expansion-shortcut-input",
                );
                const expansionValueInput = document.getElementById(
                    "expansion-value-input",
                );
                const dateFormatInput =
                    document.getElementById("date-format-input");
                const saveDateFormatBtn = document.getElementById(
                    "save-date-format-btn",
                );
                const importExpansionsBtn = document.getElementById(
                    "import-expansions-btn",
                );
                const exportExpansionsBtn = document.getElementById(
                    "export-expansions-btn",
                );
                const importExpansionsInput = document.getElementById(
                    "import-expansions-input",
                );

                function renderExpansions() {
                    expansionsList.innerHTML = "";
                    for (const shortcut in textExpansions) {
                        const value = textExpansions[shortcut];
                        if (shortcut === ".d") {
                            dateFormatInput.value = value;
                            continue;
                        }
                        const item = document.createElement("div");
                        item.className = "expansion-item";
                        item.innerHTML = `
                            <span class="expansion-item-shortcut">${shortcut}</span>
                            <span class="expansion-item-value">${value}</span>
                            <div class="expansion-item-actions">
                                <button class="btn btn-small btn-secondary edit-btn">Edit</button>
                                <button class="btn btn-small btn-danger delete-btn">Delete</button>
                            </div>
                        `;
                        item.querySelector(".edit-btn").addEventListener(
                            "click",
                            () => {
                                expansionShortcutInput.value = shortcut;
                                expansionValueInput.value = value;
                            },
                        );
                        item.querySelector(".delete-btn").addEventListener(
                            "click",
                            () => {
                                delete textExpansions[shortcut];
                                saveTextExpansions();
                                renderExpansions();
                            },
                        );
                        expansionsList.appendChild(item);
                    }
                }

                textExpanderLink.addEventListener("click", () => {
                    renderExpansions();
                    textExpanderModal.classList.add("active");
                });
                closeExpanderBtn.addEventListener("click", () => {
                    textExpanderModal.classList.remove("active");
                });
                window.addEventListener("click", (event) => {
                    if (event.target == textExpanderModal) {
                        textExpanderModal.classList.remove("active");
                    }
                });

                addExpansionBtn.addEventListener("click", () => {
                    const shortcut = expansionShortcutInput.value.trim();
                    const value = expansionValueInput.value.trim();
                    if (
                        shortcut.length > 1 &&
                        shortcut.startsWith(".") &&
                        value
                    ) {
                        textExpansions[shortcut] = value;
                        saveTextExpansions();
                        renderExpansions();
                        expansionShortcutInput.value = "";
                        expansionValueInput.value = "";
                    } else {
                        alert(
                            "Shortcut must start with '.' and be at least 2 characters.",
                        );
                    }
                });

                saveDateFormatBtn.addEventListener("click", () => {
                    const format = dateFormatInput.value.trim();
                    textExpansions[".d"] = format;
                    saveTextExpansions();
                    renderExpansions();
                });

                importExpansionsBtn.addEventListener("click", () => {
                    importExpansionsInput.click();
                });

                importExpansionsInput.addEventListener("change", (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (re) => {
                        const importedText = re.target.result;
                        try {
                            const importedExpansions = JSON.parse(importedText);
                            if (
                                typeof importedExpansions === "object" &&
                                importedExpansions !== null
                            ) {
                                textExpansions = {
                                    ...textExpansions,
                                    ...importedExpansions,
                                };
                                saveTextExpansions();
                                renderExpansions();
                                alert("Shortcuts imported successfully!");
                            } else {
                                throw new Error("Invalid format");
                            }
                        } catch (e) {
                            alert(
                                "Failed to import shortcuts. Invalid file format.",
                            );
                        }
                    };
                    reader.readAsText(file);
                });

                exportExpansionsBtn.addEventListener("click", () => {
                    const expansionsJson = JSON.stringify(
                        textExpansions,
                        null,
                        2,
                    );
                    const blob = new Blob([expansionsJson], {
                        type: "application/json",
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "text-expansions.json";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });

                // --- INITIALIZATION ---
                loadState();
                loadTextExpansions();
                sno_checkForExistingVaults();
            });

            // --- SERVICE WORKER REGISTRATION ---
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () => {
                    navigator.serviceWorker
                        .register("/sw.js")
                        .then((reg) =>
                            console.log(
                                "SW registration successful:",
                                reg.scope,
                            ),
                        )
                        .catch((err) =>
                            console.log("SW registration failed:", err),
                        );
                });
            }
        </script>
    </body>
</html>
