<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>editr</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            :root {
                --bg-color: #121416;
                --text-color: #d4d4d4;
                --dim-color: #888888;
                --highlight-bg: #2a3f4d;
                --highlight-text: #61afef;
                --border-color: #3a3f4d;
                --menu-bg: #1e1e1e;
                --menu-active: #2a539a;
                --statusbar-bg: #2a2e36;
                --popup-bg: #1e2227;
                --button-bg: #355880;
                --button-hover: #4e78ab;
                --success-color: #28a745;
                --warning-color: #ffc107;
            }

            body {
                font-family:
                    "SF Mono", "Monaco", "Inconsolata", "Roboto Mono",
                    "Source Code Pro", "Menlo", "Consolas", "DejaVu Sans Mono",
                    "Liberation Mono", "Courier New", monospace;
                background: var(--bg-color);
                margin: 0;
                padding: 0;
                color: var(--text-color);
                font-size: 16px;
                height: 100vh;
                overflow: hidden;
            }

            .tui-container {
                display: flex;
                flex-direction: column;
                height: 100vh;
                box-sizing: border-box;
            }

            /* Menu bar */
            .menubar {
                background: var(--menu-bg);
                color: var(--text-color);
                border-bottom: 1px solid var(--border-color);
                display: flex;
                padding: 0;
                user-select: none;
            }

            .menubar .title {
                background: var(--button-bg);
                padding: 0.3em 1em;
                font-weight: bold;
            }

            .menubar .menu-items {
                display: flex;
            }

            .menubar .menu-item {
                padding: 0.3em 1em;
                cursor: pointer;
                border-right: 1px solid var(--border-color);
            }

            .menubar .menu-item:hover {
                background: var(--menu-active);
            }

            .menubar .menu-item .shortcut {
                color: var(--dim-color);
                margin-left: 0.5em;
            }

            /* Status bars */
            .statusbar {
                background: var(--statusbar-bg);
                color: var(--text-color);
                display: flex;
                padding: 0.3em 0;
                border-top: 1px solid var(--border-color);
                border-bottom: 1px solid var(--border-color);
                font-size: 0.9em;
            }

            .statusbar span {
                padding: 0 1em;
                border-right: 1px solid var(--border-color);
            }

            .statusbar span:last-child {
                border-right: none;
            }

            .command-bar {
                background: var(--statusbar-bg);
                color: var(--text-color);
                padding: 0.3em 1em;
                display: flex;
                justify-content: space-between;
                border-top: 1px solid var(--border-color);
            }

            .command-bar .commands {
                display: flex;
                gap: 1em;
            }

            .command-bar .command {
                color: var(--highlight-text);
            }

            .command-bar .key {
                color: var(--text-color);
                background: var(--button-bg);
                padding: 0 0.3em;
                border-radius: 3px;
                margin-right: 0.2em;
            }

            /* Editor area */
            .editor-wrapper {
                flex: 1;
                position: relative;
                overflow: hidden;
                border: 1px solid var(--border-color);
                background: var(--bg-color);
                display: flex;
                flex-direction: column;
            }

            .line-numbers {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 3em;
                background: var(--menu-bg);
                color: var(--dim-color);
                border-right: 1px solid var(--border-color);
                overflow: hidden;
                padding: 0.5em 0.5em 0.5em 0;
                text-align: right;
                user-select: none;
            }

            #textbox {
                flex: 1;
                width: 100%;
                height: 100%;
                resize: none;
                border: none;
                background: var(--bg-color);
                color: var(--text-color);
                padding: 0.5em 0.5em 0.5em 3.5em;
                font-family:
                    "SF Mono", "Monaco", "Inconsolata", "Roboto Mono",
                    "Source Code Pro", "Menlo", "Consolas", "DejaVu Sans Mono",
                    "Liberation Mono", "Courier New", monospace;
                font-size: 1em;
                line-height: 1.4;
                box-sizing: border-box;
                outline: none;
                white-space: pre;
                overflow: auto;
            }

            #textbox:focus {
                caret-color: var(--highlight-text);
            }

            #filename {
                background: var(--menu-bg);
                color: var(--text-color);
                border: 1px solid var(--border-color);
                padding: 0.2em 0.5em;
                font-family: inherit;
                font-size: 0.9em;
            }

            /* File status indicator */
            .file-status {
                background: var(--success-color);
                color: white;
                padding: 0 0.5em;
                border-radius: 3px;
                font-size: 0.8em;
            }

            .file-status.unsaved {
                background: var(--warning-color);
                color: #000;
            }

            /* Popup Overlay */
            #popup-overlay {
                display: none;
                position: fixed;
                z-index: 100;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.6);
                justify-content: center;
                align-items: center;
            }

            .popup {
                display: none;
                background: var(--popup-bg);
                color: var(--text-color);
                padding: 1em;
                border: 2px solid var(--border-color);
                min-width: 300px;
                max-width: 90vw;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            }

            .popup h2 {
                margin-top: 0;
                padding-bottom: 0.5em;
                border-bottom: 1px solid var(--border-color);
            }

            .popup .close-btn {
                position: absolute;
                top: 0.5em;
                right: 0.8em;
                background: none;
                border: none;
                color: var(--text-color);
                cursor: pointer;
                font-size: 1.2em;
            }

            .popup label {
                display: block;
                margin: 0.5em 0 0.2em 0;
            }

            .popup input[type="text"] {
                width: 100%;
                padding: 0.4em;
                background: var(--bg-color);
                color: var(--text-color);
                border: 1px solid var(--border-color);
                border-radius: 0;
                font-family: inherit;
                font-size: 0.9em;
                margin-bottom: 1em;
            }

            .popup .popup-actions {
                display: flex;
                gap: 0.5em;
                justify-content: flex-end;
                margin-top: 1em;
            }

            .popup button {
                background: var(--button-bg);
                color: var(--text-color);
                border: none;
                padding: 0.4em 0.8em;
                cursor: pointer;
                font-family: inherit;
            }

            .popup button:hover {
                background: var(--button-hover);
            }

            /* Shortcuts info */
            #shortcuts-popup table {
                width: 100%;
                border-collapse: collapse;
                margin: 0.5em 0;
            }

            #shortcuts-popup table td,
            #shortcuts-popup table th {
                padding: 0.4em;
                text-align: left;
                border-bottom: 1px solid var(--border-color);
            }

            #shortcuts-popup .key {
                background: var(--button-bg);
                padding: 0.1em 0.3em;
                border-radius: 0;
                font-family: inherit;
            }

            /* Make the popup appear like a TUI dialog */
            .popup {
                position: relative;
            }

            .popup::before {
                content: "";
                position: absolute;
                top: -1px;
                left: -1px;
                right: -1px;
                height: 1.5em;
                background: var(--highlight-bg);
            }

            .popup h2 {
                position: relative;
                z-index: 1;
                margin-top: 0;
                padding-top: 0;
            }

            /* Responsive adjustments */
            @media (max-width: 768px) {
                .command-bar .command-text {
                    display: none;
                }

                .menubar {
                    flex-wrap: wrap;
                }

                .menubar .title {
                    width: 100%;
                    text-align: center;
                }

                .menubar .menu-items {
                    width: 100%;
                }

                .menubar .menu-item {
                    flex: 1;
                    text-align: center;
                    padding: 0.3em 0;
                }
            }

            @media (max-width: 480px) {
                .statusbar span {
                    padding: 0 0.5em;
                    font-size: 0.8em;
                }

                .menubar .menu-item .shortcut {
                    display: none;
                }
            }
        </style>
    </head>
    <body>
        <div class="tui-container">
            <!-- Menu Bar -->
            <div class="menubar">
                <div class="title">editr</div>
                <div class="menu-items">
                    <div class="menu-item" id="open-btn">
                        Open<span class="shortcut">^O</span>
                    </div>
                    <div class="menu-item" id="save-btn">
                        Save<span class="shortcut">^S</span>
                    </div>
                    <div class="menu-item" id="find-btn">
                        Find<span class="shortcut">^F</span>
                    </div>
                    <div class="menu-item" id="shortcuts-btn">
                        Help<span class="shortcut">F2</span>
                    </div>
                    <div class="menu-item" id="about-btn">
                        About<span class="shortcut">F1</span>
                    </div>
                </div>
            </div>

            <!-- Status Bar -->
            <div class="statusbar">
                <span id="filename-display">file.txt</span>
                <span>Line: <span id="line-pos">1</span></span>
                <span>Col: <span id="char-pos">1</span></span>
                <span>Words: <span id="word-count">0</span></span>
                <span id="file-status" class="file-status">New</span>
            </div>

            <!-- Editor Area -->
            <div class="editor-wrapper">
                <div class="line-numbers" id="line-numbers"></div>
                <textarea
                    id="textbox"
                    spellcheck="false"
                    placeholder="Type here..."
                ></textarea>
            </div>

            <!-- Command Bar -->
            <div class="command-bar">
                <div class="commands">
                    <div>
                        <span class="key">^Z</span>
                        <span class="command-text">Undo</span>
                    </div>
                    <div>
                        <span class="key">^Y</span>
                        <span class="command-text">Redo</span>
                    </div>
                    <div>
                        <span class="key">^S</span>
                        <span class="command-text">Save</span>
                    </div>
                </div>
                <input type="text" id="filename" placeholder="file.txt" />
            </div>
        </div>

        <!-- Popup Overlay and Popups -->
        <div id="popup-overlay">
            <div class="popup" id="about-popup">
                <button class="close-btn" title="Close">×</button>
                <h2>About</h2>
                <p>
                    editr is a terminal-style text editor built with HTML, CSS,
                    and JavaScript by Barney (www.barney.me).<br />
                    <b>Features:</b> Undo/Redo, Find & Replace, Keyboard
                    Shortcuts, Direct File System Access, and terminal-like
                    interface.
                </p>
                <p style="color: var(--dim-color)">Press ESC to close</p>
            </div>

            <div class="popup" id="find-popup">
                <button class="close-btn" title="Close">×</button>
                <h2>Find & Replace</h2>
                <label for="find-text">Find:</label>
                <input type="text" id="find-text" autocomplete="off" />
                <label for="replace-text">Replace:</label>
                <input type="text" id="replace-text" autocomplete="off" />
                <div class="popup-actions">
                    <button id="find-next-btn">Next (F3)</button>
                    <button id="replace-btn">Replace</button>
                    <button id="replace-all-btn">Replace All</button>
                </div>
                <div
                    id="find-count"
                    style="margin-top: 0.7em; color: var(--dim-color)"
                ></div>
            </div>

            <div class="popup" id="shortcuts-popup">
                <button class="close-btn" title="Close">×</button>
                <h2>Keyboard Shortcuts</h2>
                <table>
                    <tr>
                        <th>Action</th>
                        <th>Key</th>
                    </tr>
                    <tr>
                        <td>About</td>
                        <td><span class="key">F1</span></td>
                    </tr>
                    <tr>
                        <td>Help</td>
                        <td><span class="key">F2</span></td>
                    </tr>
                    <tr>
                        <td>Find</td>
                        <td><span class="key">Ctrl+F</span></td>
                    </tr>
                    <tr>
                        <td>Find Next</td>
                        <td><span class="key">F3</span></td>
                    </tr>
                    <tr>
                        <td>Save</td>
                        <td><span class="key">Ctrl+S</span></td>
                    </tr>
                    <tr>
                        <td>Open</td>
                        <td><span class="key">Ctrl+O</span></td>
                    </tr>
                    <tr>
                        <td>Undo</td>
                        <td><span class="key">Ctrl+Z</span></td>
                    </tr>
                    <tr>
                        <td>Redo</td>
                        <td><span class="key">Ctrl+Y</span></td>
                    </tr>
                    <tr>
                        <td>Close</td>
                        <td><span class="key">Esc</span></td>
                    </tr>
                </table>
            </div>

            <input
                type="file"
                id="file-input"
                accept=".txt,.md,.js,.html,.css,.json,.csv"
                style="display: none"
            />
        </div>

        <script>
            // ========== DOM CACHE ==========
            const $ = (id) => document.getElementById(id);
            const textbox = $("textbox");
            const filenameBox = $("filename");
            const filenameDisplay = $("filename-display");
            const linePos = $("line-pos");
            const charPos = $("char-pos");
            const wordCount = $("word-count");
            const lineNumbers = $("line-numbers");
            const fileStatus = $("file-status");
            const aboutBtn = $("about-btn");
            const findBtn = $("find-btn");
            const saveBtn = $("save-btn");
            const openBtn = $("open-btn");
            const shortcutsBtn = $("shortcuts-btn");
            const popupOverlay = $("popup-overlay");
            const aboutPopup = $("about-popup");
            const findPopup = $("find-popup");
            const shortcutsPopup = $("shortcuts-popup");
            const findText = $("find-text");
            const replaceText = $("replace-text");
            const findNextBtn = $("find-next-btn");
            const replaceBtn = $("replace-btn");
            const replaceAllBtn = $("replace-all-btn");
            const findCount = $("find-count");
            const fileInput = $("file-input");

            // ========== FILE SYSTEM ACCESS API ==========
            let currentFileHandle = null;
            let hasUnsavedChanges = false;
            let originalContent = "";

            // Check if File System Access API is supported
            const supportsFileSystemAccess = "showOpenFilePicker" in window;

            function updateFileStatus() {
                if (currentFileHandle) {
                    if (hasUnsavedChanges) {
                        fileStatus.textContent = "Modified";
                        fileStatus.className = "file-status unsaved";
                    } else {
                        fileStatus.textContent = "Saved";
                        fileStatus.className = "file-status";
                    }
                } else {
                    fileStatus.textContent = "New";
                    fileStatus.className = "file-status";
                }
            }

            function markAsModified() {
                if (textbox.value !== originalContent) {
                    hasUnsavedChanges = true;
                } else {
                    hasUnsavedChanges = false;
                }
                updateFileStatus();
            }

            // ========== UNDO/REDO HISTORY ==========
            const MAX_HISTORY = 100;
            let history = [""];
            let historyPtr = 0;
            let isUndoing = false;
            let isRedoing = false;

            function pushHistory(val) {
                if (isUndoing || isRedoing) return;
                // If not at end, truncate
                if (historyPtr < history.length - 1) {
                    history = history.slice(0, historyPtr + 1);
                }
                if (history[historyPtr] !== val) {
                    history.push(val);
                    if (history.length > MAX_HISTORY) history.shift();
                    else historyPtr++;
                }
            }

            function undo() {
                if (historyPtr > 0) {
                    isUndoing = true;
                    historyPtr--;
                    textbox.value = history[historyPtr];
                    updateStats();
                    updateLineNumbers();
                    markAsModified();
                    isUndoing = false;
                }
            }

            function redo() {
                if (historyPtr < history.length - 1) {
                    isRedoing = true;
                    historyPtr++;
                    textbox.value = history[historyPtr];
                    updateStats();
                    updateLineNumbers();
                    markAsModified();
                    isRedoing = false;
                }
            }

            // ========== AUTOSAVE ==========
            const tabId = (() => {
                if (!window.name)
                    window.name =
                        "tab-" +
                        Date.now() +
                        "-" +
                        Math.random().toString(36).slice(2, 8);
                return window.name;
            })();

            function autosave() {
                // Only use localStorage for new files or fallback
                if (!currentFileHandle) {
                    localStorage.setItem("editor_" + tabId, textbox.value);
                }
            }

            // ========== LINE NUMBERS ==========
            function updateLineNumbers() {
                const lines = textbox.value.split("\n");
                const count = lines.length;
                let html = "";

                for (let i = 1; i <= count; i++) {
                    html += `${i}<br>`;
                }

                lineNumbers.innerHTML = html;

                // Sync scrolling
                lineNumbers.scrollTop = textbox.scrollTop;
            }

            // ========== STATS ==========
            function updateStats() {
                const val = textbox.value;
                const cursorPosition = textbox.selectionStart;

                // Get text up to cursor
                const textUpToCursor = val.substring(0, cursorPosition);

                // Calculate line number (counting newlines + 1)
                const lines = textUpToCursor.split("\n");
                const currentLine = lines.length;

                // Calculate column/character position in current line
                const currentColumn = lines[lines.length - 1].length + 1;

                // Update display
                linePos.textContent = currentLine;
                charPos.textContent = currentColumn;

                // Count words - if text is empty, count is 0
                wordCount.textContent = val.trim()
                    ? val.trim().split(/\s+/).length
                    : 0;
            }

            // ========== POPUP MODALS ==========
            function showPopup(popup) {
                popupOverlay.style.display = "flex";
                popup.style.display = "block";
                setTimeout(
                    () => popup.querySelector("input,button,textarea")?.focus(),
                    100,
                );
            }

            function hidePopups() {
                popupOverlay.style.display = "none";
                aboutPopup.style.display = "none";
                findPopup.style.display = "none";
                shortcutsPopup.style.display = "none";
                findText.value = "";
                replaceText.value = "";
                findCount.textContent = "";
            }

            popupOverlay.addEventListener("click", (e) => {
                if (e.target === popupOverlay) hidePopups();
            });

            document
                .querySelectorAll(".popup .close-btn")
                .forEach((btn) => (btn.onclick = hidePopups));

            aboutBtn.onclick = () => showPopup(aboutPopup);
            findBtn.onclick = () => showPopup(findPopup);
            shortcutsBtn.onclick = () => showPopup(shortcutsPopup);

            // ========== FIND & REPLACE ==========
            let lastFindIndex = 0;
            function doFind(next = true) {
                const text = textbox.value;
                const query = findText.value;
                if (!query) return;
                const idx = next
                    ? text.indexOf(query, textbox.selectionEnd)
                    : text.lastIndexOf(
                          query,
                          textbox.selectionStart - query.length - 1,
                      );
                if (idx !== -1) {
                    textbox.focus();
                    textbox.setSelectionRange(idx, idx + query.length);
                    lastFindIndex = idx + query.length;
                    showFindCount();
                } else {
                    findCount.textContent = "Not found";
                }
            }

            function showFindCount() {
                const text = textbox.value;
                const query = findText.value;
                if (!query) {
                    findCount.textContent = "";
                    return;
                }
                const matches = (
                    text.match(new RegExp(escapeRegExp(query), "g")) || []
                ).length;
                findCount.textContent = matches
                    ? `${matches} match${matches > 1 ? "es" : ""}`
                    : "Not found";
            }

            function escapeRegExp(str) {
                return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
            }

            function doReplace() {
                const query = findText.value;
                const replacement = replaceText.value;
                if (!query) return;
                const { selectionStart, selectionEnd, value } = textbox;
                if (value.substring(selectionStart, selectionEnd) === query) {
                    textbox.setRangeText(
                        replacement,
                        selectionStart,
                        selectionEnd,
                        "end",
                    );
                    pushHistory(textbox.value);
                    updateStats();
                    updateLineNumbers();
                    markAsModified();
                    doFind();
                }
            }

            function doReplaceAll() {
                const query = findText.value;
                const replacement = replaceText.value;
                if (!query) return;
                textbox.value = textbox.value.split(query).join(replacement);
                pushHistory(textbox.value);
                updateStats();
                updateLineNumbers();
                markAsModified();
                showFindCount();
            }

            findText.oninput = showFindCount;
            findNextBtn.onclick = () => doFind(true);
            replaceBtn.onclick = doReplace;
            replaceAllBtn.onclick = doReplaceAll;

            // ========== FILE OPERATIONS ==========
            async function saveFile() {
                const content = textbox.value;

                try {
                    if (currentFileHandle && supportsFileSystemAccess) {
                        // Save to existing file using File System Access API
                        const writable =
                            await currentFileHandle.createWritable();
                        await writable.write(content);
                        await writable.close();

                        hasUnsavedChanges = false;
                        originalContent = content;
                        updateFileStatus();

                        console.log("File saved successfully");
                        return;
                    }
                } catch (error) {
                    console.error("Error saving file:", error);
                    // Fall back to download method
                }

                // Fallback: traditional download method
                const blob = new Blob([content], { type: "text/plain" });
                const name = filenameBox.value.trim() || "file.txt";
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = name;
                a.click();
                URL.revokeObjectURL(a.href);
            }

            async function openFile() {
                try {
                    if (supportsFileSystemAccess) {
                        // Use File System Access API
                        const [fileHandle] = await window.showOpenFilePicker({
                            types: [
                                {
                                    description: "Text files",
                                    accept: {
                                        "text/plain": [
                                            ".txt",
                                            ".md",
                                            ".js",
                                            ".html",
                                            ".css",
                                            ".json",
                                            ".csv",
                                        ],
                                    },
                                },
                            ],
                        });

                        const file = await fileHandle.getFile();
                        const content = await file.text();

                        textbox.value = content;
                        originalContent = content;
                        currentFileHandle = fileHandle;
                        hasUnsavedChanges = false;

                        filenameBox.value = file.name;
                        filenameDisplay.textContent = file.name;

                        pushHistory(textbox.value);
                        updateStats();
                        updateLineNumbers();
                        updateFileStatus();

                        console.log("File opened successfully");
                        return;
                    }
                } catch (error) {
                    if (error.name !== "AbortError") {
                        console.error("Error opening file:", error);
                    }
                    // Fall back to traditional file input
                }

                // Fallback: use traditional file input
                fileInput.click();
            }

            saveBtn.onclick = saveFile;
            openBtn.onclick = openFile;

            // Traditional file input handler (fallback)
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        textbox.value = ev.target.result;
                        originalContent = ev.target.result;
                        currentFileHandle = null; // Traditional file loading doesn't provide handle
                        hasUnsavedChanges = false;

                        pushHistory(textbox.value);
                        updateStats();
                        updateLineNumbers();
                        updateFileStatus();
                    };
                    reader.readAsText(file);
                    filenameBox.value = file.name;
                    filenameDisplay.textContent = file.name;
                }
                fileInput.value = "";
            };

            // ========== EVENT HANDLERS ==========
            textbox.addEventListener("input", () => {
                pushHistory(textbox.value);
                updateStats();
                updateLineNumbers();
                markAsModified();
                autosave();
            });

            textbox.addEventListener("keyup", updateStats);
            textbox.addEventListener("click", updateStats);
            textbox.addEventListener("keydown", updateStats);
            textbox.addEventListener("mouseup", updateStats);

            textbox.addEventListener("scroll", () => {
                lineNumbers.scrollTop = textbox.scrollTop;
            });

            // Keep filename in sync
            filenameBox.addEventListener("input", () => {
                filenameDisplay.textContent =
                    filenameBox.value || "untitled.txt";
            });

            // Keyboard shortcuts
            document.addEventListener("keydown", (e) => {
                // Standard shortcuts
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === "z") {
                        e.preventDefault();
                        undo();
                    }
                    if (e.key === "y") {
                        e.preventDefault();
                        redo();
                    }
                    if (e.key === "s") {
                        e.preventDefault();
                        saveFile();
                    }
                    if (e.key === "f") {
                        e.preventDefault();
                        showPopup(findPopup);
                    }
                    if (e.key === "o") {
                        e.preventDefault();
                        openFile();
                    }
                }

                // Function key shortcuts
                if (e.key === "F1") {
                    e.preventDefault();
                    showPopup(aboutPopup);
                }
                if (e.key === "F2") {
                    e.preventDefault();
                    showPopup(shortcutsPopup);
                }
                if (e.key === "F3") {
                    e.preventDefault();
                    doFind(true);
                }

                // Close popups with Escape
                if (e.key === "Escape") hidePopups();
            });

            // Warn before closing if there are unsaved changes
            window.addEventListener("beforeunload", (e) => {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue =
                        "You have unsaved changes. Are you sure you want to leave?";
                    return e.returnValue;
                }
            });

            // ========== INITIALIZATION ==========
            // Load autosaved content only if no file is opened
            const saved = localStorage.getItem("editor_" + tabId);
            if (saved && !currentFileHandle) {
                textbox.value = saved;
                originalContent = saved;
                history = [saved];
                historyPtr = 0;
            }

            updateStats();
            updateLineNumbers();
            updateFileStatus();
            pushHistory(textbox.value);

            // Helper: focus filename on load
            filenameBox.addEventListener("keydown", (e) => {
                if (e.key === "Enter") textbox.focus();
            });

            // Make sure stats are updated on document ready
            document.addEventListener("DOMContentLoaded", () => {
                updateStats();
                updateLineNumbers();
                updateFileStatus();
                textbox.focus();
            });

            // Log File System Access API support
            console.log(
                "File System Access API supported:",
                supportsFileSystemAccess,
            );

            // ========== SERVICE WORKER REGISTRATION ==========
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () => {
                    navigator.serviceWorker
                        .register("/sw.js")
                        .then((registration) => {
                            console.log(
                                "ServiceWorker registration successful with scope: ",
                                registration.scope,
                            );
                        })
                        .catch((error) => {
                            console.log(
                                "ServiceWorker registration failed: ",
                                error,
                            );
                        });
                });
            }
        </script>
    </body>
</html>
