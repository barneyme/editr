<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>SNO (Secure Note.)</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
        <style>
            /* Basic Reset and Font */
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Helvetica, Arial, sans-serif;
                background: #ffffff;
                color: #000000;
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 10px;
            }

            /* Main container */
            .container {
                width: 100%;
                max-width: 1200px;
                margin: 0 auto;
            }

            /* Screen styles */
            .login-screen,
            .app-screen {
                background: #ffffff;
                border-radius: 8px;
                padding: 30px;
                border: 1px solid #e0e0e0;
                max-width: 400px;
                margin: 0 auto;
            }

            .app-screen {
                max-width: 1200px;
                display: none;
            }

            .app-screen.active {
                display: block;
            }

            h1 {
                color: #000000;
                margin-bottom: 25px;
                font-size: 1.8em;
                font-weight: 600;
                text-align: center;
            }

            /* Input fields and text areas */
            .input-group {
                margin-bottom: 15px;
                text-align: left;
            }

            label {
                display: block;
                margin-bottom: 5px;
                color: #333;
                font-weight: 500;
                font-size: 14px;
            }

            input[type="password"],
            input[type="text"],
            textarea {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 14px;
                background: #fff;
                color: #000;
            }

            input[type="password"]:focus,
            input[type="text"]:focus,
            textarea:focus {
                outline: none;
                border-color: #000;
            }

            textarea {
                resize: vertical;
                min-height: 300px;
                font-family: inherit;
            }

            /* Buttons */
            .btn {
                background: #000000;
                color: #ffffff;
                border: 1px solid #000000;
                padding: 8px 16px;
                border-radius: 4px;
                font-size: 14px;
                cursor: pointer;
                transition: background 0.2s ease;
                font-weight: 500;
            }

            .btn:hover {
                background: #333;
            }

            .btn-secondary {
                background: #6c757d;
                border-color: #6c757d;
                margin-left: 8px;
            }
            .btn-secondary:hover {
                background: #5a6268;
            }

            .btn-danger {
                background: #c82333;
                border-color: #c82333;
            }
            .btn-danger:hover {
                background: #bd2130;
            }

            /* App Header */
            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                flex-wrap: wrap;
                gap: 15px;
            }
            .header h1 {
                margin-bottom: 0;
                text-align: left;
            }

            .search-box {
                flex: 1;
                min-width: 200px;
            }

            /* Notes Grid */
            .notes-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 15px;
                margin-top: 20px;
            }

            .note-card {
                background: #ffffff;
                border-radius: 6px;
                padding: 15px;
                border: 1px solid #eee;
                transition: border-color 0.2s ease;
                cursor: pointer;
            }

            .note-card:hover {
                border-color: #ccc;
            }

            .note-title {
                font-size: 1.1em;
                font-weight: 600;
                color: #000;
                margin-bottom: 8px;
                word-break: break-word;
            }

            .note-preview {
                color: #555;
                font-size: 0.9em;
                line-height: 1.4;
                margin-bottom: 12px;
                max-height: 80px;
                overflow: hidden;
                word-break: break-word;
            }

            .note-meta {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.75em;
                color: #777;
            }

            .note-actions {
                display: flex;
                gap: 8px;
            }

            .btn-small {
                padding: 5px 10px;
                font-size: 12px;
                border-radius: 4px;
            }

            /* Modal */
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.4);
                z-index: 1000;
            }

            .modal.active {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .modal-content {
                background: white;
                border-radius: 8px;
                padding: 25px;
                max-width: 700px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                border: 1px solid #ccc;
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }
            .modal-header h2 {
                font-size: 1.4em;
            }

            .close-btn {
                background: none;
                border: none;
                font-size: 22px;
                cursor: pointer;
                color: #888;
            }

            /* Utility classes */
            .empty-state {
                text-align: center;
                padding: 50px 20px;
                color: #666;
            }

            .empty-state h3 {
                margin-bottom: 10px;
                color: #888;
            }

            .error-message {
                color: #c82333;
                font-size: 13px;
                margin-top: 5px;
                text-align: left;
            }

            .storage-info {
                font-size: 12px;
                color: #888;
                margin-top: 20px;
                text-align: center;
            }

            @media (max-width: 768px) {
                .header {
                    flex-direction: column;
                    align-items: stretch;
                }
                .header h1 {
                    text-align: center;
                }
                .notes-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div id="loginScreen" class="login-screen">
                <h1>SNO (Secure Note.)</h1>
                <div class="input-group">
                    <label for="masterPassword">Password</label>
                    <input
                        type="password"
                        id="masterPassword"
                        placeholder="Enter your password"
                    />
                    <div id="loginError" class="error-message"></div>
                </div>
                <button class="btn" onclick="login()">Unlock</button>
                <div class="storage-info">
                    Data is encrypted and stored locally in your browser.
                </div>
            </div>

            <div id="appScreen" class="app-screen">
                <div class="header">
                    <h1>SNO (Secure Note.)</h1>
                    <div class="search-box">
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="Search notes..."
                            oninput="searchNotes()"
                        />
                    </div>
                    <div>
                        <button class="btn" onclick="showNewNoteModal()">
                            + New Note
                        </button>
                        <button class="btn btn-secondary" onclick="logout()">
                            Logout
                        </button>
                    </div>
                </div>

                <div id="notesContainer">
                    <div class="empty-state">
                        <h3>No notes yet</h3>
                        <p>Create your first secure note to get started!</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="noteModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">New Note</h2>
                    <button class="close-btn" onclick="closeModal()">
                        &times;
                    </button>
                </div>
                <div class="input-group">
                    <label for="noteTitle">Title</label>
                    <input
                        type="text"
                        id="noteTitle"
                        placeholder="Enter note title"
                    />
                </div>
                <div class="input-group">
                    <label for="noteContent">Content</label>
                    <textarea
                        id="noteContent"
                        placeholder="Write your note content here..."
                    ></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px">
                    <button class="btn btn-secondary" onclick="closeModal()">
                        Cancel
                    </button>
                    <button class="btn" onclick="saveNote()">Save Note</button>
                </div>
            </div>
        </div>

        <script>
            let masterKey = null;
            let notes = [];
            let currentEditingId = null;
            let currentPasswordHash = null;
            // A unique storage key for this specific application
            const STORAGE_KEY = "sno_secure_note_vault";
            const VAULT_VERSION = "1.0";

            // Initialize the app
            function init() {
                if (!isLocalStorageAvailable()) {
                    // Using a custom, non-blocking message instead of alert()
                    showError(
                        "This application requires local storage to function. Please enable it in your browser settings.",
                    );
                    return;
                }
                renderNotes();
            }

            // Function to show a persistent error on the login screen
            function showError(message) {
                const loginScreen = document.getElementById("loginScreen");
                let errorDiv = document.getElementById("criticalError");
                if (!errorDiv) {
                    errorDiv = document.createElement("div");
                    errorDiv.id = "criticalError";
                    errorDiv.style.color = "#c82333";
                    errorDiv.style.marginTop = "15px";
                    errorDiv.style.fontWeight = "bold";
                    loginScreen.appendChild(errorDiv);
                }
                errorDiv.textContent = message;
            }

            // Check if localStorage is available
            function isLocalStorageAvailable() {
                try {
                    const test = "__storage_test__";
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            }

            // Load all user vaults from localStorage
            function loadVaultsFromStorage() {
                try {
                    const stored = localStorage.getItem(STORAGE_KEY);
                    if (stored) {
                        const data = JSON.parse(stored);
                        if (data.version === VAULT_VERSION) {
                            return data.vaults || {};
                        }
                    }
                } catch (e) {
                    console.error("Error loading vaults from storage:", e);
                }
                return {};
            }

            // Save all user vaults to localStorage
            function saveVaultsToStorage(vaults) {
                try {
                    const data = {
                        version: VAULT_VERSION,
                        vaults: vaults,
                        lastUpdated: new Date().toISOString(),
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    return true;
                } catch (e) {
                    console.error("Error saving vaults to storage:", e);
                    if (e.name === "QuotaExceededError") {
                        showError(
                            "Storage quota exceeded. Please delete some notes.",
                        );
                    }
                    return false;
                }
            }

            // Create a hash of the password for identification
            function hashPassword(password) {
                return CryptoJS.SHA256(password + "sno-salt-v1").toString();
            }

            // Login functionality
            function login() {
                const password =
                    document.getElementById("masterPassword").value;
                const errorElement = document.getElementById("loginError");

                if (!password) {
                    errorElement.textContent = "Please enter a password";
                    return;
                }

                masterKey = CryptoJS.PBKDF2(password, "sno-salt-v1", {
                    keySize: 256 / 32,
                    iterations: 10000,
                });
                currentPasswordHash = hashPassword(password);
                const userVaults = loadVaultsFromStorage();

                if (userVaults[currentPasswordHash]) {
                    try {
                        const encryptedNotes = userVaults[currentPasswordHash];
                        const decryptedData = CryptoJS.AES.decrypt(
                            encryptedNotes,
                            masterKey.toString(),
                        ).toString(CryptoJS.enc.Utf8);

                        if (!decryptedData)
                            throw new Error("Decryption failed");

                        notes = JSON.parse(decryptedData);
                    } catch (e) {
                        console.error("Decryption error:", e);
                        errorElement.textContent =
                            "Invalid password - unable to decrypt notes.";
                        return;
                    }
                } else {
                    notes = [];
                }

                errorElement.textContent = "";
                document.getElementById("loginScreen").style.display = "none";
                document.getElementById("appScreen").classList.add("active");
                document.getElementById("masterPassword").value = "";
                renderNotes();
            }

            // Logout functionality
            function logout() {
                saveNotesToStorage();
                masterKey = null;
                notes = [];
                currentEditingId = null;
                currentPasswordHash = null;
                document.getElementById("loginScreen").style.display = "block";
                document.getElementById("appScreen").classList.remove("active");
                document.getElementById("searchInput").value = "";
                renderNotes();
            }

            // Save notes to localStorage
            function saveNotesToStorage() {
                if (!masterKey || !currentPasswordHash) return false;
                try {
                    const userVaults = loadVaultsFromStorage();
                    const notesJson = JSON.stringify(notes);
                    const encryptedNotes = CryptoJS.AES.encrypt(
                        notesJson,
                        masterKey.toString(),
                    ).toString();
                    userVaults[currentPasswordHash] = encryptedNotes;
                    return saveVaultsToStorage(userVaults);
                } catch (e) {
                    console.error("Failed to save notes:", e);
                    return false;
                }
            }

            // Encryption/Decryption functions
            function encrypt(text) {
                if (!masterKey) return text;
                return CryptoJS.AES.encrypt(
                    text,
                    masterKey.toString(),
                ).toString();
            }

            function decrypt(encryptedText) {
                if (!masterKey) return encryptedText;
                try {
                    const bytes = CryptoJS.AES.decrypt(
                        encryptedText,
                        masterKey.toString(),
                    );
                    return (
                        bytes.toString(CryptoJS.enc.Utf8) ||
                        "[Decryption Error]"
                    );
                } catch (e) {
                    return "[Unable to decrypt]";
                }
            }

            // Note management
            function showNewNoteModal() {
                currentEditingId = null;
                document.getElementById("modalTitle").textContent = "New Note";
                document.getElementById("noteTitle").value = "";
                document.getElementById("noteContent").value = "";
                document.getElementById("noteModal").classList.add("active");
                document.getElementById("noteTitle").focus();
            }

            function editNote(id) {
                const note = notes.find((n) => n.id === id);
                if (!note) return;

                currentEditingId = id;
                document.getElementById("modalTitle").textContent = "Edit Note";
                document.getElementById("noteTitle").value = decrypt(
                    note.title,
                );
                document.getElementById("noteContent").value = decrypt(
                    note.content,
                );
                document.getElementById("noteModal").classList.add("active");
                document.getElementById("noteTitle").focus();
            }

            function saveNote() {
                const title = document.getElementById("noteTitle").value.trim();
                const content = document
                    .getElementById("noteContent")
                    .value.trim();

                if (!title) {
                    alert("Please enter a title.");
                    return;
                }

                const now = new Date().toISOString();
                const noteData = {
                    title: encrypt(title),
                    content: encrypt(content),
                    lastModified: now,
                };

                if (currentEditingId) {
                    const noteIndex = notes.findIndex(
                        (n) => n.id === currentEditingId,
                    );
                    if (noteIndex !== -1) {
                        notes[noteIndex] = { ...notes[noteIndex], ...noteData };
                    }
                } else {
                    noteData.id = Date.now().toString();
                    noteData.created = now;
                    notes.unshift(noteData);
                }

                if (!saveNotesToStorage()) {
                    alert("Failed to save note. Storage might be full.");
                    return;
                }
                closeModal();
                renderNotes();
            }

            function deleteNote(id) {
                // Using a custom modal for confirmation would be better, but confirm is simple
                if (
                    window.confirm("Are you sure you want to delete this note?")
                ) {
                    notes = notes.filter((n) => n.id !== id);
                    saveNotesToStorage();
                    renderNotes();
                }
            }

            function closeModal() {
                document.getElementById("noteModal").classList.remove("active");
                currentEditingId = null;
            }

            // Search functionality
            function searchNotes() {
                const query = document
                    .getElementById("searchInput")
                    .value.toLowerCase();
                const filteredNotes = notes.filter((note) => {
                    const title = decrypt(note.title).toLowerCase();
                    const content = decrypt(note.content).toLowerCase();
                    return title.includes(query) || content.includes(query);
                });
                renderNotes(filteredNotes);
            }

            // Render notes to the DOM
            function renderNotes(notesToRender = notes) {
                const container = document.getElementById("notesContainer");
                const searchInput =
                    document.getElementById("searchInput").value;

                if (notesToRender.length === 0) {
                    const isEmptySearch = searchInput.length > 0;
                    container.innerHTML = `
                    <div class="empty-state">
                        <h3>${notes.length === 0 ? "No notes yet" : "No notes found"}</h3>
                        <p>${notes.length === 0 ? "Create your first secure note to get started!" : `Your search for "${escapeHtml(searchInput)}" did not match any notes.`}</p>
                    </div>`;
                    return;
                }

                const notesHTML = notesToRender
                    .map((note) => {
                        const title = decrypt(note.title);
                        const content = decrypt(note.content);
                        const preview =
                            content.length > 100
                                ? content.substring(0, 100) + "..."
                                : content;
                        const date = new Date(
                            note.lastModified,
                        ).toLocaleDateString();

                        return `
                    <div class="note-card" onclick="editNote('${note.id}')">
                        <div class="note-title">${escapeHtml(title)}</div>
                        <div class="note-preview">${escapeHtml(preview)}</div>
                        <div class="note-meta">
                            <span>Modified: ${date}</span>
                            <div class="note-actions" onclick="event.stopPropagation()">
                                <button class="btn btn-small btn-danger" onclick="deleteNote('${note.id}')">Delete</button>
                            </div>
                        </div>
                    </div>`;
                    })
                    .join("");

                container.innerHTML = `<div class="notes-grid">${notesHTML}</div>`;
            }

            // Utility function to escape HTML to prevent XSS
            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            // --- Event Listeners ---
            document
                .getElementById("masterPassword")
                .addEventListener("keypress", (e) => {
                    if (e.key === "Enter") login();
                });

            document
                .getElementById("noteModal")
                .addEventListener("click", (e) => {
                    if (e.target === e.currentTarget) closeModal();
                });

            document.addEventListener("keydown", (e) => {
                if (
                    e.key === "Escape" &&
                    document.querySelector(".modal.active")
                ) {
                    closeModal();
                }
            });

            window.addEventListener("beforeunload", () => {
                if (masterKey && currentPasswordHash) {
                    saveNotesToStorage();
                }
            });

            // Initialize the app on load
            init();
        </script>
    </body>
</html>
