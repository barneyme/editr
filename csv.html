<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>CSV Editor</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            /* Custom styles for a minimalist black and white theme */
            body {
                font-family: "Inter", sans-serif;
                background-color: #ffffff;
                color: #000000;
            }
            .table-container {
                width: 100%;
                overflow: auto;
                max-height: 70vh; /* Limit height to 70% of viewport height */
            }
            table {
                border-collapse: separate;
                border-spacing: 0;
                width: 100%;
            }
            th,
            td {
                border: 1px solid #ccc; /* Simple gray border */
                padding: 0.5rem; /* Slightly smaller padding */
                white-space: nowrap;
                position: relative;
            }
            th {
                background-color: #f5f5f5; /* Light gray for header */
                font-weight: 600;
                position: sticky;
                top: 0;
                z-index: 10;
            }
            td:focus {
                outline: 2px solid #000000; /* Black outline on focus */
                z-index: 5;
            }
            .selected {
                background-color: #e0e0e0; /* Light gray for selected cell */
            }
        </style>
        <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />
    </head>
    <body class="bg-white text-black">
        <div class="container mx-auto p-4 md:p-6 max-w-7xl">
            <header class="mb-6 text-center">
                <h1 class="text-3xl font-bold">CSV Editor</h1>
                <p class="text-gray-600 mt-1">
                    Open, edit, and save CSV files.
                </p>
            </header>

            <!-- Controls Section -->
            <div class="border border-gray-300 p-4 rounded-md mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                    <!-- File Input -->
                    <div>
                        <label
                            for="csvFile"
                            class="block text-sm font-medium mb-1"
                            >Open CSV File</label
                        >
                        <input
                            type="file"
                            id="csvFile"
                            accept=".csv"
                            class="block w-full text-sm file:mr-2 file:py-1 file:px-3 file:rounded-md file:border-1 file:border-gray-400 file:text-sm file:font-semibold file:bg-white file:text-black hover:file:bg-gray-100 cursor-pointer"
                        />
                    </div>

                    <!-- Action Buttons -->
                    <div
                        class="flex flex-wrap gap-2 justify-start md:justify-end items-center"
                    >
                        <button
                            id="addRow"
                            class="action-btn bg-white hover:bg-gray-100 text-black font-semibold py-1 px-3 rounded-md border border-gray-400 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            Add Row
                        </button>
                        <button
                            id="deleteRow"
                            class="action-btn bg-white hover:bg-gray-100 text-black font-semibold py-1 px-3 rounded-md border border-gray-400 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            Delete Row
                        </button>
                        <button
                            id="addColumn"
                            class="action-btn bg-white hover:bg-gray-100 text-black font-semibold py-1 px-3 rounded-md border border-gray-400 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            Add Column
                        </button>
                        <button
                            id="deleteColumn"
                            class="action-btn bg-white hover:bg-gray-100 text-black font-semibold py-1 px-3 rounded-md border border-gray-400 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            Delete Column
                        </button>
                    </div>
                </div>
                <!-- Save Button -->
                <div class="mt-4 text-center">
                    <button
                        id="saveCSV"
                        class="w-full md:w-auto bg-black hover:bg-gray-800 text-white font-bold py-2 px-5 rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        Save Changes
                    </button>
                </div>
            </div>

            <!-- Grid Display Section -->
            <div
                id="grid-container"
                class="border border-gray-300 p-2 rounded-md"
            >
                <div id="message-area" class="text-center p-12 text-gray-500">
                    <p>Please select a CSV file to begin.</p>
                </div>
                <div class="table-container">
                    <table id="csvGrid" class="hidden">
                        <thead id="gridHeader"></thead>
                        <tbody id="gridBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            // DOM element references
            const csvFileInput = document.getElementById("csvFile");
            const gridContainer = document.getElementById("grid-container");
            const csvGrid = document.getElementById("csvGrid");
            const gridHeader = document.getElementById("gridHeader");
            const gridBody = document.getElementById("gridBody");
            const messageArea = document.getElementById("message-area");
            const actionButtons = document.querySelectorAll(".action-btn");
            const saveButton = document.getElementById("saveCSV");
            const addRowBtn = document.getElementById("addRow");
            const deleteRowBtn = document.getElementById("deleteRow");
            const addColumnBtn = document.getElementById("addColumn");
            const deleteColumnBtn = document.getElementById("deleteColumn");

            // Application state
            let gridData = [];
            let headerData = [];
            let activeCell = { row: -1, col: -1 };
            let originalFilename = "edited.csv";

            // --- Event Listeners ---

            csvFileInput.addEventListener("change", handleFileSelect);
            csvGrid.addEventListener("keydown", handleGridNavigation);
            csvGrid.addEventListener("click", handleCellClick);

            addRowBtn.addEventListener("click", addRow);
            deleteRowBtn.addEventListener("click", deleteRow);
            addColumnBtn.addEventListener("click", addColumn);
            deleteColumnBtn.addEventListener("click", deleteColumn);
            saveButton.addEventListener("click", saveCSV);

            /**
             * Handles the file selection event. Reads the CSV file and renders the grid.
             * @param {Event} event - The file input change event.
             */
            function handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                originalFilename = file.name;
                const reader = new FileReader();
                reader.onload = function (e) {
                    const text = e.target.result;
                    parseCSV(text);
                    renderGrid();
                    enableControls();
                };
                reader.readAsText(file);
            }

            /**
             * Parses a CSV string into a 2D array for the grid data.
             * @param {string} text - The raw CSV string content.
             */
            function parseCSV(text) {
                const lines = text.trim().split("\n");
                if (lines.length === 0) {
                    gridData = [];
                    headerData = [];
                    return;
                }
                headerData = lines[0].split(",");
                gridData = lines.slice(1).map((line) => line.split(","));
            }

            /**
             * Renders the entire data grid into the DOM based on the current state.
             */
            function renderGrid() {
                if (headerData.length === 0 && gridData.length === 0) {
                    csvGrid.classList.add("hidden");
                    messageArea.classList.remove("hidden");
                    messageArea.textContent = "The selected CSV file is empty.";
                    return;
                }

                // Clear previous grid content
                gridHeader.innerHTML = "";
                gridBody.innerHTML = "";

                // Create header row
                const headerRow = document.createElement("tr");
                headerData.forEach((headerText) => {
                    const th = document.createElement("th");
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });
                gridHeader.appendChild(headerRow);

                // Create data rows
                gridData.forEach((row, rowIndex) => {
                    const tr = document.createElement("tr");
                    row.forEach((cellText, colIndex) => {
                        const td = document.createElement("td");
                        td.textContent = cellText;
                        td.setAttribute("contenteditable", "true");
                        td.dataset.row = rowIndex;
                        td.dataset.col = colIndex;

                        // Update gridData on cell edit
                        td.addEventListener("blur", (e) => {
                            gridData[rowIndex][colIndex] = e.target.textContent;
                        });

                        tr.appendChild(td);
                    });
                    gridBody.appendChild(tr);
                });

                csvGrid.classList.remove("hidden");
                messageArea.classList.add("hidden");

                // Set initial active cell if grid is not empty
                if (gridData.length > 0 && gridData[0].length > 0) {
                    setActiveCell(0, 0, false);
                }
            }

            /**
             * Handles keyboard navigation within the grid using arrow keys.
             * @param {KeyboardEvent} event - The keydown event.
             */
            function handleGridNavigation(event) {
                if (activeCell.row === -1) return;

                let { row, col } = activeCell;
                const maxRow = gridData.length - 1;
                const maxCol = headerData.length - 1;

                switch (event.key) {
                    case "ArrowUp":
                        row = Math.max(0, row - 1);
                        break;
                    case "ArrowDown":
                        row = Math.min(maxRow, row + 1);
                        break;
                    case "ArrowLeft":
                        col = Math.max(0, col - 1);
                        break;
                    case "ArrowRight":
                        col = Math.min(maxCol, col + 1);
                        break;
                    default:
                        return; // Exit if not an arrow key
                }

                event.preventDefault(); // Prevent default scrolling
                setActiveCell(row, col);
            }

            /**
             * Handles clicks on cells to set the active cell.
             * @param {MouseEvent} event - The click event.
             */
            function handleCellClick(event) {
                const cell = event.target.closest("td");
                if (cell) {
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);
                    setActiveCell(row, col, false); // Don't focus, click already does that
                }
            }

            /**
             * Sets the currently active cell, updates styling, and focuses it.
             * @param {number} row - The row index of the new active cell.
             * @param {number} col - The column index of the new active cell.
             * @param {boolean} shouldFocus - Whether to programmatically focus the cell.
             */
            function setActiveCell(row, col, shouldFocus = true) {
                // Remove selection from the previous cell
                if (activeCell.row !== -1) {
                    const prevCell = gridBody.querySelector(
                        `[data-row='${activeCell.row}'][data-col='${activeCell.col}']`,
                    );
                    if (prevCell) prevCell.classList.remove("selected");
                }

                // Update active cell coordinates
                activeCell = { row, col };

                // Add selection to the new cell
                const newCell = gridBody.querySelector(
                    `[data-row='${row}'][data-col='${col}']`,
                );
                if (newCell) {
                    newCell.classList.add("selected");
                    if (shouldFocus) {
                        newCell.focus();
                    }
                }
            }

            /**
             * Adds a new, empty row to the end of the grid.
             */
            function addRow() {
                const newRow = new Array(headerData.length).fill("");
                gridData.push(newRow);
                renderGrid();
                setActiveCell(gridData.length - 1, 0);
            }

            /**
             * Deletes the row of the currently selected cell.
             */
            function deleteRow() {
                if (activeCell.row === -1 || gridData.length === 0) return;
                gridData.splice(activeCell.row, 1);

                // Adjust active cell if the last row was deleted
                const newActiveRow = Math.min(
                    activeCell.row,
                    gridData.length - 1,
                );

                renderGrid();

                if (gridData.length > 0) {
                    setActiveCell(newActiveRow, activeCell.col);
                } else {
                    activeCell = { row: -1, col: -1 };
                    disableControls();
                    messageArea.textContent = "All rows have been deleted.";
                    messageArea.classList.remove("hidden");
                    csvGrid.classList.add("hidden");
                }
            }

            /**
             * Adds a new, empty column to the end of the grid.
             */
            function addColumn() {
                const newColName = `Column${headerData.length + 1}`;
                headerData.push(newColName);
                gridData.forEach((row) => row.push(""));
                renderGrid();
                setActiveCell(0, headerData.length - 1);
            }

            /**
             * Deletes the column of the currently selected cell.
             */
            function deleteColumn() {
                if (activeCell.col === -1 || headerData.length === 0) return;

                headerData.splice(activeCell.col, 1);
                gridData.forEach((row) => row.splice(activeCell.col, 1));

                const newActiveCol = Math.min(
                    activeCell.col,
                    headerData.length - 1,
                );

                renderGrid();

                if (headerData.length > 0) {
                    setActiveCell(activeCell.row, newActiveCol);
                } else {
                    activeCell = { row: -1, col: -1 };
                    disableControls();
                    messageArea.textContent = "All columns have been deleted.";
                    messageArea.classList.remove("hidden");
                    csvGrid.classList.add("hidden");
                }
            }

            /**
             * Converts the grid data back to a CSV string and triggers a download.
             */
            function saveCSV() {
                const headerString = headerData.join(",");
                const rowsString = gridData
                    .map((row) => row.join(","))
                    .join("\n");
                const csvContent = `${headerString}\n${rowsString}`;

                const blob = new Blob([csvContent], {
                    type: "text/csv;charset=utf-8;",
                });
                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", originalFilename);
                    link.style.visibility = "hidden";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }

            /**
             * Enables all action buttons after a file is loaded.
             */
            function enableControls() {
                actionButtons.forEach((btn) => (btn.disabled = false));
                saveButton.disabled = false;
            }

            /**
             * Disables all action buttons.
             */
            function disableControls() {
                actionButtons.forEach((btn) => (btn.disabled = true));
                saveButton.disabled = true;
            }
        </script>
    </body>
</html>
